<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Uacuum Phone">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2a2a2a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="app-icon.png">
    <link rel="icon" type="image/png" href="app-icon.png">
    
    <title>contacts - Uacuum</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100dvh;
            background: #2a2a2a;
            overflow: hidden;
            overscroll-behavior: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .phone-container {
            width: 98vw; 
            max-width: 520px;
            height: 100%;
            max-height: 95dvh;
            background: #1a1a1a;
            border: 6px solid #000;
            border-radius: 20px;
            box-shadow: 
                0 0 0 3px #444,
                0 15px 30px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            padding: 15px;
            position: relative;
            transition: background 0.3s ease;
        }

        /* 顶部导航 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #444;
            flex-shrink: 0;
        }

        .back-button {
            background: #fff;
            border: 3px solid #000;
            padding: 10px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            text-decoration: none;
            color: #000;
        }

        .header-title {
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        /* 右侧按钮组容器 */
        .header-actions {
            display: flex;
            gap: 8px;
        }

        .action-button {
            border: 3px solid #000;
            padding: 10px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            color: #000;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-add { background: #4ecdc4; }
        .btn-user { background: #ffe66d; } /* U 按钮黄色 */

        .back-button:active, .action-button:active {
            transform: translate(3px, 3px);
            box-shadow: 0 0 0 #000;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 2px;
            position: relative;
            -webkit-overflow-scrolling: touch; 
        }

        .content::-webkit-scrollbar { width: 6px; }
        .content::-webkit-scrollbar-track { background: transparent; }
        .content::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* --- 列表视图 --- */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
        }

        .contact-item {
            background: #fff;
            border: 3px solid #000;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 3px 3px 0 #000;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .contact-item:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #000;
        }

        .contact-avatar-small {
            width: 40px;
            height: 40px;
            border: 2px solid #000;
            background: #ddd;
            object-fit: cover;
            flex-shrink: 0;
            image-rendering: pixelated;
        }

        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-size: 10px; margin-bottom: 6px; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-desc { font-size: 7px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- 编辑器视图 (通用) --- */
        .editor-view {
            display: none;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 20px;
        }

        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #fff;
            border: 3px solid #000;
            box-shadow: 3px 3px 0 #000;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border: 3px solid #000;
            background: #eee;
            object-fit: cover;
            image-rendering: pixelated;
        }

        .avatar-buttons { display: flex; gap: 10px; margin-top: 5px; }
        .mini-btn { font-size: 8px; padding: 8px; background: #eee; border: 2px solid #000; cursor: pointer; font-family: inherit; }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .label { font-size: 8px; color: #fff; text-shadow: 1px 1px 0 #000; }
        
        .input-block {
            background: #fff;
            border: 3px solid #000;
            padding: 12px;
            box-shadow: 3px 3px 0 #000;
        }

        .input-text {
            width: 100%;
            border: none;
            border-bottom: 2px solid #000;
            font-family: inherit;
            font-size: 10px;
            padding: 8px 0;
            outline: none;
            background: transparent;
            border-radius: 0;
        }

        .input-text:focus { border-bottom-color: #4ecdc4; }

        .input-area {
            width: 100%;
            border: 2px solid #000;
            font-family: inherit;
            font-size: 9px;
            padding: 10px;
            outline: none;
            resize: none;
            min-height: 120px;
            line-height: 1.5;
            margin-top: 5px;
            background: #f9f9f9;
        }

        .input-area:focus { box-shadow: inset 0 0 0 2px #4ecdc4; }

        .char-count { text-align: right; font-size: 6px; color: #666; margin-top: 4px; }

        .action-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; padding-bottom: 10px; }
        .btn-large {
            padding: 14px;
            font-family: inherit;
            font-size: 9px;
            border: 3px solid #000;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            text-transform: uppercase;
            font-weight: bold;
        }
        .btn-large:active { transform: translate(3px, 3px); box-shadow: 0 0 0 #000; }
        .btn-save { background: #4ecdc4; color: #000; }
        .btn-delete { background: #ff6b6b; color: #fff; }

        .empty-tip {
            text-align: center;
            color: #fff;
            font-size: 9px;
            margin-top: 60px;
            opacity: 0.6;
            line-height: 1.8;
            text-shadow: 1px 1px 0 #000;
        }

        .color-scheme-1 { background: #ff6b9d; }
        .color-scheme-2 { background: #4ecdc4; }
        .color-scheme-3 { background: #ffe66d; }
        .color-scheme-4 { background: #a8e6cf; }
        .color-scheme-5 { background: #ffd3b6; }
        .color-scheme-6 { background: #c7ceea; }
    </style>
</head>
<body>
    <div class="phone-container" id="phoneContainer">
        <!-- 头部导航 -->
        <div class="header">
            <button class="back-button" id="mainBackBtn">← 返回</button>
            <div class="header-title" id="pageTitle">通讯录</div>
            
            <!-- 右侧按钮组 -->
            <div class="header-actions" id="headerActions">
                <button class="action-button btn-user" id="userBtn">U</button>
                <button class="action-button btn-add" id="addBtn">+</button>
            </div>
        </div>

        <div class="content">
            
            <!-- 1. 列表视图 -->
            <div id="listView" class="contact-list">
                <!-- JS 填充 -->
                <div class="empty-tip">暂无联络人<br>点击右上角 + 添加</div>
            </div>

            <!-- 2. 用户设定视图 (新增) -->
            <div id="userView" class="editor-view">
                <div class="form-group">
                    <label class="label">User 介绍</label>
                    <div class="input-block">
                        <textarea id="userPersonaContent" class="input-area" maxlength="2000" style="height: 300px;" placeholder="在此输入 User 的介绍、外貌、设定..."></textarea>
                        <div class="char-count"><span id="userPersonaCount">0</span>/2000</div>
                    </div>
                </div>
                <button class="btn-large btn-save" id="saveUserBtn" style="width: 100%;">保存设定</button>
            </div>

            <!-- 3. 角色编辑视图 -->
            <div id="editorView" class="editor-view">
                <input type="hidden" id="editId">

                <!-- 头像区域 -->
                <div class="avatar-section">
                    <img src="" id="avatarPreview" class="avatar-preview" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>'">
                    <div class="avatar-buttons">
                        <button class="mini-btn" id="uploadLocalBtn">本地上传</button>
                        <button class="mini-btn" id="uploadUrlBtn">URL链接</button>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>

                <!-- 基础信息 -->
                <div class="input-block">
                    <div class="form-group">
                        <label class="label" style="color:#000">角色名 (Name)</label>
                        <input type="text" id="contactName" class="input-text" placeholder="AI 识别用的名字 (例如: Miku)">
                    </div>
                    <div class="form-group" style="margin-top:10px;">
                        <label class="label" style="color:#000">昵称 (Nickname)</label>
                        <input type="text" id="contactNick" class="input-text" placeholder="聊天显示的名称 (例如: 初音)">
                    </div>
                </div>

                <!-- 人设区域 -->
                <div class="form-group">
                    <label class="label">人设 (Persona)</label>
                    <div class="input-block">
                        <textarea id="personaContent" class="input-area" maxlength="5000" placeholder="在此输入详细的角色性格、背景故事、语气特点..."></textarea>
                        <div class="char-count"><span id="personaCount">0</span>/5000</div>
                    </div>
                </div>

                <!-- 备注区域 -->
                <div class="form-group">
                    <label class="label">备注/世界书 (Note)</label>
                    <div class="input-block">
                        <textarea id="noteContent" class="input-area" maxlength="10000" placeholder="在此输入世界观、强制指令、Scenario..."></textarea>
                        <div class="char-count"><span id="noteCount">0</span>/10000</div>
                    </div>
                </div>

                <button class="btn-large" id="smsBtn" style="background:#fff; margin-top:10px; display:none;">✉ 发送短信</button>

                <!-- 操作按钮 -->
                <div class="action-bar">
                    <button class="btn-large btn-delete" id="deleteBtn">删除</button>
                    <button class="btn-large btn-save" id="saveBtn">保存</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 变量初始化 ---
        const phoneContainer = document.getElementById('phoneContainer');
        const colorSchemes = ['color-scheme-1', 'color-scheme-2', 'color-scheme-3', 'color-scheme-4', 'color-scheme-5', 'color-scheme-6'];

        // 视图容器
        const listView = document.getElementById('listView');
        const editorView = document.getElementById('editorView');
        const userView = document.getElementById('userView');
        
        // 头部元素
        const mainBackBtn = document.getElementById('mainBackBtn');
        const headerActions = document.getElementById('headerActions');
        const addBtn = document.getElementById('addBtn');
        const userBtn = document.getElementById('userBtn');
        const pageTitle = document.getElementById('pageTitle');
        const smsBtn = document.getElementById('smsBtn');

        // 编辑器表单元素
        const editIdInput = document.getElementById('editId');
        const avatarPreview = document.getElementById('avatarPreview');
        const contactName = document.getElementById('contactName');
        const contactNick = document.getElementById('contactNick');
        const personaContent = document.getElementById('personaContent');
        const noteContent = document.getElementById('noteContent');
        const personaCount = document.getElementById('personaCount');
        const noteCount = document.getElementById('noteCount');
        const deleteBtn = document.getElementById('deleteBtn');

        // User 表单元素
        const userPersonaContent = document.getElementById('userPersonaContent');
        const userPersonaCount = document.getElementById('userPersonaCount');
        const saveUserBtn = document.getElementById('saveUserBtn');

        // --- 1. 页面加载 ---
        window.addEventListener('DOMContentLoaded', () => {
            const savedColor = localStorage.getItem('phoneColor');
            if (savedColor !== null) {
                phoneContainer.className = 'phone-container ' + colorSchemes[parseInt(savedColor)];
            }
            renderContactList();
        });

        // --- 2. 视图切换逻辑 ---
        
        // 显示列表 (主页)
        function showList() {
            listView.style.display = 'flex';
            editorView.style.display = 'none';
            userView.style.display = 'none';
            
            headerActions.style.visibility = 'visible'; // 显示按钮组
            pageTitle.textContent = '通讯录';
            mainBackBtn.textContent = '← 返回';
            mainBackBtn.onclick = () => window.location.href = './index.html';
        }

        // 显示 User 设定 (新增功能)
        function showUserView() {
            listView.style.display = 'none';
            editorView.style.display = 'none';
            userView.style.display = 'flex';

            headerActions.style.visibility = 'hidden'; // 隐藏按钮组
            pageTitle.textContent = 'User 设定';
            mainBackBtn.textContent = '← 取消';
            mainBackBtn.onclick = showList;

            // 加载数据
            const savedUserPersona = localStorage.getItem('user_persona') || '';
            userPersonaContent.value = savedUserPersona;
            userPersonaCount.textContent = savedUserPersona.length;
        }

        // 显示角色编辑/新增
        function showEditor(contactId = null) {
            listView.style.display = 'none';
            userView.style.display = 'none';
            editorView.style.display = 'flex';
            
            headerActions.style.visibility = 'hidden'; // 隐藏按钮组
            mainBackBtn.textContent = '← 取消';
            mainBackBtn.onclick = showList;
            
            document.querySelector('.content').scrollTop = 0;

            if (contactId) {
                pageTitle.textContent = '编辑联络人';
                deleteBtn.style.display = 'block';
                smsBtn.style.display = 'block';
                smsBtn.onclick = () => {
                    localStorage.setItem('currentChatId', contactId);
                    window.location.href = './sms.html';
                };

                const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
                const contact = contacts.find(c => c.id === contactId);
                
                if (contact) {
                    editIdInput.value = contact.id;
                    contactName.value = contact.name;
                    contactNick.value = contact.nick;
                    personaContent.value = contact.persona;
                    noteContent.value = contact.note;
                    avatarPreview.src = contact.avatar || 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';
                }
            } else {
                pageTitle.textContent = '新增联络人';
                deleteBtn.style.display = 'none';
                smsBtn.style.display = 'none'; 
                editIdInput.value = '';
                contactName.value = '';
                contactNick.value = '';
                personaContent.value = '';
                noteContent.value = '';
                avatarPreview.src = 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';
            }
            updateCounts();
        }

        // --- 3. 按钮绑定 ---
        
        userBtn.addEventListener('click', showUserView);
        addBtn.addEventListener('click', () => showEditor(null));
        mainBackBtn.onclick = () => window.location.href = './index.html';

        // --- 4. 存储逻辑 ---

        // User 保存
        saveUserBtn.addEventListener('click', () => {
            const content = userPersonaContent.value;
            localStorage.setItem('user_persona', content);
            alert('User 设定保存成功！');
            showList();
        });

        // 角色保存
        document.getElementById('saveBtn').addEventListener('click', () => {
            const name = contactName.value.trim();
            if (!name) {
                alert('请至少填写角色名');
                return;
            }

            const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            const id = editIdInput.value;
            
            const newContact = {
                id: id || Date.now().toString(), 
                name: name,
                nick: contactNick.value.trim() || name,
                persona: personaContent.value,
                note: noteContent.value,
                avatar: avatarPreview.src,
                lastUpdated: Date.now()
            };

            if (id) {
                const index = contacts.findIndex(c => c.id === id);
                if (index !== -1) contacts[index] = newContact;
            } else {
                contacts.push(newContact);
            }

            try {
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContactList();
                showList();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('存储空间已满！请使用URL链接图片，或删除旧的联络人。');
                } else {
                    alert('保存失败。');
                }
            }
        });

        // 角色删除
        deleteBtn.addEventListener('click', () => {
            if (confirm('确定要删除这个角色吗？')) {
                const id = editIdInput.value;
                let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
                contacts = contacts.filter(c => c.id !== id);
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContactList();
                showList();
            }
        });

        // --- 5. 渲染列表 ---
        function renderContactList() {
            const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            listView.innerHTML = '';

            if (contacts.length === 0) {
                listView.innerHTML = '<div class="empty-tip">暂无联络人<br>点击右上角 + 添加</div>';
                return;
            }

            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.onclick = () => showEditor(contact.id);
                
                const avatarSrc = contact.avatar || 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';

                item.innerHTML = `
                    <img src="${avatarSrc}" class="contact-avatar-small">
                    <div class="contact-info">
                        <div class="contact-name">${escapeHtml(contact.nick || contact.name)}</div>
                        <div class="contact-desc">${escapeHtml(contact.name)}</div>
                    </div>
                `;
                listView.appendChild(item);
            });
        }

        // --- 6. 图片上传 ---
        const fileInput = document.getElementById('fileInput');

        document.getElementById('uploadLocalBtn').addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 1024 * 1024) alert('图片过大，建议使用 < 1MB 的图片');
                const reader = new FileReader();
                reader.onload = (e) => avatarPreview.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('uploadUrlBtn').addEventListener('click', () => {
            const url = prompt('请输入图片 URL:');
            if (url) avatarPreview.src = url;
        });

        // --- 7. 计数器 ---
        function updateCounts() {
            personaCount.textContent = personaContent.value.length;
            noteCount.textContent = noteContent.value.length;
        }
        personaContent.addEventListener('input', updateCounts);
        noteContent.addEventListener('input', updateCounts);

        userPersonaContent.addEventListener('input', () => {
            userPersonaCount.textContent = userPersonaContent.value.length;
        });

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
