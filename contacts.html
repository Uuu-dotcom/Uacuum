<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>contacts - Uacuum</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            background: #2a2a2a;
            overflow: hidden;
        }

        /* 手机容器 */
        .phone-container {
            width: 110vmin;
            max-width: 450px;
            height: calc(100dvh - 24px);
            max-height: 900px;
            background: #1a1a1a;
            border: 6px solid #000;
            border-radius: 20px;
            box-shadow: 
                0 0 0 3px #444,
                0 15px 30px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            padding: 15px;
            position: relative;
            transition: background 0.3s ease;
        }

        /* 顶部导航 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #444;
            flex-shrink: 0;
        }

        .back-button {
            background: #fff;
            border: 3px solid #000;
            padding: 8px 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            text-decoration: none;
            color: #000;
        }

        .header-title {
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .add-button {
            background: #4ecdc4;
            border: 3px solid #000;
            padding: 8px 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            color: #000;
        }

        .back-button:active, .add-button:active {
            transform: translate(3px, 3px);
            box-shadow: 0 0 0 #000;
        }

        /* 内容滚动区 */
        .content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            position: relative;
        }

        /* 滚动条 */
        .content::-webkit-scrollbar { width: 8px; }
        .content::-webkit-scrollbar-track { background: #000; border: 2px solid #444; }
        .content::-webkit-scrollbar-thumb { background: #fff; border: 2px solid #000; }

        /* --- 列表视图样式 --- */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-item {
            background: #fff;
            border: 3px solid #000;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 3px 3px 0 #000;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .contact-item:hover {
            transform: translate(-1px, -1px);
        }

        .contact-avatar-small {
            width: 40px;
            height: 40px;
            border: 2px solid #000;
            background: #ddd;
            object-fit: cover;
            flex-shrink: 0;
            image-rendering: pixelated;
        }

        .contact-info {
            flex: 1;
            overflow: hidden;
        }

        .contact-name {
            font-size: 9px;
            margin-bottom: 4px;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-desc {
            font-size: 6px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- 编辑器视图样式 --- */
        .editor-view {
            display: none; /* 默认隐藏 */
            flex-direction: column;
            gap: 15px;
        }

        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #fff;
            border: 3px solid #000;
            box-shadow: 3px 3px 0 #000;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border: 3px solid #000;
            background: #eee;
            object-fit: cover;
            image-rendering: pixelated;
        }

        .avatar-buttons {
            display: flex;
            gap: 5px;
        }

        .mini-btn {
            font-size: 6px;
            padding: 5px;
            background: #eee;
            border: 2px solid #000;
            cursor: pointer;
            font-family: inherit;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .label {
            font-size: 8px;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
        }
        
        /* 亮色背景块 */
        .input-block {
            background: #fff;
            border: 3px solid #000;
            padding: 10px;
            box-shadow: 3px 3px 0 #000;
        }

        .input-text {
            width: 100%;
            border: none;
            border-bottom: 2px solid #000;
            font-family: inherit;
            font-size: 8px;
            padding: 5px 0;
            outline: none;
            background: transparent;
        }

        .input-text:focus {
            border-bottom-color: #4ecdc4;
        }

        .input-area {
            width: 100%;
            border: 2px solid #000;
            font-family: inherit;
            font-size: 7px;
            padding: 8px;
            outline: none;
            resize: vertical;
            min-height: 100px;
            line-height: 1.4;
            margin-top: 5px;
        }

        .input-area:focus {
            box-shadow: inset 0 0 0 2px #4ecdc4;
        }

        .char-count {
            text-align: right;
            font-size: 5px;
            color: #666;
            margin-top: 2px;
        }

        .action-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding-bottom: 20px;
        }

        .btn-large {
            padding: 12px;
            font-family: inherit;
            font-size: 8px;
            border: 3px solid #000;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            text-transform: uppercase;
        }

        .btn-large:active {
            transform: translate(3px, 3px);
            box-shadow: 0 0 0 #000;
        }

        .btn-save { background: #4ecdc4; color: #000; }
        .btn-delete { background: #ff6b6b; color: #fff; }

        .empty-tip {
            text-align: center;
            color: #fff;
            font-size: 8px;
            margin-top: 50px;
            opacity: 0.6;
            line-height: 1.5;
        }

        /* 颜色方案 (适配主页) */
        .color-scheme-1 { background: #ff6b9d; }
        .color-scheme-2 { background: #4ecdc4; }
        .color-scheme-3 { background: #ffe66d; }
        .color-scheme-4 { background: #a8e6cf; }
        .color-scheme-5 { background: #ffd3b6; }
        .color-scheme-6 { background: #c7ceea; }
    </style>
</head>
<body>
    <div class="phone-container" id="phoneContainer">
        <!-- 头部导航 -->
        <div class="header">
            <!-- 返回按钮：在列表页返回首页，在编辑页返回列表 -->
            <button class="back-button" id="mainBackBtn">← 返回</button>
            <div class="header-title" id="pageTitle">通讯录</div>
            <button class="add-button" id="addBtn">+</button>
        </div>

        <!-- 这里的 Content 会在列表和编辑界面之间切换 -->
        <div class="content">
            
            <!-- 1. 列表视图 -->
            <div id="listView" class="contact-list">
                <!-- 由 JS 填充 -->
                <div class="empty-tip">暂无联络人<br>点击右上角 + 添加</div>
            </div>

            <!-- 2. 编辑视图 -->
            <div id="editorView" class="editor-view">
                <input type="hidden" id="editId">

                <!-- 头像区域 -->
                <div class="avatar-section">
                    <img src="./default-avatar.png" id="avatarPreview" class="avatar-preview" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>'">
                    <div class="avatar-buttons">
                        <button class="mini-btn" id="uploadLocalBtn">本地上传</button>
                        <button class="mini-btn" id="uploadUrlBtn">URL链接</button>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>

                <!-- 基础信息 -->
                <div class="input-block">
                    <div class="form-group">
                        <label class="label" style="color:#000">角色名 (Name)</label>
                        <input type="text" id="contactName" class="input-text" placeholder="AI 识别用的名字 (例如: Miku)">
                    </div>
                    <div class="form-group" style="margin-top:10px;">
                        <label class="label" style="color:#000">昵称 (Nickname)</label>
                        <input type="text" id="contactNick" class="input-text" placeholder="聊天显示的名称 (例如: 初音)">
                    </div>
                </div>

                <!-- 人设区域 -->
                <div class="form-group">
                    <label class="label">人设 (Persona)</label>
                    <div class="input-block">
                        <textarea id="personaContent" class="input-area" maxlength="5000" placeholder="在此输入详细的角色性格、背景故事、语气特点..."></textarea>
                        <div class="char-count"><span id="personaCount">0</span>/5000</div>
                    </div>
                </div>

                <!-- 备注区域 -->
                <div class="form-group">
                    <label class="label">备注/世界书 (Note)</label>
                    <div class="input-block">
                        <textarea id="noteContent" class="input-area" maxlength="10000" placeholder="在此输入世界观、强制指令、Scenario..."></textarea>
                        <div class="char-count"><span id="noteCount">0</span>/10000</div>
                    </div>
                </div>

                <!-- 新增：发送短信按钮 -->
                <button class="btn-large" id="smsBtn" style="background:#fff; margin-top:10px; display:none;">✉ 发送短信</button>

                <!-- 操作按钮 -->
                <div class="action-bar">
                    <button class="btn-large btn-delete" id="deleteBtn">删除</button>
                    <button class="btn-large btn-save" id="saveBtn">保存</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 变量初始化 ---
        const phoneContainer = document.getElementById('phoneContainer');
        const colorSchemes = ['color-scheme-1', 'color-scheme-2', 'color-scheme-3', 'color-scheme-4', 'color-scheme-5', 'color-scheme-6'];

        // 视图元素
        const listView = document.getElementById('listView');
        const editorView = document.getElementById('editorView');
        const mainBackBtn = document.getElementById('mainBackBtn');
        const addBtn = document.getElementById('addBtn');
        const pageTitle = document.getElementById('pageTitle');
        const smsBtn = document.getElementById('smsBtn'); // 新增

        // 表单元素
        const editIdInput = document.getElementById('editId');
        const avatarPreview = document.getElementById('avatarPreview');
        const contactName = document.getElementById('contactName');
        const contactNick = document.getElementById('contactNick');
        const personaContent = document.getElementById('personaContent');
        const noteContent = document.getElementById('noteContent');
        const personaCount = document.getElementById('personaCount');
        const noteCount = document.getElementById('noteCount');
        const deleteBtn = document.getElementById('deleteBtn');

        // --- 1. 页面加载与初始化 ---
        window.addEventListener('DOMContentLoaded', () => {
            // 恢复手机颜色
            const savedColor = localStorage.getItem('phoneColor');
            if (savedColor !== null) {
                phoneContainer.className = 'phone-container ' + colorSchemes[parseInt(savedColor)];
            }
            // 加载列表
            renderContactList();
        });

        // --- 2. 视图切换逻辑 ---
        function showList() {
            listView.style.display = 'flex';
            editorView.style.display = 'none';
            addBtn.style.visibility = 'visible'; // 显示添加按钮
            pageTitle.textContent = '通讯录';
            mainBackBtn.textContent = '← 返回';
            mainBackBtn.onclick = () => window.location.href = './index.html';
        }

        function showEditor(contactId = null) {
            listView.style.display = 'none';
            editorView.style.display = 'flex';
            addBtn.style.visibility = 'hidden'; // 隐藏添加按钮
            mainBackBtn.textContent = '← 取消';
            mainBackBtn.onclick = showList;

            // 重置/填充表单
            if (contactId) {
                // 编辑模式
                pageTitle.textContent = '编辑联络人';
                deleteBtn.style.display = 'block';
                
                // 显示短信按钮并绑定跳转
                smsBtn.style.display = 'block';
                smsBtn.onclick = () => {
                    localStorage.setItem('currentChatId', contactId);
                    window.location.href = './sms.html';
                };

                const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
                const contact = contacts.find(c => c.id === contactId);
                
                if (contact) {
                    editIdInput.value = contact.id;
                    contactName.value = contact.name;
                    contactNick.value = contact.nick;
                    personaContent.value = contact.persona;
                    noteContent.value = contact.note;
                    avatarPreview.src = contact.avatar || 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';
                }
            } else {
                // 新增模式
                pageTitle.textContent = '新增联络人';
                deleteBtn.style.display = 'none';
                smsBtn.style.display = 'none'; // 新增时不能发短信

                editIdInput.value = '';
                contactName.value = '';
                contactNick.value = '';
                personaContent.value = '';
                noteContent.value = '';
                avatarPreview.src = 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';
            }
            // 更新计数器
            updateCounts();
        }

        // --- 3. 核心功能：渲染列表 ---
        function renderContactList() {
            const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            listView.innerHTML = '';

            if (contacts.length === 0) {
                listView.innerHTML = '<div class="empty-tip">暂无联络人<br>点击右上角 + 添加</div>';
                return;
            }

            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.onclick = () => showEditor(contact.id);
                
                // 默认头像
                const avatarSrc = contact.avatar || 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';

                item.innerHTML = `
                    <img src="${avatarSrc}" class="contact-avatar-small">
                    <div class="contact-info">
                        <div class="contact-name">${escapeHtml(contact.nick || contact.name)}</div>
                        <div class="contact-desc">${escapeHtml(contact.name)}</div>
                    </div>
                `;
                listView.appendChild(item);
            });
        }

        // --- 4. 保存与删除逻辑 ---
        document.getElementById('saveBtn').addEventListener('click', () => {
            const name = contactName.value.trim();
            if (!name) {
                alert('请至少填写角色名');
                return;
            }

            const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            const id = editIdInput.value;
            
            const newContact = {
                id: id || Date.now().toString(), // 如果没有ID则生成新ID
                name: name,
                nick: contactNick.value.trim() || name,
                persona: personaContent.value,
                note: noteContent.value,
                avatar: avatarPreview.src,
                lastUpdated: Date.now()
            };

            if (id) {
                // 更新现有
                const index = contacts.findIndex(c => c.id === id);
                if (index !== -1) contacts[index] = newContact;
            } else {
                // 新增
                contacts.push(newContact);
            }

            try {
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContactList();
                showList();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('存储空间已满！可能是图片太大，请尝试使用URL联结或压缩图片。');
                } else {
                    alert('保存失败。');
                }
            }
        });

        // 删除功能
        deleteBtn.addEventListener('click', () => {
            if (confirm('确定要删除这个角色吗？此操作无法撤销。')) {
                const id = editIdInput.value;
                let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
                contacts = contacts.filter(c => c.id !== id);
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContactList();
                showList();
            }
        });

        // 添加按钮
        addBtn.addEventListener('click', () => showEditor(null));
        // 初始绑定主返回按钮逻辑
        mainBackBtn.onclick = () => window.location.href = './index.html';

        // --- 5. 头像上传逻辑 ---
        const fileInput = document.getElementById('fileInput');

        document.getElementById('uploadLocalBtn').addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // 限制图片大小 (建议 < 1MB 以免撑爆 localStorage)
                if (file.size > 1024 * 1024) {
                    alert('警告：图片过大可能导致无法保存，建议使用小于 1MB 的图片。');
                }
                const reader = new FileReader();
                reader.onload = (e) => avatarPreview.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('uploadUrlBtn').addEventListener('click', () => {
            const url = prompt('请输入图片 URL:');
            if (url) {
                avatarPreview.src = url;
            }
        });

        // --- 6. 辅助功能 ---
        // 字符计数
        function updateCounts() {
            personaCount.textContent = personaContent.value.length;
            noteCount.textContent = noteContent.value.length;
        }
        personaContent.addEventListener('input', updateCounts);
        noteContent.addEventListener('input', updateCounts);

        // HTML 转义防止 XSS
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
