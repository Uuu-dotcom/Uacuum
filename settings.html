<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>系统设定</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; width: 100vw; height: 100dvh;
            background: url('https://files.catbox.moe/q1t6rm.jpg') no-repeat center center;
            background-size: cover;
            font-family: "Microsoft YaHei", sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 0;
        }

        .settings-container {
            position: relative;
            z-index: 1;
            width: 90%;
            max-width: 450px;
            height: 85vh;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title { font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        
        .close-btn {
            background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 10px;
            transition: color 0.2s;
        }
        .close-btn:hover { color: #add8e6; }

        .content-body { padding: 20px; overflow-y: auto; flex-grow: 1; }

        .section {
            background: rgba(0, 0, 0, 0.2); border-radius: 12px;
            padding: 15px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .section-title { font-size: 14px; color: rgba(255, 255, 255, 0.8); margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }

        label { display: block; font-size: 12px; margin-bottom: 5px; margin-top: 10px; color: #d1e8ff; }
        input, select {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white; font-size: 14px; margin-bottom: 5px;
            user-select: auto; 
        }
        input:focus, select:focus { background: rgba(255, 255, 255, 0.2); border-color: #fff; }
        option { background-color: #333; color: white; }

        .model-row { display: flex; gap: 10px; }
        .refresh-btn {
            background: rgba(173, 216, 230, 0.6);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; color: white; width: 44px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; flex-shrink: 0; margin-bottom: 5px;
            transition: background 0.3s;
        }
        .refresh-btn:hover { background: rgba(173, 216, 230, 0.8); }
        .refresh-btn:active { transform: scale(0.95); }
        /* 旋转动画 */
        .fa-spin { animation: fa-spin 1s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 5px; }
        .action-btn {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255, 255, 255, 0.15);
            color: white; font-size: 14px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: background 0.2s;
        }
        .action-btn:active { background: rgba(255, 255, 255, 0.3); }

        .content-body::-webkit-scrollbar { width: 4px; }
        .content-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }

    </style>
</head>
<body>

    <div class="overlay"></div>

    <div class="settings-container">
        <div class="header">
            <div class="title">
                <i class="fa-solid fa-sliders"></i> 系统设定
            </div>
            <button class="close-btn" onclick="window.location.href='./index.html'">&times;</button>
        </div>
        
        <div class="content-body">
            <!-- API 配置区块 -->
            <div class="section">
                <div class="section-title">API 连接设置</div>
                
                <label for="preset-select">我的预设</label>
                <select id="preset-select">
                    <option value="openai">官方 OpenAI</option>
                    <option value="custom">自定义 / 中转站</option>
                    <option value="ollama">本地 (Ollama)</option>
                </select>

                <label for="api-url">API 地址 (URL)</label>
                <!-- 这里的 id="api-url" 必须要有 -->
                <input type="text" id="api-url" placeholder="例如: https://api.openai.com/v1" autocomplete="off">

                <label for="api-key">API 密钥 (Key)</label>
                <!-- 这里的 id="api-key" 必须要有 -->
                <input type="password" id="api-key" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">

                <label for="model-select">模型选择 (Model)</label>
                <div class="model-row">
                    <select id="model-select">
                        <option value="" disabled selected>请先刷新模型列表</option>
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo (默认)</option>
                    </select>
                    <button class="refresh-btn" id="refresh-btn" title="刷新模型列表">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>

            <!-- 备份区块 -->
            <div class="section">
                <div class="section-title">数据备份与迁移</div>
                <div class="btn-group">
                    <button class="action-btn" onclick="exportData()">
                        <i class="fa-solid fa-file-export"></i> 导出全部数据
                    </button>
                    <button class="action-btn" onclick="importData()">
                        <i class="fa-solid fa-file-import"></i> 导入全部数据
                    </button>
                </div>
            </div>

            <div style="height: 20px;"></div>
        </div>
    </div>

    <!-- === 核心逻辑代码 === -->
    <script>
        // 1. 获取页面元素
        const apiUrlInput = document.getElementById('api-url');
        const apiKeyInput = document.getElementById('api-key');
        const modelSelect = document.getElementById('model-select');
        const refreshBtn = document.getElementById('refresh-btn');
        const presetSelect = document.getElementById('preset-select');

        // 2. 页面加载时：读取本地存储的数据 (Read from LocalStorage)
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('gcli_api_url');
            const savedKey = localStorage.getItem('gcli_api_key');
            const savedModel = localStorage.getItem('gcli_model');
            
            if (savedUrl) apiUrlInput.value = savedUrl;
            if (savedKey) apiKeyInput.value = savedKey;
            
            // 如果有保存的模型，尝试添加到下拉框并选中
            if (savedModel) {
                // 检查下拉框里有没有这个模型，没有就加一个临时的
                let exists = false;
                for (let i = 0; i < modelSelect.options.length; i++) {
                    if (modelSelect.options[i].value === savedModel) exists = true;
                }
                if (!exists) {
                    const option = document.createElement('option');
                    option.value = savedModel;
                    option.text = savedModel;
                    modelSelect.add(option);
                }
                modelSelect.value = savedModel;
            }
        });

        // 3. 输入时：自动保存数据 (Auto Save)
        apiUrlInput.addEventListener('input', () => {
            localStorage.setItem('gcli_api_url', apiUrlInput.value.trim());
        });

        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem('gcli_api_key', apiKeyInput.value.trim());
        });

        modelSelect.addEventListener('change', () => {
            localStorage.setItem('gcli_model', modelSelect.value);
        });

        // 预设切换逻辑 (辅助功能)
        presetSelect.addEventListener('change', (e) => {
            if(e.target.value === 'openai') {
                apiUrlInput.value = 'https://api.openai.com/v1';
                localStorage.setItem('gcli_api_url', 'https://api.openai.com/v1');
            } else if (e.target.value === 'ollama') {
                apiUrlInput.value = 'http://localhost:11434/v1';
                localStorage.setItem('gcli_api_url', 'http://localhost:11434/v1');
            }
        });

        // 4. 点击刷新按钮：连接 API (Fetch Models)
        refreshBtn.addEventListener('click', async () => {
            // UI 反馈：让图标转起来
            const icon = refreshBtn.querySelector('i');
            icon.classList.add('fa-spin');
            
            const apiUrl = apiUrlInput.value.trim().replace(/\/$/, ''); // 去掉末尾的斜杠
            const apiKey = apiKeyInput.value.trim();

            if (!apiUrl) {
                alert('请先填写 API 地址！');
                icon.classList.remove('fa-spin');
                return;
            }

            try {
                // 发送请求给 /models 端点
                // 注意：这里假设对方 API 兼容 OpenAI 格式
                const response = await fetch(`${apiUrl}/models`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errText = await response.text(); // 尝试读取错误信息
                    throw new Error(`状态码 ${response.status} - ${errText}`);
                }

                const data = await response.json();
                
                // 清空旧选项
                modelSelect.innerHTML = '';

                // 填充新模型 (假设返回结构是 { data: [{id: "gpt-4"}, ...] })
                if (data.data && Array.isArray(data.data)) {
                    data.data.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.text = model.id;
                        modelSelect.appendChild(option);
                    });
                    
                    // 默认选中第一个
                    if (modelSelect.options.length > 0) {
                        modelSelect.selectedIndex = 0;
                        localStorage.setItem('gcli_model', modelSelect.value);
                    }
                    
                    alert(`成功刷新！共找到 ${data.data.length} 个模型。`);
                } else {
                    alert('连接成功，但返回数据格式无法识别。');
                    console.log(data); // 在控制台打印数据以便调试
                }

            } catch (error) {
                console.error(error);
                alert('连接失败：\n' + error.message + '\n\n提示：请检查URL是否正确，或者该API是否支持跨域(CORS)访问。');
            } finally {
                // 停止旋转
                icon.classList.remove('fa-spin');
            }
        });

        // 5. 简单的导出导入功能 (JSON 格式)
        function exportData() {
            const data = {
                url: localStorage.getItem('gcli_api_url'),
                key: localStorage.getItem('gcli_api_key'),
                model: localStorage.getItem('gcli_model')
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'settings_backup.json';
            a.click();
        }

        function importData() {
            alert("请手动填入即可，此功能暂未开启文件上传逻辑。");
        }

    </script>
</body>
</html>
