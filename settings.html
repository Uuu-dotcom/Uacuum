<!-- è¿™æ˜¯åŒ…å«å®Œæ•´CSSå’Œä¿®å¤åJSçš„æœ€ç»ˆç‰ˆæœ¬ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Uacuum Phone">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2a2a2a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="app-icon.png">
    <link rel="icon" type="image/png" href="app-icon.png">
    
    <title>Settings - UacuumMobile</title>
    <link rel="stylesheet" href="base.css">

    <style>   
        /* é¡¶éƒ¨å¯¼èˆª */
        .header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #444; flex-shrink: 0; }
        .back-button { background: #fff; border: 3px solid #000; padding: 8px 12px; font-family: 'Press Start 2P', cursive; font-size: 8px; cursor: pointer; box-shadow: 3px 3px 0 #000; transition: all 0.1s; text-decoration: none; color: #000; display: inline-block; }
        .back-button:hover { transform: translate(1.5px, 1.5px); box-shadow: 1.5px 1.5px 0 #000; }
        .back-button:active { transform: translate(3px, 3px); box-shadow: 0 0 0 #000; }
        .title { font-size: 12px; color: #fff; flex: 1; text-align: center; text-shadow: 2px 2px 0 #000; }
        .content { flex: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .content::-webkit-scrollbar { width: 8px; }
        .content::-webkit-scrollbar-track { background: #000; border: 2px solid #444; }
        .content::-webkit-scrollbar-thumb { background: #fff; border: 2px solid #000; }
        .settings-section { background: #fff; border: 3px solid #000; padding: 12px; margin-bottom: 15px; box-shadow: 4px 4px 0 #000; }
        .section-title { font-size: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #000; color: #000; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 8px; margin-bottom: 6px; color: #000; font-weight: bold; }
        .form-input { width: 100%; border: 3px solid #000; padding: 8px; font-family: 'Press Start 2P', cursive; font-size: 10px; background: #eee; line-height: 1.4; -webkit-user-select: text; user-select: text; box-sizing: border-box; }
        .form-input:focus { outline: none; background: #fff; box-shadow: inset 0 0 0 2px #4ecdc4; }
        .button-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .btn { background: #fff; border: 3px solid #000; padding: 10px; font-family: 'Press Start 2P', cursive; font-size: 8px; cursor: pointer; box-shadow: 3px 3px 0 #000; transition: all 0.1s; flex: 1; min-width: 80px; text-align: center; }
        .btn:hover { transform: translate(1.5px, 1.5px); box-shadow: 1.5px 1.5px 0 #000; }
        .btn:active { transform: translate(3px, 3px); box-shadow: 0 0 0 #000; }
        .btn.primary { background: #4ecdc4; color: #000; }
        .btn.success { background: #a8e6cf; color: #000; }
        .btn.warning { background: #ffe66d; color: #000; }
        .btn.danger { background: #ff6b6b; color: #fff; }
        .btn:disabled { background: #ccc; color: #666; cursor: not-allowed; }
        .btn-full { width: 100%; margin-top: 8px; }
        .slider-container { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
        .slider { flex: 1; height: 20px; -webkit-appearance: none; background: #eee; border: 3px solid #000; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #000; cursor: pointer; border: 2px solid #fff; box-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
        .slider-value { font-size: 8px; color: #000; padding: 6px; background: #ffe66d; border: 3px solid #000; min-width: 45px; text-align: center; }
        .model-select { width: 100%; border: 3px solid #000; padding: 8px; font-family: 'Press Start 2P', cursive; font-size: 9px; background: #eee; box-sizing: border-box; }
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .toggle { position: relative; width: 50px; height: 24px; background: #ccc; border: 3px solid #000; cursor: pointer; transition: background 0.2s; }
        .toggle.active { background: #a8e6cf; }
        .toggle-thumb { position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: #000; transition: left 0.2s; }
        .toggle.active .toggle-thumb { left: 28px; }
        .status-text { font-size: 7px; color: #666; }
        .info-text { font-size: 6px; color: #666; margin-top: 6px; line-height: 1.4; }
        .color-scheme-1 { background: #ff6b9d; } .color-scheme-2 { background: #4ecdc4; } .color-scheme-3 { background: #ffe66d; } .color-scheme-4 { background: #a8e6cf; } .color-scheme-5 { background: #ffd3b6; } .color-scheme-6 { background: #c7ceea; }
    </style>
</head>
<body>
    <div class="phone-container" id="phoneContainer">
        <div class="header">
            <a href="./index.html" class="back-button">â† è¿”å›</a>
            <div class="title">è®¾ç½®</div>
        </div>

        <div class="content">
            <div class="settings-section">
                <div class="section-title">API è¿æ¥</div>
                <div class="form-group">
                    <label class="form-label">API URL (Base URL)</label>
                    <input type="text" id="apiUrl" class="form-input" placeholder="ä¾‹å¦‚: https://api.openai.com/v1">
                    <div class="info-text">ä¸è¦å¸¦ /chat/completions</div>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                    <select id="modelSelect" class="model-select">
                        <option value="">è¯·å…ˆå¡«å†™APIå¹¶åˆ·æ–°</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn primary" id="refreshModels">åˆ·æ–°æ¨¡å‹</button>
                    <button class="btn success" id="saveApi">ä¿å­˜é…ç½®</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-title">å¯¹è¯å‚æ•°</div>
                <div class="form-group">
                    <label class="form-label">éšæœºæ€§ (Temperature)</label>
                    <div class="slider-container">
                        <input type="range" id="temperature" class="slider" min="0" max="20" value="9" step="1">
                        <div class="slider-value" id="tempValue">0.9</div>
                    </div>
                    <div class="info-text">ä½=ç²¾ç¡®/ä¸¥è°¨ï¼Œé«˜=åˆ›æ„/éšæœº</div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä¸Šä¸‹æ–‡é•¿åº¦ (Context Length)</label>
                    <div class="slider-container">
                        <input type="range" id="contextLength" class="slider" min="10" max="100" value="30" step="1">
                        <div class="slider-value" id="contextLengthValue">30</div>
                    </div>
                    <div class="info-text">AIèƒ½çœ‹åˆ°æœ€è¿‘çš„Næ¡æ¶ˆæ¯ã€‚æ•°å€¼è¶Šå¤§è®°æ€§è¶Šå¥½ï¼Œä½†æ¶ˆè€—ä¹Ÿè¶Šå¤šã€‚</div>
                </div>
                
                <button class="btn success btn-full" id="saveParams">ä¿å­˜å‚æ•°</button>
            </div>

            <div class="settings-section">
                <div class="section-title">æ¶ˆæ¯é€šçŸ¥</div>
                <div class="form-group">
                    <label class="form-label">ç³»ç»Ÿæ¨é€</label>
                    <div class="toggle-container">
                        <div class="toggle" id="notificationToggle">
                            <div class="toggle-thumb"></div>
                        </div>
                        <span class="status-text" id="notificationStatus">å·²å…³é—­</span>
                    </div>
                    <div class="info-text">å…è®¸ AI ä¸»åŠ¨å‘ä½ å‘é€æ¶ˆæ¯æ—¶å¼¹çª—é€šçŸ¥</div>
                </div>
                <button class="btn warning btn-full" id="testNotification">å‘é€æµ‹è¯•é€šçŸ¥</button>
            </div>

            <div class="settings-section">
                <div class="section-title">æ•°æ®å¤‡ä»½</div>
                <div class="button-group">
                    <button class="btn success" id="exportData">å¯¼å‡ºæ•°æ®</button>
                    <button class="btn primary" id="importData">å¯¼å…¥æ•°æ®</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;">
                <div class="info-text" style="margin-top: 10px; border-top: 2px dashed #ccc; padding-top: 5px;">
                    å±é™©æ“ä½œåŒº
                </div>
                <button class="btn danger btn-full" id="clearData">æ¸…é™¤æ‰€æœ‰æ•°æ® (é‡ç½®)</button>
            </div>
        </div>
    </div>

    <script>
        const phoneContainer = document.getElementById('phoneContainer');
        const apiUrlInput = document.getElementById('apiUrl');
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('modelSelect');
        const tempSlider = document.getElementById('temperature');
        const tempValueDisplay = document.getElementById('tempValue');
        const notifToggle = document.getElementById('notificationToggle');
        const notifStatus = document.getElementById('notificationStatus');
        const contextSlider = document.getElementById('contextLength');
        const contextValueDisplay = document.getElementById('contextLengthValue');
        const colorSchemes = ['color-scheme-1', 'color-scheme-2', 'color-scheme-3', 'color-scheme-4', 'color-scheme-5', 'color-scheme-6'];

        window.addEventListener('DOMContentLoaded', () => { loadAllSettings(); });

        function loadAllSettings() {
            const savedColor = localStorage.getItem('phoneColor');
            if (savedColor !== null) { phoneContainer.className = 'phone-container ' + colorSchemes[parseInt(savedColor)]; }
            apiUrlInput.value = localStorage.getItem('apiUrl') || '';
            apiKeyInput.value = localStorage.getItem('apiKey') || '';
            const savedModels = localStorage.getItem('modelList');
            const savedSelectedModel = localStorage.getItem('selectedModel');
            if (savedModels) { try { const models = JSON.parse(savedModels); updateModelSelectUI(models, savedSelectedModel); } catch (e) { console.error('æ¨¡å‹åˆ—è¡¨è§£æå¤±è´¥', e); } }
            const savedTemp = localStorage.getItem('temperature') || '9';
            tempSlider.value = savedTemp;
            tempValueDisplay.textContent = (parseInt(savedTemp) / 10).toFixed(1);
            const savedContext = localStorage.getItem('contextLength') || '30';
            contextSlider.value = savedContext;
            contextValueDisplay.textContent = savedContext;
            const notifEnabled = localStorage.getItem('notificationEnabled') === 'true';
            if (notifEnabled) { notifToggle.classList.add('active'); notifStatus.textContent = 'å·²å¼€å¯'; }
        }

        tempSlider.addEventListener('input', (e) => { tempValueDisplay.textContent = (parseInt(e.target.value) / 10).toFixed(1); });
        contextSlider.addEventListener('input', (e) => { contextValueDisplay.textContent = e.target.value; });

        document.getElementById('saveParams').addEventListener('click', () => {
            localStorage.setItem('temperature', tempSlider.value);
            localStorage.setItem('contextLength', contextSlider.value);
            alert('å‚æ•°å·²ä¿å­˜ï¼');
        });
        
        function updateModelSelectUI(models, selected = '') {
            modelSelect.innerHTML = '';
            if (!models || models.length === 0) { modelSelect.innerHTML = '<option value="">æš‚æ— æ¨¡å‹</option>'; return; }
            models.forEach(modelId => {
                const opt = document.createElement('option');
                opt.value = modelId;
                opt.textContent = modelId;
                if (modelId === selected) opt.selected = true;
                modelSelect.appendChild(opt);
            });
        }
        
        document.getElementById('refreshModels').addEventListener('click', async () => {
            const url = apiUrlInput.value.trim();
            const key = apiKeyInput.value.trim();
            if (!url || !key) {
                alert('è¯·å…ˆå¡«å†™å®Œæ•´çš„ API URL å’Œ API Key');
                return;
            }

            const btn = document.getElementById('refreshModels');
            btn.disabled = true;
            btn.textContent = 'è¿æ¥ä¸­...';

            try {
                const baseUrl = url.replace(/\/$/, '');
                const requestUrl = `${baseUrl}/models`;

                const res = await fetch(requestUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    }
                });

                if (!res.ok) {
                    let errorMsg = `HTTP é”™è¯¯: ${res.status} ${res.statusText}`;
                    try {
                        const errorData = await res.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg = errorData.error.message;
                        }
                    } catch (e) {
                        // ignore json parsing error if response is not json
                    }
                    throw new Error(errorMsg);
                }
                
                const data = await res.json();
                const list = data.data || data; 

                if (Array.isArray(list) && list.every(item => typeof item.id === 'string')) {
                    const models = list.map(m => m.id).sort();
                    localStorage.setItem('modelList', JSON.stringify(models));
                    updateModelSelectUI(models, modelSelect.value);
                    alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`);
                } else {
                    throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•æ‰¾åˆ°æ¨¡å‹åˆ—è¡¨ã€‚');
                }

            } catch (err) {
                // Improved error alert
                if (err.message.includes('not valid JSON') || err instanceof TypeError) {
                     alert(`è·å–å¤±è´¥ï¼šæ”¶åˆ°äº†ä¸€ä¸ªç½‘é¡µè€Œä¸æ˜¯APIæ•°æ®ï¼Œæˆ–ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚\n\nè¯·ç¡®è®¤ï¼š\n1. API URL æ˜¯å¦æ­£ç¡® (é€šå¸¸ä»¥ /v1 ç»“å°¾)ï¼Ÿ\n2. ç½‘ç»œæ˜¯å¦èƒ½æ­£å¸¸è®¿é—®è¯¥åœ°å€ï¼Ÿ`);
                } else {
                     alert(`è·å–å¤±è´¥ï¼š\n${err.message}\n\nè¯·æ£€æŸ¥API URLã€API Keyå’Œç½‘ç»œè¿æ¥ã€‚`);
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'åˆ·æ–°æ¨¡å‹';
            }
        });
        
        document.getElementById('saveApi').addEventListener('click', () => {
            localStorage.setItem('apiUrl', apiUrlInput.value.trim());
            localStorage.setItem('apiKey', apiKeyInput.value.trim());
            localStorage.setItem('selectedModel', modelSelect.value);
            alert('API é…ç½®å·²ä¿å­˜');
        });

        notifToggle.addEventListener('click', async () => { const isActive = notifToggle.classList.contains('active'); if (!isActive) { if (!('Notification' in window)) { alert('æ­¤æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½'); return; } const permission = await Notification.requestPermission(); if (permission === 'granted') { notifToggle.classList.add('active'); notifStatus.textContent = 'å·²å¼€å¯'; localStorage.setItem('notificationEnabled', 'true'); } else { alert('é€šçŸ¥æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸'); } } else { notifToggle.classList.remove('active'); notifStatus.textContent = 'å·²å…³é—­'; localStorage.setItem('notificationEnabled', 'false'); } });
        document.getElementById('testNotification').addEventListener('click', () => { if (localStorage.getItem('notificationEnabled') !== 'true') { alert('è¯·å…ˆå¼€å¯ä¸Šæ–¹å¼€å…³'); return; } new Notification('åƒç´ æ‰‹æœºé€šçŸ¥æµ‹è¯•', { body: 'å¦‚æœä½ çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜é€šçŸ¥åŠŸèƒ½æ­£å¸¸ï¼ğŸ“±', icon: 'app-icon.png' }); });
        document.getElementById('exportData').addEventListener('click', () => { const allData = {}; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); allData[key] = localStorage.getItem(key); } const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `pixel-phone-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); });
        document.getElementById('importData').addEventListener('click', () => { document.getElementById('importFile').click(); });
        document.getElementById('importFile').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (confirm('è¿™å°†è¦†ç›–å½“å‰çš„è®¾ç½®å’Œè®°å½•ï¼Œç¡®å®šå—ï¼Ÿ')) { Object.keys(importedData).forEach(key => { localStorage.setItem(key, importedData[key]); }); alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°...'); location.reload(); } } catch (err) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼å¿…é¡»æ˜¯ json æ–‡ä»¶'); } }; reader.readAsText(file); });
        document.getElementById('clearData').addEventListener('click', () => { if (confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ã€è”ç³»äººå’Œè®¾ç½®ï¼\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) { localStorage.clear(); alert('æ‰‹æœºå·²é‡ç½®ä¸ºå‡ºå‚è®¾ç½®ã€‚'); location.href = './index.html'; } });
    </script>
</body>
</html>
