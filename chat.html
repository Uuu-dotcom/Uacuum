<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === å…¨å±€ä¸å¤œé—´æ¨¡å¼åŸºç¡€ === */
        :root {
            --bg-color: #121212;
            --header-bg: rgba(30, 30, 30, 0.85);
            --bubble-user: #3a7bd5;
            --bubble-ai: #2c2c2c;
            --text-color: #e0e0e0;
            --accent-color: #00d2ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; width: 100%; height: 100dvh;
            background-color: var(--bg-color);
            background-size: cover; background-position: center;
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* === é¡¶éƒ¨å¯¼èˆªæ  === */
        .chat-header {
            height: 60px; padding: 0 15px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--header-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: absolute; top: 0; width: 100%; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 15px; font-size: 18px; cursor: pointer; }
        .header-title { font-weight: bold; font-size: 16px; display: flex; flex-direction: column; }
        .status-dot { width: 8px; height: 8px; background-color: #4cd964; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-text { font-size: 10px; color: #888; font-weight: normal; margin-top: 2px; }
        .header-btn { font-size: 20px; color: var(--text-color); cursor: pointer; padding: 10px; }

        /* === èŠå¤©å†…å®¹åŒº === */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 70px 15px 80px 15px;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
        }
        
        /* æ¶ˆæ¯æ°”æ³¡ */
        .message-row { display: flex; width: 100%; margin-bottom: 5px; opacity: 0; animation: popIn 0.3s forwards; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        
        .bubble {
            max-width: 75%; padding: 10px 14px; border-radius: 18px;
            font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative;
        }
        .user .bubble { background-color: var(--bubble-user); color: white; border-bottom-right-radius: 4px; }
        .ai .bubble { background-color: var(--bubble-ai); color: #e0e0e0; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        
        /* è¡¨æƒ…åŒ…å›¾ç‰‡æ ·å¼ */
        .sticker-img { max-width: 120px; border-radius: 10px; display: block; }

        /* æ­£åœ¨è¾“å…¥åŠ¨ç”» */
        .typing-indicator {
            padding: 10px 14px; background-color: var(--bubble-ai); border-radius: 18px;
            display: none; align-items: center; gap: 4px; width: fit-content; margin-bottom: 10px;
        }
        .dot { width: 6px; height: 6px; background-color: #888; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === åº•éƒ¨è¾“å…¥åŒº === */
        .input-area {
            position: absolute; bottom: 0; width: 100%;
            background-color: var(--header-bg); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px; z-index: 100;
            display: flex; flex-direction: column;
        }
        .input-row { display: flex; align-items: flex-end; gap: 10px; }
        
        #chat-input {
            flex: 1; background: #2c2c2c; border: none; border-radius: 20px;
            padding: 12px 15px; color: white; font-size: 15px; max-height: 100px;
            resize: none; overflow-y: auto;
        }
        
        .icon-btn {
            width: 40px; height: 40px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: var(--accent-color); cursor: pointer; flex-shrink: 0;
            border-radius: 50%; transition: background 0.2s;
        }
        .icon-btn:active { background: rgba(255,255,255,0.1); }
        .send-btn { color: #4cd964; font-size: 22px; }

        /* === è¡¨æƒ…é¢æ¿ === */
        .emoji-panel {
            height: 0; overflow: hidden; transition: height 0.3s;
            background: #1e1e1e;
        }
        .emoji-panel.open { height: 200px; padding-top: 10px; overflow-y: auto; }
        .emoji-grid { display: flex; flex-wrap: wrap; padding: 5px; gap: 10px; }
        .emoji-item { font-size: 24px; padding: 5px; cursor: pointer; }
        .sticker-item { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .add-sticker-btn {
            width: 60px; height: 60px; border: 2px dashed #444; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; color: #444; font-size: 24px;
        }

        /* === èœå•å¼¹çª— (å³ä¸Šè§’) === */
        .dropdown-menu {
            position: absolute; top: 60px; right: 10px;
            background: rgba(40, 40, 40, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; flex-direction: column; overflow: hidden; z-index: 200;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .dropdown-menu.show { display: flex; animation: fadeIn 0.2s; }
        .menu-item {
            padding: 15px; color: white; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: rgba(255,255,255,0.1); }
        .menu-toggle { margin-left: auto; }

        /* === å…¨å±æ¨¡æ€æ¡† (é€šç”¨ï¼šå¤§è„‘/è®°å¿†/è®¾ç½®) === */
        .fullscreen-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 300;
            display: none; flex-direction: column;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; font-size: 18px; font-weight: bold; background: #1e1e1e; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* è®°å¿†å¡ç‰‡æ ·å¼ */
        .memory-card { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 3px solid var(--accent-color); }
        .memory-date { font-size: 12px; color: #888; margin-bottom: 5px; }
        .memory-text { font-size: 14px; line-height: 1.5; color: #ddd; }

        /* ä¸Šä¸‹æ–‡/æ·»åŠ å›¾ç‰‡ å¼¹çª—è¾“å…¥ */
        .simple-input-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #222; padding: 20px; border-radius: 15px; width: 80%; z-index: 400;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); display: none; text-align: center; border: 1px solid #444;
        }
        .simple-input-modal input { width: 100%; padding: 10px; margin: 15px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 8px 20px; border-radius: 5px; border: none; cursor: pointer; }
        .btn-confirm { background: var(--accent-color); color: black; }
        .btn-cancel { background: #444; color: white; }

        /* é•¿æŒ‰èœå• */
        .context-menu {
            position: fixed; background: #222; border-radius: 8px; z-index: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: none; border: 1px solid #444;
        }
        .context-item { padding: 10px 20px; color: white; font-size: 14px; cursor: pointer; border-bottom: 1px solid #333; }
        .context-item:last-child { border-bottom: none; }

    </style>
</head>
<body>

    <!-- é¡¶éƒ¨ -->
    <div class="chat-header">
        <div class="header-left" onclick="window.location.href='./index.html'">
            <i class="fa-solid fa-chevron-left"></i>
            <div class="header-title">
                <span id="chat-partner-name">My AI</span>
                <span class="status-text"><span class="status-dot"></span>åœ¨çº¿</span>
            </div>
        </div>
        <div class="header-btn" onclick="toggleMenu()">
            <i class="fa-solid fa-ellipsis-vertical"></i>
        </div>
    </div>

    <!-- å³ä¸Šè§’ä¸‹æ‹‰èœå• -->
    <div class="dropdown-menu" id="main-menu">
        <div class="menu-item" onclick="promptBackground()">
            <i class="fa-solid fa-image"></i> èŠå¤©èƒŒæ™¯
        </div>
        <div class="menu-item">
            <i class="fa-solid fa-clock"></i> ä¸»åŠ¨å›å¤
            <div class="menu-toggle">
                <i class="fa-solid fa-toggle-off" id="auto-reply-toggle" style="font-size: 20px;" onclick="toggleAutoReply(event)"></i>
            </div>
        </div>
        <div class="menu-item" onclick="triggerMemoryNote()">
            <i class="fa-solid fa-pen-nib"></i> è®°å¿†ç¬”è®°
        </div>
        <div class="menu-item" onclick="openBrain()">
            <i class="fa-solid fa-brain"></i> å¤§è„‘
        </div>
        <div class="menu-item" onclick="openSettings()">
            <i class="fa-solid fa-sliders"></i> èŠå¤©è®¾ç½®
        </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-area" id="chat-area">
        <!-- ç¤ºä¾‹æ¶ˆæ¯ -->
        <div class="message-row ai">
            <div class="bubble">æˆ‘åœ¨ç­‰ä½ å‘¢ï¼Œä»Šæ™šæƒ³èŠç‚¹ä»€ä¹ˆï¼Ÿ</div>
        </div>
        
        <!-- æ­£åœ¨è¾“å…¥æç¤º -->
        <div class="typing-indicator" id="typing-indicator">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <!-- åº•éƒ¨è¾“å…¥æ  -->
    <div class="input-area">
        <div class="input-row">
            <div class="icon-btn" onclick="toggleEmojiPanel()"><i class="fa-regular fa-face-smile"></i></div>
            <textarea id="chat-input" rows="1" placeholder="å‘æ¶ˆæ¯..."></textarea>
            <div class="icon-btn" onclick="triggerAiResponse()"><i class="fa-solid fa-microphone"></i></div>
            <div class="icon-btn send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
        
        <!-- è¡¨æƒ…/è´´å›¾é¢æ¿ -->
        <div class="emoji-panel" id="emoji-panel">
            <div class="emoji-grid" id="sticker-container">
                <!-- æ·»åŠ æŒ‰é’® -->
                <div class="add-sticker-btn" onclick="promptAddSticker()">+</div>
                <!-- é¢„è®¾è¡¨æƒ… -->
                <div class="emoji-item" onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</div>
                <div class="emoji-item" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</div>
                <div class="emoji-item" onclick="insertEmoji('ğŸ¥º')">ğŸ¥º</div>
                <div class="emoji-item" onclick="insertEmoji('â¤ï¸')">â¤ï¸</div>
            </div>
        </div>
    </div>

    <!-- === æ¨¡æ€æ¡†ï¼šå¤§è„‘ (Brain) === -->
    <div class="fullscreen-modal" id="brain-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal('brain-modal')"></i>
            å¤§è„‘æ ¸å¿ƒè®°å¿†
            <div style="margin-left:auto; font-size:14px; color:var(--accent-color);" onclick="batchSummarize()">æ‰¹é‡æ€»ç»“</div>
        </div>
        <div class="modal-content" id="brain-content">
            <!-- è®°å¿†å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- === æ¨¡æ€æ¡†ï¼šè®¾ç½® (Settings) === -->
    <div class="fullscreen-modal" id="settings-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal('settings-modal')"></i>
            èŠå¤©è®¾ç½®
        </div>
        <div class="modal-content">
            <div class="section" style="padding:20px;">
                <label style="display:block; margin-bottom:15px; color:white;">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•° (<span id="context-val">20</span>)</label>
                <input type="range" min="20" max="500" value="20" style="width:100%;" oninput="updateContextVal(this.value)">
                <p style="color:#666; font-size:12px; margin-top:10px;">å¢åŠ è®°å¿†æ¡æ•°ä¼šæ¶ˆè€—æ›´å¤š API Tokenã€‚</p>
            </div>
        </div>
    </div>

    <!-- === é€šç”¨è¾“å…¥å¼¹çª— (æ·»åŠ å›¾ç‰‡/èƒŒæ™¯) === -->
    <div class="simple-input-modal" id="input-prompt">
        <h3 id="prompt-title" style="color:white; margin:0;">è¯·è¾“å…¥ URL</h3>
        <input type="text" id="prompt-input">
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closePrompt()">å–æ¶ˆ</button>
            <button class="modal-btn btn-confirm" id="prompt-confirm">ç¡®å®š</button>
        </div>
    </div>

    <!-- === é•¿æŒ‰èœå• === -->
    <div class="context-menu" id="context-menu">
        <div class="context-item" onclick="contextAction('edit')">ç¼–è¾‘å†…å®¹</div>
        <div class="context-item" onclick="contextAction('regen')">åˆ·æ–°å›å¤</div>
        <div class="context-item" style="color:#ff4444;" onclick="contextAction('delete')">åˆ é™¤è¿™æ¡</div>
    </div>

    <script>
        // === 1. åˆå§‹åŒ–ä¸åŸºç¡€é€»è¾‘ ===
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®èŠå¤©å¯¹è±¡åç§° (æ¨¡æ‹Ÿä»é€šè®¯å½•è¯»å–)
            const partnerName = localStorage.getItem('current_chat_partner') || "My AI";
            document.getElementById('chat-partner-name').innerText = partnerName;
            
            // æ¢å¤èƒŒæ™¯
            const bg = localStorage.getItem('chat_bg');
            if(bg) document.body.style.backgroundImage = `url('${bg}')`;

            // æ¸²æŸ“è´´å›¾
            renderStickers();
        });

        // åˆ‡æ¢ä¸‹æ‹‰èœå•
        function toggleMenu() {
            const menu = document.getElementById('main-menu');
            menu.classList.toggle('show');
        }
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header-btn') && !e.target.closest('.dropdown-menu')) {
                document.getElementById('main-menu').classList.remove('show');
            }
            if (!e.target.closest('.context-menu')) {
                document.getElementById('context-menu').style.display = 'none';
            }
        });

        // === 2. æ¶ˆæ¯å‘é€ä¸ AI æ¨¡æ‹Ÿ ===
        const chatArea = document.getElementById('chat-area');
        const chatInput = document.getElementById('chat-input');
        const typingIndicator = document.getElementById('typing-indicator');

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            addMessage('user', text);
            chatInput.value = '';
            chatInput.focus(); // ä¿æŒé”®ç›˜æ‰“å¼€
            
            // ä¿æŒæ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }

        // æ·»åŠ æ¶ˆæ¯æ°”æ³¡åˆ°ç•Œé¢
        function addMessage(role, content, isSticker = false) {
            const row = document.createElement('div');
            row.className = `message-row ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            if (isSticker) {
                bubble.style.background = 'transparent';
                bubble.style.padding = '0';
                bubble.innerHTML = `<img src="${content}" class="sticker-img">`;
            } else {
                bubble.innerText = content;
            }

            // ç»‘å®šé•¿æŒ‰äº‹ä»¶
            if (role === 'ai') {
                bindLongPress(bubble);
            }

            row.appendChild(bubble);
            // æ’å…¥åˆ°æ­£åœ¨è¾“å…¥æç¤ºä¹‹å‰
            chatArea.insertBefore(row, typingIndicator);
            scrollToBottom();
            return row;
        }

        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // æ¨¡æ‹Ÿç‚¹å‡»éº¦å…‹é£ -> AI å¼€å§‹å›å¤
        function triggerAiResponse() {
            // æ¨¡æ‹Ÿ AI "æ€è€ƒ" å’Œ "æ‰“å­—"
            typingIndicator.style.display = 'flex';
            scrollToBottom();

            // æ¨¡æ‹Ÿå»¶è¿Ÿ
            setTimeout(() => {
                const responseText = "å¥½å‘€ï¼Œæˆ‘åˆšçœ‹åˆ°ä½ çš„æ¶ˆæ¯ã€‚ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰æ²¡æœ‰æƒ³æˆ‘ï¼Ÿ"; 
                processAiResponse(responseText);
            }, 1500);
        }

        // å¤„ç† AI å›å¤ (æ‹†åˆ†çŸ­ä¿¡ + ä¸ç”¨å¥å·)
        function processAiResponse(fullText) {
            typingIndicator.style.display = 'none';
            
            // ç®€å•æ¨¡æ‹Ÿæ‹†åˆ†é€»è¾‘ï¼šæŒ‰æ ‡ç‚¹æ‹†åˆ†ï¼Œæˆ–è€…éšæœºé•¿åº¦
            // å®é™…å¯¹æ¥ API æ—¶ï¼Œè¿™é‡Œä¼šè§£æ API è¿”å›çš„æµå¼æ•°æ®
            const parts = fullText.split(/[ï¼Œã€‚ï¼Ÿ]/).filter(p => p.trim() !== "");
            
            let delay = 0;
            parts.forEach((part, index) => {
                // æ¨¡æ‹Ÿæ¯æ¡çŸ­ä¿¡çš„é—´éš”
                setTimeout(() => {
                    // åªæœ‰æœ€åä¸€å¥å¯èƒ½å¸¦é—®å·ï¼Œå…¶ä»–å»æ‰æ ‡ç‚¹
                    let cleanText = part; 
                    addMessage('ai', cleanText);
                }, delay);
                delay += (part.length * 100) + 500; // æ ¹æ®å­—æ•°è®¡ç®—æ‰“å­—æ—¶é—´
            });
        }

        // === 3. è¡¨æƒ…åŒ…ç³»ç»Ÿ ===
        const emojiPanel = document.getElementById('emoji-panel');
        function toggleEmojiPanel() {
            emojiPanel.classList.toggle('open');
        }

        function insertEmoji(emoji) {
            chatInput.value += emoji;
        }

        function renderStickers() {
            const container = document.getElementById('sticker-container');
            // æ¸…é™¤æ—§çš„è´´å›¾ (ä¿ç•™å‰å‡ ä¸ªå›ºå®šæŒ‰é’®)
            while(container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
            
            const stickers = JSON.parse(localStorage.getItem('custom_stickers') || '[]');
            stickers.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'sticker-item';
                img.onclick = () => { addMessage('user', url, true); };
                container.appendChild(img);
            });
        }

        function promptAddSticker() {
            showPrompt("è¾“å…¥è¡¨æƒ…åŒ…å›¾ç‰‡ URL", (url) => {
                if(url) {
                    const stickers = JSON.parse(localStorage.getItem('custom_stickers') || '[]');
                    stickers.push(url);
                    localStorage.setItem('custom_stickers', JSON.stringify(stickers));
                    renderStickers();
                }
            });
        }

        // === 4. èœå•åŠŸèƒ½å®ç° ===

        // 4.1 èƒŒæ™¯è®¾ç½®
        function promptBackground() {
            showPrompt("è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL", (url) => {
                if(url) {
                    document.body.style.backgroundImage = `url('${url}')`;
                    localStorage.setItem('chat_bg', url);
                }
            });
            toggleMenu();
        }

        // 4.2 ä¸»åŠ¨å›å¤ (è®¡æ—¶å™¨)
        let autoReplyInterval;
        function toggleAutoReply(e) {
            e.stopPropagation(); // é˜²æ­¢èœå•å…³é—­
            const icon = document.getElementById('auto-reply-toggle');
            
            if (icon.classList.contains('fa-toggle-off')) {
                // å¼€å¯
                if (Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
                icon.classList.replace('fa-toggle-off', 'fa-toggle-on');
                icon.style.color = '#4cd964';
                
                autoReplyInterval = setInterval(() => {
                    // è¿™é‡Œè§¦å‘æ£€æµ‹é€»è¾‘
                    console.log("æ£€æµ‹æ˜¯å¦ä¸»åŠ¨å›å¤...");
                    // æ¨¡æ‹Ÿè§¦å‘
