<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --bg-dark: #000000;
    --panel-bg: #1c1c1e;
    --bubble-me: #007aff;
    --bubble-ai: #2c2c2e;
    --text-main: #ffffff;
    --text-sub: #8e8e93;
    --accent: #0a84ff;
    --danger: #ff453a;
}
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; padding: 0; width: 100vw; height: 100dvh;
    background-color: var(--bg-dark);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    display: flex; flex-direction: column; overflow: hidden;
}

/* 顶部 */
.header {
    height: 60px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center;
    background: rgba(28,28,30,0.85); backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255,255,255,0.1); z-index:50;
    position: absolute; top:0; width:100%;
}
.header-left { display:flex; align-items:center; gap:10px; flex:1; cursor:pointer; }
.back-btn { font-size:20px; color:var(--accent); padding:10px; }
.title-group { display:flex; flex-direction:column; }
.chat-name { font-weight:600; font-size:16px; }
.chat-status { font-size:11px; color:var(--text-sub); display:flex; align-items:center; gap:4px; }
.status-dot { width:6px; height:6px; background:#32d74b; border-radius:50%; }
.menu-btn { font-size:20px; color:var(--accent); padding:10px; cursor:pointer; }

/* 聊天区 */
#chat-container {
    flex:1; overflow-y:auto; padding:70px 15px 80px 15px;
    display:flex; flex-direction:column; gap:12px; scroll-behavior: smooth;
}
.msg-row { display:flex; width:100%; animation: fadeUp 0.2s ease-out; }
@keyframes fadeUp { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
.msg-row.me { justify-content:flex-end; }
.msg-row.ai { justify-content:flex-start; }
.bubble { max-width:75%; padding:10px 14px; font-size:16px; line-height:1.4; word-wrap:break-word; user-select:text; border-radius:18px;}
.me .bubble { background:var(--bubble-me); color:white; border-radius:18px 18px 4px 18px; }
.ai .bubble { background:var(--bubble-ai); color:white; border-radius:18px 18px 18px 4px; }
.sticker { max-width:140px; border-radius:12px; display:block; }

/* 正在输入 */
.typing {
    background: var(--bubble-ai); padding:12px 16px; border-radius:18px;
    width:fit-content; margin-bottom:10px; display:none; align-items:center; gap:4px;
}
.dot { width:6px; height:6px; background:#8e8e93; border-radius:50%; animation:bounce 1.4s infinite ease-in-out; }
.dot:nth-child(1) { animation-delay:-0.32s; }
.dot:nth-child(2) { animation-delay:-0.16s; }
@keyframes bounce { 0%,80%,100%{transform:scale(0);} 40%{transform:scale(1);} }

/* 底部输入栏 */
.footer {
    position:absolute; bottom:0; width:100%;
    background:rgba(28,28,30,0.95); backdrop-filter:blur(20px);
    border-top:1px solid rgba(255,255,255,0.1);
    padding:8px 10px; z-index:50;
    display:flex; flex-direction:column;
}
.toolbar { display:flex; align-items:flex-end; gap:8px; }
#input-text { flex:1; background:#2c2c2e; border:1px solid #3a3a3c; border-radius:20px; padding:10px 14px; color:white; font-size:16px; max-height:120px; resize:none; font-family:inherit; }
#input-text:focus { border-color:var(--accent); }
.icon-btn { width:36px; height:36px; display:flex; justify-content:center; align-items:center; font-size:20px; color:var(--accent); cursor:pointer; flex-shrink:0; }
.send-icon { color:#32d74b; font-size:22px; }

/* 表情面板 */
#sticker-panel { height:0; overflow:hidden; transition:height 0.25s ease; background:var(--bg-dark);}
#sticker-panel.open { height:200px; padding-top:10px; }
.sticker-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; padding:10px; overflow-y:auto; height:100%; }
.add-btn { aspect-ratio:1; border:2px dashed #444; border-radius:8px; display:flex; justify-content:center; align-items:center; font-size:24px; color:#666; }
.sticker-item { width:100%; aspect-ratio:1; object-fit:cover; border-radius:8px; }

/* 右上菜单 */
.dropdown {
    position:absolute; top:60px; right:10px; width:200px;
    background: rgba(30,30,30,0.95); backdrop-filter:blur(10px);
    border-radius:12px; border:1px solid #444; display:none; flex-direction:column;
    z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);
}
.menu-item { padding:14px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:14px; display:flex; align-items:center; gap:10px; cursor:pointer; }
.menu-item:active { background:rgba(255,255,255,0.1); }

/* 全屏层 */
.full-layer {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:#000; z-index:200; display:none; flex-direction:column;
}
.layer-head {
    padding:15px; border-bottom:1px solid #333; background:#1c1c1e;
    display:flex; align-items:center; gap:10px; font-weight:bold;
}
.layer-body { flex:1; overflow-y:auto; padding:20px; }

/* 长按菜单 */
.ctx-menu {
    position:fixed; background:#252525; border-radius:10px; z-index:999;
    width:150px; display:none; border:1px solid #444; box-shadow:0 5px 20px rgba(0,0,0,0.6);
}
.ctx-opt { padding:12px; border-bottom:1px solid #333; text-align:center; font-size:14px; }
.ctx-opt:last-child { border-bottom:none; color:var(--danger); }

/* 隐形文件上传 */
#file-input { display:none; }

</style>
</head>
<body>

<!-- 顶部 -->
<div class="header">
    <div class="header-left" onclick="window.location.href='./index.html'">
        <i class="fa-solid fa-chevron-left back-btn"></i>
        <div class="title-group">
            <div class="chat-name" id="header-name">AI 助手</div>
            <div class="chat-status"><div class="status-dot"></div>在线</div>
        </div>
    </div>
    <div class="menu-btn" onclick="app.toggleMenu()"><i class="fa-solid fa-ellipsis"></i></div>
</div>

<!-- 菜单 -->
<div class="dropdown" id="main-menu">
    <div class="menu-item" onclick="app.uploadBg()"><i class="fa-solid fa-image"></i> 更换背景</div>
    <div class="menu-item" onclick="app.toggleAutoReply()">
        <i class="fa-solid fa-robot"></i> 主动回复
        <i class="fa-solid fa-toggle-off" id="ar-toggle" style="margin-left:auto;"></i>
    </div>
    <div class="menu-item" onclick="app.makeMemoryNote()"><i class="fa-solid fa-pen"></i> 记忆笔记</div>
    <div class="menu-item" onclick="app.openBrain()"><i class="fa-solid fa-brain"></i> 大脑与总结</div>
    <div class="menu-item" onclick="app.openSettings()"><i class="fa-solid fa-sliders"></i> 聊天设置</div>
</div>

<!-- 聊天区 -->
<div id="chat-container">
    <div class="typing" id="typing-indicator">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
</div>

<!-- 底部 -->
<div class="footer">
    <div class="toolbar">
        <div class="icon-btn" onclick="app.toggleStickers()"><i class="fa-regular fa-face-smile"></i></div>
        <textarea id="input-text" rows="1" placeholder="发送消息..."></textarea>
        <div class="icon-btn" onclick="app.triggerAiReply()"><i class="fa-solid fa-microphone"></i></div>
        <div class="icon-btn send-icon" onclick="app.sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
    </div>
    <div id="sticker-panel">
        <div class="sticker-grid" id="sticker-grid"></div>
    </div>
</div>

<!-- 全屏层示例 -->
<div class="full-layer" id="layer-brain">
    <div class="layer-head">
        <i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-brain')"></i>
        大脑记忆库
        <div style="margin-left:auto; font-size:14px; color:var(--accent);" onclick="app.batchSummary()">批量总结</div>
    </div>
    <div class="layer-body" id="brain-list"></div>
</div>

<div class="full-layer" id="layer-settings">
    <div class="layer-head">
        <i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-settings')"></i>
        聊天设置
    </div>
    <div class="layer-body">
        <label>上下文携带条数 (<span id="ctx-count-display">20</span>)</label>
        <input type="range" id="ctx-slider" min="5" max="50" value="20" style="width:100%; margin-top:10px;" oninput="app.updateSettings(this.value)">
        <p style="font-size:12px; color:#666; margin-top:5px;">条数越多，消耗 Token 越多，但 AI 记性越好。</p>
    </div>
</div>

<!-- 长按菜单 -->
<div class="ctx-menu" id="ctx-menu">
    <div class="ctx-opt" onclick="app.ctxAction('edit')">编辑内容</div>
    <div class="ctx-opt" onclick="app.ctxAction('regen')">刷新回复</div>
    <div class="ctx-opt" onclick="app.ctxAction('delete')">删除</div>
</div>

<input type="file" id="file-input" accept="image/*">

<script>
const app = {
    chatHistory: [], memories:[], stickers:[], contextLimit:20,
    init: function(){
        this.renderStickers();
        document.getElementById('file-input').addEventListener('change', this.handleFile.bind(this));
        document.addEventListener('click', (e)=>{
            if(!e.target.closest('.menu-btn') && !e.target.closest('.dropdown')) document.getElementById('main-menu').style.display='none';
            if(!e.target.closest('.ctx-menu')) document.getElementById('ctx-menu').style.display='none';
        });
    },
    // 菜单
    toggleMenu:function(){
        const d=document.getElementById('main-menu');
        d.style.display = d.style.display==='flex'?'none':'flex';
    },
    uploadBg:function(){ console.log('上传背景'); },
    toggleAutoReply:function(){ console.log('切换主动回复'); },
    makeMemoryNote:function(){ console.log('记忆笔记'); },
    openBrain:function(){ document.getElementById('layer-brain').style.display='flex'; },
    openSettings:function(){ document.getElementById('layer-settings').style.display='flex'; },
    toggleStickers:function(){ document.getElementById('sticker-panel').classList.toggle('open'); },
    sendMessage:function(){
        const t=document.getElementById('input-text'); if(!t.value.trim()) return;
        this.addBubble('me',t.value); this.chatHistory.push({role:'user',content:t.value}); t.value='';
    },
    triggerAiReply:function(){ this.addBubble('ai','（正在倾听...）'); },
    addBubble:function(role,txt){
        const box=document.getElementById('chat-container'); const row=document.createElement('div');
        row.className='msg-row '+role; const bubble=document.createElement('div'); bubble.className='bubble'; bubble.innerText=txt;
        this.bindLongPress(bubble); row.appendChild(bubble);
        const indicator=document.getElementById('typing-indicator'); box.insertBefore(row,indicator); box.scrollTop=box.scrollHeight;
        return bubble;
    },
    bindLongPress:function(el){
        let timer; const start=(e)=>{ e.preventDefault(); timer=setTimeout(()=>{ this.targetBubble=el; this.showCtxMenu(e); },600); };
        const end=()=>clearTimeout(timer);
        el.addEventListener('mousedown',start); el.addEventListener('touchstart',start);
        el.addEventListener('mouseup',end); el.addEventListener('mouseleave',end); el.addEventListener('touchend',end);
    },
    showCtxMenu:function(e){ const m=document.getElementById('ctx-menu'); m.style.display='flex'; m.style.top=e.clientY+'px'; m.style.left=e.clientX+'px'; },
    ctxAction:function(a){ console.log('长按菜单操作:',a); },
    closeLayer:function(id){ document.getElementById(id).style.display='none'; },
    batchSummary:function(){ console.log('批量总结'); },
    handleFile:function(e){ console.log('上传文件',e.target.files); },
    renderStickers:function(){ const g=document.getElementById('sticker-grid'); g.innerHTML=''; this.stickers.forEach(s=>{ const i=document.createElement('img'); i.src=s; i.className='sticker-item'; g.appendChild(i); }); const add=document.createElement('div'); add.className='add-btn'; add.innerHTML='+'; add.onclick=()=>console.log('添加表情'); g.appendChild(add);}
}

document.addEventListener('DOMContentLoaded',()=>{app.init();});
</script>

</body>
</html>
