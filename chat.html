<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 保持原有样式不变 */
        :root { --bg-dark: #000000; --bubble-me: #007aff; --bubble-ai: #2c2c2e; --text-main: #ffffff; --text-sub: #8e8e93; --accent: #0a84ff; --danger: #ff453a; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100vw; height: 100dvh; background-color: var(--bg-dark); background-size: cover; background-position: center; color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, sans-serif; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 60px; padding: 0 5px; display: flex; justify-content: space-between; align-items: center; background: rgba(28, 28, 30, 0.90); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); position: absolute; top: 0; width: 100%; z-index: 1000; }
        .header-btn { padding: 10px 15px; font-size: 20px; color: var(--accent); cursor: pointer; width: 50px; text-align: center; }
        .header-center { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .chat-name { font-weight: 600; font-size: 16px; }
        .chat-status { font-size: 11px; color: var(--text-sub); display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; background: #32d74b; border-radius: 50%; }
        .status-typing { color: var(--accent); animation: blink 1s infinite; font-weight: bold; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #chat-container { flex: 1; overflow-y: auto; padding: 70px 15px 80px 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .msg-row { display: flex; width: 100%; animation: fadeUp 0.2s ease-out; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-row.me { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; }
        .bubble { max-width: 75%; padding: 10px 14px; font-size: 16px; line-height: 1.4; word-wrap: break-word; user-select: text; border-radius: 18px; }
        .me .bubble { background: var(--bubble-me); color: white; border-radius: 18px 18px 4px 18px; }
        .ai .bubble { background: var(--bubble-ai); color: white; border-radius: 18px 18px 18px 4px; }
        .sticker { max-width: 140px; border-radius: 12px; display: block; }
        .footer { position: absolute; bottom: 0; width: 100%; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); padding: 8px 10px; z-index: 1000; }
        .toolbar { display: flex; align-items: flex-end; gap: 8px; }
        #input-text { flex: 1; background: #2c2c2e; border: 1px solid #3a3a3c; border-radius: 20px; padding: 10px 14px; color: white; font-size: 16px; max-height: 120px; resize: none; }
        .icon-btn { width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; font-size: 20px; color: var(--accent); flex-shrink: 0; }
        #sticker-panel { height: 0; overflow: hidden; transition: height 0.25s ease; background: var(--bg-dark); }
        #sticker-panel.open { height: 200px; padding-top: 10px; }
        .sticker-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px; overflow-y: auto; height: 100%; }
        .sticker-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; }
        .add-btn { aspect-ratio: 1; border: 2px dashed #444; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #666; }
        .dropdown { position: absolute; top: 60px; right: 10px; width: 200px; background: rgba(30,30,30,0.95); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid #444; display: none; flex-direction: column; z-index: 2000; }
        .menu-item { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .full-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2500; display: none; flex-direction: column; }
        .layer-head { padding: 15px; border-bottom: 1px solid #333; background: #1c1c1e; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .layer-body { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1c1c1e; width: 85%; border-radius: 12px; border: 1px solid #333; overflow: hidden; max-height: 80%; display: flex; flex-direction: column;}
        .contact-item { padding: 12px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; }
        .contact-avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; justify-content: center; align-items: center; color: #aaa; }
        .typing-bubble { background: var(--bubble-ai); padding: 12px 16px; border-radius: 18px; width: fit-content; margin-bottom: 10px; display: none; align-items: center; gap: 4px; }
        .dot { width: 6px; height: 6px; background: #8e8e93; border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .ctx-menu { position: fixed; background: #252525; border-radius: 10px; z-index: 9999; width: 150px; display: none; border: 1px solid #444; }
        .ctx-opt { padding: 12px; border-bottom: 1px solid #333; text-align: center; font-size: 14px; }
        input[type="text"] { background: #2c2c2e; border: 1px solid #444; color: white; padding: 8px; border-radius: 8px; width: 100%; }
        #file-input { display: none; }
    </style>
</head>
<body>

    <!-- 顶部 -->
    <div class="header">
        <div class="header-btn" onclick="window.location.href='./index.html'"><i class="fa-solid fa-chevron-left"></i></div>
        <div class="header-center" onclick="app.showContactSwitch()">
            <div class="chat-name" id="header-name">AI</div>
            <div class="chat-status" id="header-status"><div class="status-dot"></div>在线</div>
        </div>
        <div class="header-btn" onclick="app.toggleMenu()"><i class="fa-solid fa-ellipsis"></i></div>
    </div>

    <!-- 菜单 -->
    <div class="dropdown" id="main-menu">
        <div class="menu-item" onclick="app.openUploadModal('bg')"><i class="fa-solid fa-image"></i> 更换背景</div>
        <div class="menu-item" onclick="app.toggleAutoReply()"><i class="fa-solid fa-robot"></i> 主动回复 <i class="fa-solid fa-toggle-off" id="ar-toggle" style="margin-left:auto;"></i></div>
        <div class="menu-item" onclick="app.makeMemoryNote()"><i class="fa-solid fa-pen"></i> 记忆笔记</div>
        <div class="menu-item" onclick="app.openBrain()"><i class="fa-solid fa-brain"></i> 大脑与总结</div>
        <div class="menu-item" onclick="app.openSettings()"><i class="fa-solid fa-sliders"></i> 聊天设置</div>
    </div>

    <!-- 聊天区 -->
    <div id="chat-container">
        <div class="typing-bubble" id="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>

    <!-- 底部 -->
    <div class="footer">
        <div class="toolbar">
            <div class="icon-btn" onclick="app.toggleStickers()"><i class="fa-regular fa-face-smile"></i></div>
            <textarea id="input-text" rows="1" placeholder="发送消息..."></textarea>
            <div class="icon-btn" onclick="app.triggerAiReply()"><i class="fa-solid fa-microphone"></i></div>
            <div class="icon-btn" style="color:#32d74b" onclick="app.sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
        <div id="sticker-panel"><div class="sticker-grid" id="sticker-grid"></div></div>
    </div>

    <!-- 弹窗部分 -->
    <div class="modal-overlay" id="contact-modal">
        <div class="modal-box">
            <div class="layer-head">切换角色</div>
            <div id="contact-list" style="overflow-y:auto; padding:10px;"></div>
            <button class="menu-item" style="justify-content:center; background:#333; margin:10px;" onclick="document.getElementById('contact-modal').style.display='none'">关闭</button>
        </div>
    </div>

    <div class="modal-overlay" id="upload-modal">
        <div class="modal-box">
            <div class="layer-head">上传</div>
            <div style="padding:20px;">
                <button class="menu-item" style="width:100%; justify-content:center; background:#333; margin-bottom:10px;" onclick="app.handleUploadChoice('local')">本地图片</button>
                <button class="menu-item" style="width:100%; justify-content:center; background:#333;" onclick="app.handleUploadChoice('url')">URL</button>
            </div>
            <button class="menu-item" style="justify-content:center; background:#444; margin:10px;" onclick="document.getElementById('upload-modal').style.display='none'">取消</button>
        </div>
    </div>

    <!-- 设置与大脑 -->
    <div class="full-layer" id="layer-brain">
        <div class="layer-head"><i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-brain')"></i> 大脑记忆</div>
        <div class="layer-body" id="brain-list"></div>
    </div>

    <div class="full-layer" id="layer-settings">
        <div class="layer-head"><i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-settings')"></i> 聊天设置</div>
        <div class="layer-body">
            <div style="margin-bottom:20px;">
                <label>API 地址 (基础域名即可)</label>
                <!-- 注意：这里增加了 placeholder 提示 -->
                <input type="text" id="setting-api-url" placeholder="例如: https://api.openai.com" onchange="app.saveInstantSettings()" style="margin-top:5px; font-family:monospace; font-size:12px;">
                <p style="color:#666; font-size:11px; margin-top:5px;">程序会自动帮你补全 /v1/chat/completions，你不用管。</p>
            </div>
            <div style="margin-bottom:20px;">
                <label>API Key</label>
                <input type="text" id="setting-api-key" onchange="app.saveInstantSettings()" style="margin-top:5px; -webkit-text-security:disc;">
            </div>
            <div>
                <label>上下文记忆数: <span id="ctx-count-display">20</span></label>
                <input type="range" id="ctx-slider" min="5" max="60" value="20" style="width:100%; margin-top:10px;" oninput="app.updateSettings(this.value)">
            </div>
        </div>
    </div>

    <div class="ctx-menu" id="ctx-menu">
        <div class="ctx-opt" onclick="app.ctxAction('edit')">编辑</div>
        <div class="ctx-opt" onclick="app.ctxAction('regen')">重试</div>
        <div class="ctx-opt" style="color:var(--danger)" onclick="app.ctxAction('delete')">删除</div>
    </div>
    
    <input type="file" id="file-input" accept="image/*">

    <script>
        const app = {
            apiKey: localStorage.getItem('gcli_api_key') || '',
            apiUrl: localStorage.getItem('gcli_api_url') || '',
            model: localStorage.getItem('gcli_model_name') || 'gpt-3.5-turbo',
            chatHistory: [],
            memories: JSON.parse(localStorage.getItem('ai_memories') || '[]'),
            stickers: JSON.parse(localStorage.getItem('custom_stickers') || '[]'),
            contextLimit: parseInt(localStorage.getItem('chat_context_limit') || 20),
            currentUser: localStorage.getItem('current_chat_partner') || 'My AI',
            currentPrompt: '',
            contacts: [],

            init: function() {
                try {
                    const raw = localStorage.getItem('gcli_contacts');
                    this.contacts = raw ? JSON.parse(raw) : [{nickname:'My AI', prompt:'你是一个AI助手。'}];
                    this.loadCharacter(this.currentUser);
                    
                    const bg = localStorage.getItem('chat_bg');
                    if(bg) document.body.style.backgroundImage = `url('${bg}')`;

                    document.getElementById('ctx-count-display').innerText = this.contextLimit;
                    document.getElementById('ctx-slider').value = this.contextLimit;
                    
                    // 填充设置输入框
                    document.getElementById('setting-api-url').value = this.apiUrl;
                    document.getElementById('setting-api-key').value = this.apiKey;

                    this.renderStickers();
                    
                    // 点击关闭菜单
                    document.addEventListener('click', (e)=>{
                        if(!e.target.closest('.header-btn') && !e.target.closest('.dropdown')) document.getElementById('main-menu').style.display='none';
                        if(!e.target.closest('.ctx-menu')) document.getElementById('ctx-menu').style.display='none';
                    });
                    document.getElementById('file-input').addEventListener('change', this.handleFileSelect.bind(this));

                } catch(e) { console.error(e); }
            },

            loadCharacter: function(name) {
                const char = this.contacts.find(c=>c.nickname===name) || this.contacts[0];
                this.currentUser = char.nickname;
                this.currentPrompt = char.prompt || "你是一个助手";
                document.getElementById('header-name').innerText = this.currentUser;
                localStorage.setItem('current_chat_partner', this.currentUser);
            },

            saveInstantSettings: function() {
                this.apiUrl = document.getElementById('setting-api-url').value.trim();
                this.apiKey = document.getElementById('setting-api-key').value.trim();
                localStorage.setItem('gcli_api_url', this.apiUrl);
                localStorage.setItem('gcli_api_key', this.apiKey);
            },

            // === 核心修改：智能处理 API URL ===
            callLLM: async function() {
                if(!this.apiUrl || !this.apiKey) { this.addBubble('ai', "错误：请在右上角菜单->聊天设置中填写 API。"); return; }
                
                const status = document.getElementById('header-status');
                status.innerHTML = "对方正在输入..."; status.classList.add('status-typing');
                const ind = document.getElementById('typing-indicator');
                const box = document.getElementById('chat-container');
                ind.style.display='flex'; box.appendChild(ind); box.scrollTop = box.scrollHeight;

                try {
                    const messages = [{role:"system",content:`${this.currentPrompt}\n\n[System] Reply casually.`}, ...this.chatHistory.slice(-this.contextLimit)];
                    
                    // --------------------------------------------------------
                    // 核心修改部分：自动补全 URL
                    // --------------------------------------------------------
                    let requestUrl = this.apiUrl.trim();
                    // 去掉末尾斜杠
                    if (requestUrl.endsWith('/')) requestUrl = requestUrl.slice(0, -1);
                    
                    // 智能判断并补全
                    if (!requestUrl.endsWith('/chat/completions')) {
                        if (requestUrl.endsWith('/v1')) {
                            // 如果用户写了 /v1，只补 /chat/completions
                            requestUrl += '/chat/completions';
                        } else {
                            // 否则假设是基础域名，补全 /v1/chat/completions
                            requestUrl += '/v1/chat/completions';
                        }
                    }
                    // --------------------------------------------------------
                    console.log("最终请求地址:", requestUrl);

                    const res = await fetch(requestUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
                        body: JSON.stringify({ model: this.model, messages: messages })
                    });

                    if(!res.ok) {
                        const txt = await res.text();
                        throw new Error(`HTTP ${res.status}: ${txt.substring(0,100)}`);
                    }

                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message || JSON.stringify(data.error));
                    if(!data.choices || !data.choices.length) throw new Error("API 返回无 choices 数据");

                    const reply = data.choices[0].message.content;
                    this.chatHistory.push({role:'assistant', content:reply});
                    
                    status.innerHTML = '<div class="status-dot"></div>在线'; status.classList.remove('status-typing');
                    ind.style.display='none';
                    this.processSplitMessage(reply);

                } catch(e) {
                    status.innerHTML = '<div class="status-dot"></div>在线'; status.classList.remove('status-typing');
                    ind.style.display='none';
                    this.addBubble('ai', `[连接失败]\n请检查 API 地址或 Key。\n错误: ${e.message}`);
                }
            },

            processSplitMessage: function(txt) {
                const parts = txt.split(/([！!？?\n])/).filter(p=>p.trim());
                let arr=[], buf="";
                parts.forEach(p=>{ if(p.match(/[！!？?\n]/)){buf+=p;arr.push(buf);buf=""}else{if(buf)arr.push(buf);buf=p} });
                if(buf)arr.push(buf); if(!arr.length)arr=[txt];
                
                let delay=0;
                arr.forEach(t=>{
                    let c=t.replace(/[。\.]$/,""); if(!c)return;
                    setTimeout(()=>this.addBubble('ai', c), delay);
                    delay += c.length*50 + 600;
                });
            },

            sendMessage: function() {
                const i=document.getElementById('input-text'); const v=i.value.trim();
                if(!v)return;
                this.addBubble('me',v); this.chatHistory.push({role:'user',content:v});
                i.value=''; i.focus();
                this.callLLM();
            },
            triggerAiReply: function() { this.callLLM(); },

            addBubble: function(role, txt, isImg=false) {
                const box=document.getElementById('chat-container');
                const row=document.createElement('div'); row.className=`msg-row ${role}`;
                const b=document.createElement('div'); b.className='bubble';
                if(isImg) { b.style.padding=0; b.style.background='transparent'; b.innerHTML=`<img src="${txt}" class="sticker">`; }
                else b.innerText=txt;
                this.bindLongPress(b); row.appendChild(b);
                const ind=document.getElementById('typing-indicator');
                box.insertBefore(row, ind); box.scrollTop=box.scrollHeight;
                return b;
            },

            toggleMenu: function() { const m=document.getElementById('main-menu'); m.style.display=m.style.display==='flex'?'none':'flex'; },
            
            showContactSwitch: function() {
                const l=document.getElementById('contact-list'); l.innerHTML='';
                this.contacts.forEach(c=>{
                    const d=document.createElement('div'); d.className='contact-item';
                    d.innerHTML=`<div class="contact-avatar"><i class="fa-solid fa-user"></i></div><div><div style="font-weight:bold">${c.nickname}</div><div style="font-size:12px;color:#888">${c.prompt.substring(0,20)}...</div></div>`;
                    d.onclick=()=>{ this.loadCharacter(c.nickname); document.getElementById('contact-modal').style.display='none'; this.chatHistory=[]; this.addBubble('ai', `已切换: ${c.nickname}`); };
                    l.appendChild(d);
                });
                document.getElementById('contact-modal').style.display='flex';
            },

            openUploadModal: function(t) { this.uploadTarget=t; document.getElementById('main-menu').style.display='none'; document.getElementById('upload-modal').style.display='flex'; },
            handleUploadChoice: function(t) {
                document.getElementById('upload-modal').style.display='none';
                if(t==='local') document.getElementById('file-input').click();
                else { const u=prompt("URL:"); if(u)this.applyUpload(u); }
            },
            handleFileSelect: function(e) {
                const f=e.target.files[0]; if(!f)return;
                const r=new FileReader(); r.onload=(ev)=>this.applyUpload(ev.target.result); r.readAsDataURL(f); e.target.value='';
            },
            applyUpload: function(u) {
                if(this.uploadTarget==='bg') { document.body.style.backgroundImage=`url('${u}')`; localStorage.setItem('chat_bg',u); }
                else { this.stickers.push(u); localStorage.setItem('custom_stickers',JSON.stringify(this.stickers)); this.renderStickers(); }
            },
            renderStickers: function() {
                const g=document.getElementById('sticker-grid'); g.innerHTML='';
                const btn=document.createElement('div'); btn.className='add-btn'; btn.innerText='+'; btn.onclick=()=>this.openUploadModal('sticker'); g.appendChild(btn);
                this.stickers.forEach(s=>{
                    const i=document.createElement('img'); i.className='sticker-item'; i.src=s;
                    i.onclick=()=>{ this.addBubble('me',s,true); this.chatHistory.push({role:'user',content:'[img]'}); this.callLLM(); };
                    g.appendChild(i);
                });
            },
            toggleStickers: function() { document.getElementById('sticker-panel').classList.toggle('open'); },
            
            makeMemoryNote: function() {
                document.getElementById('main-menu').style.display='none';
                this.memories.unshift({date:new Date().toLocaleString(), content:`记忆 ${new Date().toLocaleTimeString()}`});
                localStorage.setItem('ai_memories',JSON.stringify(this.memories));
                this.addBubble('ai', "已记录到大脑。");
            },
            openBrain: function() {
                document.getElementById('main-menu').style.display='none';
                const l=document.getElementById('brain-list'); l.innerHTML='';
                this.memories.forEach((m,i)=>{
                    const d=document.createElement('div'); d.style="background:#2c2c2e;padding:10px;margin-bottom:10px;border-radius:8px;";
                    d.innerHTML=`<div style="font-size:12px;color:#666;display:flex;justify-content:space-between;">${m.date}<span style="color:red" onclick="app.delMem(${i})">删</span></div><div contenteditable="true" onblur="app.updMem(${i},this.innerText)" style="color:#ddd">${m.content}</div>`;
                    l.appendChild(d);
                });
                document.getElementById('layer-brain').style.display='flex';
            },
            delMem: function(i) { this.memories.splice(i,1); localStorage.setItem('ai_memories',JSON.stringify(this.memories)); this.openBrain(); },
            updMem: function(i,t) { this.memories[i].content=t; localStorage.setItem('ai_memories',JSON.stringify(this.memories)); },

            openSettings: function() { document.getElementById('main-menu').style.display='none'; document.getElementById('layer-settings').style.display='flex'; },
            updateSettings: function(v) { this.contextLimit=v; localStorage.setItem('chat_context_limit',v); document.getElementById('ctx-count-display').innerText=v; },
            closeLayer: function(id) { document.getElementById(id).style.display='none'; },
            toggleAutoReply: function() { alert("自动回复模拟开启"); },
            
            bindLongPress: function(el) {
                let t; const start=(e)=>{ t=setTimeout(()=>{ this.targetBubble=el; const touch=e.touches?e.touches[0]:e; const m=document.getElementById('ctx-menu'); m.style.left=(Math.min(touch.clientX,window.innerWidth-160))+'px'; m.style.top=touch.clientY+'px'; m.style.display='block'; },600); };
                el.addEventListener('mousedown',start); el.addEventListener('touchstart',start); el.addEventListener('mouseup',()=>clearTimeout(t)); el.addEventListener('touchend',()=>clearTimeout(t));
            },
            ctxAction: function(a) {
                document.getElementById('ctx-menu').style.display='none';
                if(!this.targetBubble)return;
                const r=this.targetBubble.closest('.msg-row');
                if(a==='delete') r.remove();
                if(a==='edit') { const n=prompt("编辑",this.targetBubble.innerText); if(n)this.targetBubble.innerText=n; }
                if(a==='regen') { r.remove(); this.chatHistory.pop(); this.callLLM(); }
            }
        };
        window.onload=()=>app.init();
    </script>
</body>
</html>
