<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #000000;
            --panel-bg: #1c1c1e;
            --bubble-me: #007aff;
            --bubble-ai: #2c2c2e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --accent: #0a84ff;
            --danger: #ff453a;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; width: 100vw; height: 100dvh;
            background-color: var(--bg-dark);
            background-size: cover; background-position: center;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* === 顶部导航 === */
        .header {
            height: 60px; padding: 0 10px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(28, 28, 30, 0.90); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            position: absolute; top: 0; width: 100%; z-index: 1000; /* 提高层级 */
        }
        
        /* 返回按钮区域 */
        .header-left-btn {
            padding: 10px 15px; font-size: 20px; color: var(--accent); cursor: pointer;
            z-index: 1001;
        }

        /* 中间标题区域 (点击切换角色) */
        .header-center {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            padding: 5px 20px; border-radius: 8px; transition: background 0.2s;
        }
        .header-center:active { background: rgba(255,255,255,0.1); }
        .chat-name { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .chat-status { font-size: 11px; color: var(--text-sub); display: flex; align-items: center; gap: 4px; margin-top: 2px; }
        .status-dot { width: 6px; height: 6px; background: #32d74b; border-radius: 50%; }
        
        /* 状态闪烁 */
        .status-typing { color: var(--accent); animation: blink 1s infinite; font-weight: bold; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* 右侧菜单按钮 */
        .menu-btn { 
            padding: 10px 15px; font-size: 20px; color: var(--accent); cursor: pointer; 
            z-index: 1001;
        }

        /* === 聊天滚动区 === */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 70px 15px 80px 15px;
            display: flex; flex-direction: column; gap: 12px;
            scroll-behavior: smooth;
        }

        .msg-row { display: flex; width: 100%; animation: fadeUp 0.2s ease-out; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-row.me { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; }

        .bubble {
            max-width: 75%; padding: 10px 14px; font-size: 16px; line-height: 1.4;
            position: relative; word-wrap: break-word; user-select: text;
        }
        .me .bubble { background: var(--bubble-me); color: white; border-radius: 18px 18px 4px 18px; }
        .ai .bubble { background: var(--bubble-ai); color: white; border-radius: 18px 18px 18px 4px; }
        .sticker { max-width: 140px; border-radius: 12px; display: block; }

        /* 正在输入 */
        .typing-bubble {
            background: var(--bubble-ai); padding: 12px 16px; border-radius: 18px;
            width: fit-content; margin-bottom: 10px; display: none; align-items: center; gap: 4px;
        }
        .dot { width: 6px; height: 6px; background: #8e8e93; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === 底部输入栏 === */
        .footer {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 8px 10px; z-index: 1000;
            display: flex; flex-direction: column;
        }
        .toolbar { display: flex; align-items: flex-end; gap: 8px; }
        
        #input-text {
            flex: 1; background: #2c2c2e; border: 1px solid #3a3a3c; border-radius: 20px;
            padding: 10px 14px; color: white; font-size: 16px; max-height: 120px;
            resize: none; font-family: inherit;
        }
        #input-text:focus { border-color: var(--accent); }

        .icon-btn {
            width: 36px; height: 36px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: var(--accent); cursor: pointer; flex-shrink: 0;
        }
        .send-icon { color: #32d74b; font-size: 22px; }

        /* === 表情面板 === */
        #sticker-panel {
            height: 0; overflow: hidden; transition: height 0.25s ease;
            background: var(--bg-dark);
        }
        #sticker-panel.open { height: 200px; padding-top: 10px; }
        .sticker-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px; overflow-y: auto; height: 100%; }
        .add-btn {
            aspect-ratio: 1; border: 2px dashed #444; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-size: 24px; color: #666; cursor: pointer;
        }
        .sticker-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; }

        /* === 右上菜单 === */
        .dropdown {
            position: absolute; top: 60px; right: 10px; width: 220px;
            background: rgba(30,30,30,0.95); backdrop-filter: blur(10px);
            border-radius: 12px; border: 1px solid #444; display: none; flex-direction: column;
            z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .menu-item {
            padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .menu-item:active { background: rgba(255,255,255,0.1); }

        /* === 角色切换弹窗 === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: #1c1c1e; width: 85%; max-height: 70%; border-radius: 12px;
            display: flex; flex-direction: column; overflow: hidden; border: 1px solid #333;
        }
        .modal-title { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; text-align: center; background: #252525; }
        .modal-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .contact-item {
            padding: 12px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px;
            cursor: pointer;
        }
        .contact-item:last-child { border-bottom: none; }
        .contact-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #333; 
            display: flex; justify-content: center; align-items: center; color: #aaa;
        }
        .contact-info { flex: 1; }
        .contact-name { font-size: 15px; font-weight: bold; }
        .contact-prompt { font-size: 12px; color: #888; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 180px;}

        /* === 全屏层 (大脑/设置) === */
        .full-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2500; display: none; flex-direction: column;
        }
        .layer-head {
            padding: 15px; border-bottom: 1px solid #333; background: #1c1c1e;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
        }
        .layer-body { flex: 1; overflow-y: auto; padding: 20px; }

        /* 长按菜单 */
        .ctx-menu {
            position: fixed; background: #252525; border-radius: 10px; z-index: 9999;
            width: 150px; display: none; border: 1px solid #444; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
        }
        .ctx-opt { padding: 12px; border-bottom: 1px solid #333; text-align: center; font-size: 14px; }

        /* 隐形文件上传 */
        #file-input { display: none; }

    </style>
</head>
<body>

    <!-- 顶部 -->
    <div class="header">
        <!-- 1. 返回主页 (左侧) -->
        <div class="header-left-btn" onclick="window.location.href='./index.html'">
            <i class="fa-solid fa-chevron-left"></i>
        </div>
        
        <!-- 2. 角色切换 (中间) -->
        <div class="header-center" onclick="app.showContactSwitch()">
            <div class="chat-name">
                <span id="header-name">加载中...</span> <i class="fa-solid fa-caret-down" style="font-size:12px; color:#666;"></i>
            </div>
            <div class="chat-status" id="header-status"><div class="status-dot"></div>在线</div>
        </div>

        <!-- 3. 菜单按钮 (右侧) -->
        <div class="menu-btn" onclick="app.toggleMenu()">
            <i class="fa-solid fa-ellipsis"></i>
        </div>
    </div>

    <!-- 右上菜单 -->
    <div class="dropdown" id="main-menu">
        <div class="menu-item" onclick="app.openUploadModal('bg')"><i class="fa-solid fa-image"></i> 更换背景 (本地/URL)</div>
        <div class="menu-item" onclick="app.toggleAutoReply()">
            <i class="fa-solid fa-robot"></i> 主动回复 
            <i class="fa-solid fa-toggle-off" id="ar-toggle" style="margin-left:auto; font-size:18px;"></i>
        </div>
        <div class="menu-item" onclick="app.makeMemoryNote()"><i class="fa-solid fa-pen"></i> 记忆笔记</div>
        <div class="menu-item" onclick="app.openBrain()"><i class="fa-solid fa-brain"></i> 大脑与总结</div>
        <div class="menu-item" onclick="app.openSettings()"><i class="fa-solid fa-sliders"></i> 聊天设置</div>
    </div>

    <!-- 聊天内容 -->
    <div id="chat-container">
        <div class="typing-bubble" id="typing-indicator">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <!-- 底部栏 -->
    <div class="footer">
        <div class="toolbar">
            <div class="icon-btn" onclick="app.toggleStickers()"><i class="fa-regular fa-face-smile"></i></div>
            <textarea id="input-text" rows="1" placeholder="发送消息..."></textarea>
            <div class="icon-btn" onclick="app.triggerAiReply()"><i class="fa-solid fa-microphone"></i></div>
            <div class="icon-btn send-icon" onclick="app.sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
        <div id="sticker-panel">
            <div class="sticker-grid" id="sticker-grid"></div>
        </div>
    </div>

    <!-- === 角色切换弹窗 === -->
    <div class="modal-overlay" id="contact-modal">
        <div class="modal-box">
            <div class="modal-title">切换聊天对象</div>
            <div class="modal-list" id="contact-list">
                <!-- JS 生成 -->
            </div>
            <div style="padding:10px;">
                <button class="icon-btn" style="width:100%; font-size:14px; color:#fff; background:#333; border-radius:8px;" onclick="document.getElementById('contact-modal').style.display='none'">关闭</button>
            </div>
        </div>
    </div>

    <!-- === 通用上传弹窗 === -->
    <div class="modal-overlay" id="upload-modal">
        <div class="modal-box">
            <div class="modal-title" id="upload-title">上传</div>
            <div style="padding:20px;">
                <button class="menu-item" style="width:100%; justify-content:center; background:#333; margin-bottom:10px; border-radius:8px;" onclick="app.handleUploadChoice('local')">本地相册</button>
                <button class="menu-item" style="width:100%; justify-content:center; background:#333; border-radius:8px;" onclick="app.handleUploadChoice('url')">输入 URL</button>
            </div>
            <div style="padding:10px;">
                <button class="icon-btn" style="width:100%; font-size:14px; color:#fff; background:#444; border-radius:8px;" onclick="document.getElementById('upload-modal').style.display='none'">取消</button>
            </div>
        </div>
    </div>

    <!-- === 全屏层：大脑 === -->
    <div class="full-layer" id="layer-brain">
        <div class="layer-head">
            <i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-brain')" style="padding:10px;"></i>
            大脑记忆库
            <div style="margin-left:auto; font-size:14px; color:var(--accent); cursor:pointer;" onclick="app.batchSummary()">批量总结</div>
        </div>
        <div class="layer-body" id="brain-list"></div>
    </div>

    <!-- === 全屏层：设置 === -->
    <div class="full-layer" id="layer-settings">
        <div class="layer-head">
            <i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-settings')" style="padding:10px;"></i>
            聊天设置
        </div>
        <div class="layer-body">
            <div style="margin-bottom:20px;">
                <label>上下文携带条数 (<span id="ctx-count-display">20</span>)</label>
                <input type="range" id="ctx-slider" min="5" max="100" value="20" style="width:100%; margin-top:10px;" oninput="app.updateSettings(this.value)">
                <p style="font-size:12px; color:#666; margin-top:5px;">数值越大，AI 记得越远，但消耗更多。</p>
            </div>
            <div style="background:#333; padding:10px; border-radius:8px; font-size:12px; color:#aaa; word-break:break-all;">
                <div>当前 API: <span id="debug-api"></span></div>
                <div>当前 Key: <span id="debug-key"></span> (已隐藏)</div>
            </div>
        </div>
    </div>

    <!-- 长按菜单 -->
    <div class="ctx-menu" id="ctx-menu">
        <div class="ctx-opt" onclick="app.ctxAction('edit')">编辑内容</div>
        <div class="ctx-opt" onclick="app.ctxAction('regen')">刷新回复</div>
        <div class="ctx-opt" style="color:var(--danger)" onclick="app.ctxAction('delete')">删除</div>
    </div>

    <input type="file" id="file-input" accept="image/*">

    <script>
        const app = {
            apiKey: localStorage.getItem('gcli_api_key') || '',
            apiUrl: localStorage.getItem('gcli_api_url') || '',
            model: localStorage.getItem('gcli_model_name') || 'gpt-3.5-turbo',
            
            chatHistory: [],
            memories: JSON.parse(localStorage.getItem('ai_memories') || '[]'),
            stickers: JSON.parse(localStorage.getItem('custom_stickers') || '[]'),
            contextLimit: parseInt(localStorage.getItem('chat_context_limit') || 20),
            
            currentUser: localStorage.getItem('current_chat_partner') || 'My AI',
            currentPrompt: '', 
            contacts: [],

            init: function() {
                try {
                    // 1. 安全加载通讯录
                    const rawContacts = localStorage.getItem('gcli_contacts');
                    this.contacts = rawContacts ? JSON.parse(rawContacts) : [];
                    
                    if (this.contacts.length === 0) {
                        // 默认角色，防止空列表导致逻辑崩溃
                        this.contacts.push({nickname: 'My AI', prompt: '你是一个AI助手。'});
                    }

                    // 2. 匹配当前角色
                    this.loadCharacter(this.currentUser);

                    // 3. 背景
                    const bg = localStorage.getItem('chat_bg');
                    if(bg) document.body.style.backgroundImage = `url('${bg}')`;

                    // 4. 设置与贴图
                    document.getElementById('ctx-count-display').innerText = this.contextLimit;
                    document.getElementById('ctx-slider').value = this.contextLimit;
                    this.renderStickers();
                    
                    // 5. 调试信息
                    document.getElementById('debug-api').innerText = this.apiUrl ? this.apiUrl : "未设置";
                    document.getElementById('debug-key').innerText = this.apiKey ? "******" : "未设置";

                    // 6. 事件
                    document.getElementById('file-input').addEventListener('change', this.handleFileSelect.bind(this));
                    document.addEventListener('click', (e) => {
                        if(!e.target.closest('.menu-btn') && !e.target.closest('.dropdown')) {
                            document.getElementById('main-menu').style.display='none';
                        }
                        if(!e.target.closest('.ctx-menu')) {
                            document.getElementById('ctx-menu').style.display='none';
                        }
                    });

                } catch (err) {
                    console.error("初始化严重错误:", err);
                    alert("初始化失败，请重置数据。" + err.message);
                }
            },

            loadCharacter: function(name) {
                const char = this.contacts.find(c => c.nickname === name) || this.contacts[0];
                this.currentUser = char.nickname;
                this.currentPrompt = char.prompt || "你是一个助手";
                document.getElementById('header-name').innerText = this.currentUser;
                localStorage.setItem('current_chat_partner', this.currentUser);
            },

            // === 修复1：角色切换弹窗 ===
            showContactSwitch: function() {
                const list = document.getElementById('contact-list');
                list.innerHTML = '';
                
                this.contacts.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.onclick = () => {
                        this.loadCharacter(c.nickname);
                        document.getElementById('contact-modal').style.display = 'none';
                        this.addBubble('ai', `已切换到 ${c.nickname}，你好！`);
                        this.chatHistory = []; // 切换后清空临时历史
                    };
                    div.innerHTML = `
                        <div class="contact-avatar"><i class="fa-solid fa-user"></i></div>
                        <div class="contact-info">
                            <div class="contact-name">${c.nickname}</div>
                            <div class="contact-prompt">${c.prompt || '无设定'}</div>
                        </div>
                        ${c.nickname === this.currentUser ? '<i class="fa-solid fa-check" style="color:#32d74b"></i>' : ''}
                    `;
                    list.appendChild(div);
                });
                
                document.getElementById('contact-modal').style.display = 'flex';
            },

            // === 修复2：API 调用与严格错误处理 ===
            callLLM: async function() {
                if(!this.apiKey || !this.apiUrl) {
                    this.addBubble('ai', "错误：请先在设置中填写 API Key 和 URL。");
                    return;
                }

                // UI
                const status = document.getElementById('header-status');
                status.innerHTML = "对方正在输入...";
                status.classList.add('status-typing');
                
                const indicator = document.getElementById('typing-indicator');
                const box = document.getElementById('chat-container');
                indicator.style.display = 'flex';
                box.appendChild(indicator);
                box.scrollTop = box.scrollHeight;

                try {
                    const messages = [
                        { role: "system", content: `${this.currentPrompt}\n\n[指令]请用口语化、类似短信的风格回复，不要用句号结尾。` },
                        ...this.chatHistory.slice(-this.contextLimit)
                    ];

                    const res = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
                        body: JSON.stringify({ model: this.model, messages: messages })
                    });

                    // 1. 先尝试解析 JSON
                    let data;
                    try {
                        data = await res.json();
                    } catch (jsonErr) {
                        throw new Error(`API 返回了非 JSON 数据 (可能是 404 或 500 HTML 页面)`);
                    }

                    // 2. 检查逻辑错误
                    if (data.error) {
                        throw new Error(`API 报错: ${data.error.message || JSON.stringify(data.error)}`);
                    }
                    
                    // 3. 严格检查 choices 结构 (修复 Cannot read properties of undefined)
                    if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                        throw new Error(`API 返回格式异常: 找不到 choices 数据。返回内容: ${JSON.stringify(data)}`);
                    }

                    const reply = data.choices[0].message.content;
                    this.chatHistory.push({ role: "assistant", content: reply });
                    
                    // 恢复状态
                    status.innerHTML = '<div class="status-dot"></div>在线';
                    status.classList.remove('status-typing');
                    indicator.style.display = 'none';

                    this.processSplitMessage(reply);

                } catch (e) {
                    status.innerHTML = '<div class="status-dot"></div>在线';
                    status.classList.remove('status-typing');
                    indicator.style.display = 'none';
                    this.addBubble('ai', `[API连接失败] ${e.message}`);
                }
            },

            processSplitMessage: function(text) {
                const parts = text.split(/([！!？?\n])/).filter(p => p.trim());
                let cleanParts = [];
                let buffer = "";
                parts.forEach(p => {
                    if(p.match(/[！!？?\n]/)) { buffer += p; cleanParts.push(buffer); buffer=""; }
                    else { if(buffer) cleanParts.push(buffer); buffer = p; }
                });
                if(buffer) cleanParts.push(buffer);
                if(cleanParts.length === 0) cleanParts = [text];

                let delay = 0;
                cleanParts.forEach(part => {
                    let t = part.replace(/[。\.]$/g, "");
                    if(!t) return;
                    setTimeout(() => {
                        this.addBubble('ai', t);
                    }, delay);
                    delay += (t.length * 50) + 800;
                });
            },

            // === 消息发送 ===
            sendMessage: function() {
                const i = document.getElementById('input-text');
                const t = i.value.trim();
                if(!t) return;
                this.addBubble('me', t);
                this.chatHistory.push({role:'user', content:t});
                i.value=''; i.focus();
                this.callLLM();
            },
            triggerAiReply: function() { this.callLLM(); },

            addBubble: function(role, txt, isImg=false) {
                const box = document.getElementById('chat-container');
                const row = document.createElement('div'); row.className=`msg-row ${role}`;
                const b = document.createElement('div'); b.className='bubble';
                if(isImg) { b.style.padding=0; b.style.background='transparent'; b.innerHTML=`<img src="${txt}" class="sticker">`; }
                else b.innerText=txt;
                
                this.bindLongPress(b);
                row.appendChild(b);
                const ind = document.getElementById('typing-indicator');
                box.insertBefore(row, ind);
                box.scrollTop = box.scrollHeight;
                return b;
            },

            // === 修复3：菜单与上传 ===
            toggleMenu: function() {
                const m = document.getElementById('main-menu');
                m.style.display = m.style.display==='flex'?'none':'flex';
            },

            openUploadModal: function(target) {
                this.uploadTarget = target;
                document.getElementById('main-menu').style.display='none';
                document.getElementById('upload-modal').style.display='flex';
                document.getElementById('upload-title').innerText = target==='bg'?'更换背景':'添加表情';
            },

            handleUploadChoice: function(type) {
                document.getElementById('upload-modal').style.display='none';
                if(type==='local') document.getElementById('file-input').click();
                else {
                    const u = prompt("请输入图片链接 (URL):");
                    if(u) this.applyUpload(u);
                }
            },

            handleFileSelect: function(e) {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => this.applyUpload(evt.target.result);
                r.readAsDataURL(f);
                e.target.value='';
            },

            applyUpload: function(src) {
                if(this.uploadTarget==='bg') {
                    document.body.style.backgroundImage=`url('${src}')`;
                    localStorage.setItem('chat_bg', src);
                } else {
                    this.stickers.push(src);
                    localStorage.setItem('custom_stickers', JSON.stringify(this.stickers));
                    this.renderStickers();
                }
            },

            // === 其他功能 ===
            renderStickers: function() {
                const g = document.getElementById('sticker-grid'); g.innerHTML='';
                const add = document.createElement('div'); add.className='add-btn'; add.innerText='+';
                add.onclick=()=>this.openUploadModal('sticker');
                g.appendChild(add);
                this.stickers.forEach(s=>{
                    const i=document.createElement('img'); i.className='sticker-item'; i.src=s;
                    i.onclick=()=>{
                        this.addBubble('me', s, true);
                        this.chatHistory.push({role:'user', content:'[图片]'});
                        this.callLLM();
                    };
                    g.appendChild(i);
                });
            },
            toggleStickers: function() { document.getElementById('sticker-panel').classList.toggle('open'); },
            
            makeMemoryNote: function() {
                document.getElementById('main-menu').style.display='none';
                this.addBubble('ai', "正在记录...");
                setTimeout(()=>{
                    const note = `【${new Date().toLocaleTimeString()}】与User对话。`;
                    this.memories.unshift({date:new Date().toLocaleString(), content:note});
                    localStorage.setItem('ai_memories', JSON.stringify(this.memories));
                    this.addBubble('ai', "已存入大脑。");
                }, 500);
            },
            
            openBrain: function() {
                document.getElementById('main-menu').style.display='none';
                const l=document.getElementById('brain-list'); l.innerHTML='';
                this.memories.forEach((m,i)=>{
                    const d=document.createElement('div'); d.style="background:#2c2c2e; padding:10px; margin-bottom:10px; border-radius:8px;";
                    d.innerHTML=`<div style="font-size:12px; color:#888; display:flex; justify-content:space-between;">${m.date} <span onclick="app.delMem(${i})" style="color:red">删</span></div><div contenteditable="true" style="color:#ddd" onblur="app.updMem(${i},this.innerText)">${m.content}</div>`;
                    l.appendChild(d);
                });
                document.getElementById('layer-brain').style.display='flex';
            },
            delMem: function(i) { this.memories.splice(i,1); localStorage.setItem('ai_memories', JSON.stringify(this.memories)); this.openBrain(); },
            updMem: function(i,t) { this.memories[i].content=t; localStorage.setItem('ai_memories', JSON.stringify(this.memories)); },

            openSettings: function() { document.getElementById('main-menu').style.display='none'; document.getElementById('layer-settings').style.display='flex'; },
            updateSettings: function(v) { this.contextLimit=parseInt(v); localStorage.setItem('chat_context_limit',v); document.getElementById('ctx-count-display').innerText=v; },
            closeLayer: function(id) { document.getElementById(id).style.display='none'; },

            toggleAutoReply: function() {
                const t=document.getElementById('ar-toggle');
                if(t.classList.contains('fa-toggle-off')) {
                    Notification.requestPermission().then(p=>{
                        if(p==='granted') {
                            t.className='fa-solid fa-toggle-on'; t.style.color='#32d74b';
                            alert("主动回复开启 (300秒检测)");
                        } else alert("请允许通知权限");
                    });
                } else {
                    t.className='fa-solid fa-toggle-off'; t.style.color='inherit';
                }
            },

            // 长按
            bindLongPress: function(el) {
                let timer; const start=(e)=>{ timer=setTimeout(()=>{ this.targetBubble=el; const t=e.touches?e.touches[0]:e; const m=document.getElementById('ctx-menu'); m.style.left=(Math.min(t.clientX,window.innerWidth-160))+'px'; m.style.top=t.clientY+'px'; m.style.display='block'; },600); };
                const end=()=>clearTimeout(timer);
                el.addEventListener('mousedown',start); el.addEventListener('touchstart',start); el.addEventListener('mouseup',end); el.addEventListener('touchend',end);
            },
            ctxAction: function(a) {
                document.getElementById('ctx-menu').style.display='none';
                if(!this.targetBubble)return;
                const r=this.targetBubble.closest('.msg-row');
                if(a==='delete') r.remove();
                if(a==='edit') { const n=prompt("修改",this.targetBubble.innerText); if(n) this.targetBubble.innerText=n; }
                if(a==='regen') { r.remove(); this.chatHistory.pop(); this.callLLM(); }
            }
        };

        window.onload = ()=> app.init();
    </script>
</body>
</html>
