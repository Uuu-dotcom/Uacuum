<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #000000;
            --panel-bg: #1c1c1e;
            --bubble-me: #007aff;
            --bubble-ai: #2c2c2e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --accent: #0a84ff;
            --danger: #ff453a;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; width: 100vw; height: 100dvh;
            background-color: var(--bg-dark);
            background-size: cover; background-position: center;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* === 顶部 === */
        .header {
            height: 60px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 50;
            position: absolute; top: 0; width: 100%;
        }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
        .back-btn { font-size: 20px; color: var(--accent); padding: 10px; }
        .title-group { display: flex; flex-direction: column; }
        .chat-name { font-weight: 600; font-size: 16px; }
        .chat-status { font-size: 11px; color: var(--text-sub); display: flex; align-items: center; gap: 4px; transition: color 0.3s;}
        
        /* 状态指示灯 */
        .status-dot { width: 6px; height: 6px; background: #32d74b; border-radius: 50%; }
        .status-typing { color: var(--accent); animation: blink 1s infinite; font-weight: bold; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .menu-btn { font-size: 20px; color: var(--accent); padding: 10px; cursor: pointer; }

        /* === 聊天滚动区 === */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 70px 15px 80px 15px;
            display: flex; flex-direction: column; gap: 12px;
            scroll-behavior: smooth;
        }

        .msg-row { display: flex; width: 100%; animation: fadeUp 0.2s ease-out; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-row.me { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; }

        .bubble {
            max-width: 75%; padding: 10px 14px; font-size: 16px; line-height: 1.4;
            position: relative; word-wrap: break-word; user-select: text;
        }
        
        .me .bubble { 
            background: var(--bubble-me); color: white; 
            border-radius: 18px 18px 4px 18px; 
        }
        .ai .bubble { 
            background: var(--bubble-ai); color: white; 
            border-radius: 18px 18px 18px 4px;
        }

        .sticker { max-width: 140px; border-radius: 12px; display: block; }

        /* === 正在输入气泡 === */
        .typing-bubble {
            background: var(--bubble-ai); padding: 12px 16px; border-radius: 18px;
            width: fit-content; margin-bottom: 10px; display: none; align-items: center; gap: 4px;
        }
        .dot { width: 6px; height: 6px; background: #8e8e93; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === 底部输入栏 === */
        .footer {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 8px 10px; z-index: 50;
            display: flex; flex-direction: column;
        }
        .toolbar { display: flex; align-items: flex-end; gap: 8px; }
        
        #input-text {
            flex: 1; background: #2c2c2e; border: 1px solid #3a3a3c; border-radius: 20px;
            padding: 10px 14px; color: white; font-size: 16px; max-height: 120px;
            resize: none; font-family: inherit;
        }
        #input-text:focus { border-color: var(--accent); }

        .icon-btn {
            width: 36px; height: 36px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: var(--accent); cursor: pointer; flex-shrink: 0;
        }
        .send-icon { color: #32d74b; font-size: 22px; }

        /* === 表情面板 === */
        #sticker-panel {
            height: 0; overflow: hidden; transition: height 0.25s ease;
            background: var(--bg-dark);
        }
        #sticker-panel.open { height: 200px; padding-top: 10px; }
        .sticker-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px; overflow-y: auto; height: 100%; }
        .add-btn {
            aspect-ratio: 1; border: 2px dashed #444; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-size: 24px; color: #666; cursor: pointer;
        }
        .sticker-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; }

        /* === 菜单 & 弹窗 === */
        .dropdown {
            position: absolute; top: 60px; right: 10px; width: 220px;
            background: rgba(30,30,30,0.95); backdrop-filter: blur(10px);
            border-radius: 12px; border: 1px solid #444; display: none; flex-direction: column;
            z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .menu-item {
            padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .menu-item:active { background: rgba(255,255,255,0.1); }

        /* 全屏层 */
        .full-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 200; display: none; flex-direction: column;
        }
        .layer-head {
            padding: 15px; border-bottom: 1px solid #333; background: #1c1c1e;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
        }
        .layer-body { flex: 1; overflow-y: auto; padding: 20px; }

        /* 通用上传选择弹窗 */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); z-index: 300; display: none;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: #252525; padding: 20px; border-radius: 12px; width: 80%;
            text-align: center; border: 1px solid #444;
        }
        .modal-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background: #333; border: 1px solid #444; color: white; border-radius: 8px; font-size: 14px;
        }
        .modal-btn.primary { background: var(--accent); color: white; border: none; font-weight: bold;}

        /* 长按菜单 */
        .ctx-menu {
            position: fixed; background: #252525; border-radius: 10px; z-index: 999;
            width: 150px; display: none; border: 1px solid #444; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
        }
        .ctx-opt { padding: 12px; border-bottom: 1px solid #333; text-align: center; font-size: 14px; }
        .ctx-opt:last-child { border-bottom: none; }
        
        /* 隐藏文件输入 */
        #file-input { display: none; }
    </style>
</head>
<body>

    <!-- 顶部 -->
    <div class="header">
        <div class="header-left" onclick="window.location.href='./index.html'">
            <i class="fa-solid fa-chevron-left back-btn"></i>
            <div class="title-group">
                <div class="chat-name" id="header-name">AI 助手</div>
                <div class="chat-status" id="header-status"><div class="status-dot"></div>在线</div>
            </div>
        </div>
        <div class="menu-btn" onclick="app.toggleMenu()">
            <i class="fa-solid fa-ellipsis"></i>
        </div>
    </div>

    <!-- 右上菜单 -->
    <div class="dropdown" id="main-menu">
        <div class="menu-item" onclick="app.openUploadModal('bg')">
            <i class="fa-solid fa-image"></i> 更换背景 (本地/URL)
        </div>
        <div class="menu-item" onclick="app.toggleAutoReply()">
            <i class="fa-solid fa-robot"></i> 主动回复 
            <i class="fa-solid fa-toggle-off" id="ar-toggle" style="margin-left:auto; font-size:18px;"></i>
        </div>
        <div class="menu-item" onclick="app.makeMemoryNote()">
            <i class="fa-solid fa-pen"></i> 记忆笔记 (存入大脑)
        </div>
        <div class="menu-item" onclick="app.openBrain()">
            <i class="fa-solid fa-brain"></i> 大脑与总结
        </div>
        <div class="menu-item" onclick="app.openSettings()">
            <i class="fa-solid fa-sliders"></i> 聊天设置
        </div>
    </div>

    <!-- 聊天内容 -->
    <div id="chat-container">
        <!-- 正在输入提示气泡 -->
        <div class="typing-bubble" id="typing-indicator">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <!-- 底部栏 -->
    <div class="footer">
        <div class="toolbar">
            <div class="icon-btn" onclick="app.toggleStickers()"><i class="fa-regular fa-face-smile"></i></div>
            <textarea id="input-text" rows="1" placeholder="发送消息..."></textarea>
            <div class="icon-btn" onclick="app.triggerAiReply()"><i class="fa-solid fa-microphone"></i></div>
            <div class="icon-btn send-icon" onclick="app.sendMessage()"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
        
        <div id="sticker-panel">
            <div class="sticker-grid" id="sticker-grid">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- === 上传选择弹窗 (本地/URL) === -->
    <div class="modal-overlay" id="upload-modal">
        <div class="modal-box">
            <h3 id="upload-title" style="margin-top:0;">选择上传方式</h3>
            <button class="modal-btn" onclick="app.handleUploadChoice('local')">本地图片</button>
            <button class="modal-btn" onclick="app.handleUploadChoice('url')">图片 URL</button>
            <button class="modal-btn primary" onclick="document.getElementById('upload-modal').style.display='none'">取消</button>
        </div>
    </div>

    <!-- === 全屏层：大脑 === -->
    <div class="full-layer" id="layer-brain">
        <div class="layer-head">
            <i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-brain')" style="padding:10px;"></i>
            大脑记忆库
            <div style="margin-left:auto; font-size:14px; color:var(--accent); cursor:pointer;" onclick="app.batchSummary()">批量总结</div>
        </div>
        <div class="layer-body" id="brain-list"></div>
    </div>

    <!-- === 全屏层：设置 === -->
    <div class="full-layer" id="layer-settings">
        <div class="layer-head">
            <i class="fa-solid fa-arrow-left" onclick="app.closeLayer('layer-settings')" style="padding:10px;"></i>
            聊天设置
        </div>
        <div class="layer-body">
            <div style="margin-bottom:20px;">
                <label>上下文携带条数 (<span id="ctx-count-display">20</span>)</label>
                <!-- 修复拉杆响应问题：oninput 直接绑定 app 方法 -->
                <input type="range" id="ctx-slider" min="5" max="100" value="20" style="width:100%; margin-top:10px;" oninput="app.updateSettings(this.value)">
                <p style="font-size:12px; color:#666; margin-top:5px;">当前设定：AI 回复时将读取最近 <span id="ctx-count-debug">20</span> 条记录。</p>
            </div>
        </div>
    </div>

    <!-- 长按菜单 -->
    <div class="ctx-menu" id="ctx-menu">
        <div class="ctx-opt" onclick="app.ctxAction('edit')">编辑内容</div>
        <div class="ctx-opt" onclick="app.ctxAction('regen')">刷新回复</div>
        <div class="ctx-opt" style="color:var(--danger)" onclick="app.ctxAction('delete')">删除</div>
    </div>

    <!-- 隐形文件上传 -->
    <input type="file" id="file-input" accept="image/*">

    <script>
        const app = {
            // === 状态管理 ===
            apiKey: localStorage.getItem('gcli_api_key') || '',
            apiUrl: localStorage.getItem('gcli_api_url') || '',
            model: localStorage.getItem('gcli_model_name') || 'gpt-3.5-turbo',
            
            chatHistory: [],
            memories: JSON.parse(localStorage.getItem('ai_memories') || '[]'),
            stickers: JSON.parse(localStorage.getItem('custom_stickers') || '[]'),
            contextLimit: parseInt(localStorage.getItem('chat_context_limit') || 20),
            
            autoReplyTimer: null,
            uploadTarget: '', // 'bg' or 'sticker'
            currentUser: localStorage.getItem('current_chat_partner') || 'My AI',
            currentPrompt: '', 

            // === 初始化 ===
            init: function() {
                // 1. 加载角色 Prompt
                const contacts = JSON.parse(localStorage.getItem('gcli_contacts') || '[]');
                const char = contacts.find(c => c.nickname === this.currentUser);
                if(char) {
                    this.currentPrompt = char.prompt || "你是一个体贴的AI助手。";
                    document.getElementById('header-name').innerText = char.nickname;
                }
                
                // 2. 恢复背景
                const bg = localStorage.getItem('chat_bg');
                if(bg) document.body.style.backgroundImage = `url('${bg}')`;

                // 3. 恢复设置数值显示
                document.getElementById('ctx-count-display').innerText = this.contextLimit;
                document.getElementById('ctx-count-debug').innerText = this.contextLimit;
                document.getElementById('ctx-slider').value = this.contextLimit;

                // 4. 渲染贴图
                this.renderStickers();

                // 5. 事件绑定
                document.getElementById('file-input').addEventListener('change', this.handleFileSelect.bind(this));
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('.menu-btn') && !e.target.closest('.dropdown')) {
                        document.getElementById('main-menu').style.display='none';
                    }
                    if(!e.target.closest('.ctx-menu')) {
                        document.getElementById('ctx-menu').style.display='none';
                    }
                });

                // 6. 检查 API
                if(!this.apiKey) {
                    this.addBubble('ai', "警告：未检测到 API Key。请在设置页面配置，否则我无法回复。");
                }
            },

            // === 核心：API 调用与状态更新 ===
            toggleHeaderStatus: function(status) {
                const el = document.getElementById('header-status');
                if (status === 'typing') {
                    el.innerHTML = "对方正在输入...";
                    el.classList.add('status-typing');
                } else {
                    el.innerHTML = '<div class="status-dot"></div>在线';
                    el.classList.remove('status-typing');
                }
            },

            callLLM: async function() {
                // 1. UI 状态：闪烁标题 + 底部气泡
                this.toggleHeaderStatus('typing');
                const indicator = document.getElementById('typing-indicator');
                const chatBox = document.getElementById('chat-container');
                indicator.style.display = 'flex';
                chatBox.appendChild(indicator); // 移到底部
                chatBox.scrollTop = chatBox.scrollHeight;

                // 2. 准备数据
                // 根据拉杆设定截取历史
                const historySlice = this.chatHistory.slice(-this.contextLimit);
                const messages = [
                    { role: "system", content: `${this.currentPrompt}\n\n[重要指令]\n1. 请模仿短信聊天，口语化。\n2. 不要使用句号作为结尾。\n3. 如果内容较长，请根据逻辑拆分成多条简短的句子（用标点分隔）。` },
                    ...historySlice
                ];

                if(!this.apiKey) {
                    setTimeout(() => {
                        this.toggleHeaderStatus('online');
                        indicator.style.display = 'none';
                        this.addBubble('ai', "错误：请先设置 API Key。");
                    }, 500);
                    return;
                }

                try {
                    const res = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
                        body: JSON.stringify({ model: this.model, messages: messages })
                    });
                    
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    const reply = data.choices[0].message.content;
                    
                    // 记录完整回复到历史
                    this.chatHistory.push({ role: "assistant", content: reply });

                    // 3. 处理拆分显示
                    this.toggleHeaderStatus('online'); // 获取到数据就停止标题闪烁
                    indicator.style.display = 'none';
                    
                    this.processSplitMessage(reply);

                } catch(e) {
                    this.toggleHeaderStatus('online');
                    indicator.style.display = 'none';
                    this.addBubble('ai', `[连接失败] ${e.message}`);
                }
            },

            processSplitMessage: function(text) {
                // 简单的拆分逻辑：换行、感叹号、问号，但保留分隔符
                // 然后去除句号
                const parts = text.split(/([！!？?\n])/).filter(p => p.trim());
                
                // 合并逻辑：标点归位
                let cleanParts = [];
                let buffer = "";
                
                parts.forEach(p => {
                    if(p.match(/[！!？?\n]/)) {
                        buffer += p;
                        cleanParts.push(buffer);
                        buffer = "";
                    } else {
                        if(buffer) cleanParts.push(buffer);
                        buffer = p;
                    }
                });
                if(buffer) cleanParts.push(buffer);

                // 如果拆分失败（比如只有句号），就整句发
                if(cleanParts.length === 0) cleanParts = [text];

                let delay = 0;
                cleanParts.forEach(part => {
                    let cleanText = part.replace(/[。\.]$/g, ""); // 去除结尾句号
                    if(!cleanText) return;

                    setTimeout(() => {
                        // 模拟每一条发送前的短暂“正在输入”
                        const indicator = document.getElementById('typing-indicator');
                        indicator.style.display = 'flex';
                        document.getElementById('chat-container').appendChild(indicator);
                        document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;

                        setTimeout(() => {
                            indicator.style.display = 'none';
                            this.addBubble('ai', cleanText);
                        }, 400 + Math.random() * 400); // 随机打字耗时

                    }, delay);
                    
                    delay += (cleanText.length * 50) + 1000; // 阅读间隔
                });
            },

            // === 消息发送 ===
            sendMessage: function() {
                const input = document.getElementById('input-text');
                const txt = input.value.trim();
                if(!txt) return;
                
                this.addBubble('me', txt);
                this.chatHistory.push({ role: "user", content: txt });
                
                input.value = '';
                input.focus();
                
                this.callLLM();
            },

            triggerAiReply: function() {
                // 强制 AI 回复（即使没有新输入，仅基于历史）
                this.callLLM();
            },

            addBubble: function(role, content, isImg=false) {
                const box = document.getElementById('chat-container');
                const row = document.createElement('div');
                row.className = `msg-row ${role}`;
                
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                
                if(isImg) {
                    bubble.style.padding = 0;
                    bubble.style.background = 'transparent';
                    bubble.innerHTML = `<img src="${content}" class="sticker">`;
                } else {
                    bubble.innerText = content;
                }
                
                this.bindLongPress(bubble);
                row.appendChild(bubble);
                
                const indicator = document.getElementById('typing-indicator');
                box.insertBefore(row, indicator);
                box.scrollTop = box.scrollHeight;
                return bubble;
            },

            // === 上传功能 (背景 & 贴图) ===
            openUploadModal: function(target) {
                this.uploadTarget = target;
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('upload-modal').style.display = 'flex';
                document.getElementById('upload-title').innerText = target === 'bg' ? "设置聊天背景" : "添加表情包";
            },

            handleUploadChoice: function(type) {
                document.getElementById('upload-modal').style.display = 'none';
                if(type === 'local') {
                    document.getElementById('file-input').click();
                } else {
                    const url = prompt("请输入图片 URL:");
                    if(url) this.applyUpload(url);
                }
            },

            handleFileSelect: function(e) {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    this.applyUpload(evt.target.result);
                };
                reader.readAsDataURL(file);
                e.target.value = ''; // 重置 input
            },

            applyUpload: function(src) {
                if(this.uploadTarget === 'bg') {
                    document.body.style.backgroundImage = `url('${src}')`;
                    localStorage.setItem('chat_bg', src);
                } else {
                    this.stickers.push(src);
                    localStorage.setItem('custom_stickers', JSON.stringify(this.stickers));
                    this.renderStickers();
                }
            },

            renderStickers: function() {
                const grid = document.getElementById('sticker-grid');
                grid.innerHTML = '';
                // 添加按钮
                const add = document.createElement('div');
                add.className = 'add-btn';
                add.innerText = '+';
                add.onclick = () => this.openUploadModal('sticker');
                grid.appendChild(add);
                // 列表
                this.stickers.forEach(src => {
                    const img = document.createElement('img');
                    img.className = 'sticker-item';
                    img.src = src;
                    img.onclick = () => {
                        this.addBubble('me', src, true);
                        this.chatHistory.push({role:'user', content: '[发送了一张表情包]'});
                        this.callLLM();
                    };
                    grid.appendChild(img);
                });
            },
            
            toggleStickers: function() {
                document.getElementById('sticker-panel').classList.toggle('open');
            },

            // === 记忆与大脑 ===
            makeMemoryNote: function() {
                document.getElementById('main-menu').style.display = 'none';
                // 1. 发送提示
                this.addBubble('ai', "好的，正在整理刚才的对话笔记...");
                
                // 2. 真实逻辑：截取最近对话，生成摘要 (这里简单模拟生成过程，实际应该调用API summary)
                setTimeout(() => {
                    const summary = `【记忆笔记 ${new Date().toLocaleTimeString()}】\n最近讨论了：${this.chatHistory.slice(-3).map(m=>m.content).join('；')}`;
                    this.memories.unshift({ id: Date.now(), date: new Date().toLocaleString(), content: summary });
                    localStorage.setItem('ai_memories', JSON.stringify(this.memories));
                    
                    this.addBubble('ai', "整理完成，已存入大脑。");
                }, 1000);
            },

            openBrain: function() {
                document.getElementById('main-menu').style.display = 'none';
                const list = document.getElementById('brain-list');
                list.innerHTML = '';
                
                this.memories.forEach((mem, index) => {
                    const card = document.createElement('div');
                    card.style.background = '#2c2c2e';
                    card.style.padding = '15px';
                    card.style.marginBottom = '10px';
                    card.style.borderRadius = '8px';
                    
                    card.innerHTML = `
                        <div style="color:#666; font-size:12px; margin-bottom:5px; display:flex; justify-content:space-between;">
                            ${mem.date}
                            <span style="color:var(--danger); cursor:pointer;" onclick="app.deleteMemory(${index})">删除</span>
                        </div>
                        <div contenteditable="true" 
                             style="color:#ddd; font-size:14px; outline:none; border-bottom:1px dashed #444; padding-bottom:5px;"
                             onblur="app.updateMemory(${index}, this.innerText)">${mem.content}</div>
                    `;
                    list.appendChild(card);
                });
                
                document.getElementById('layer-brain').style.display = 'flex';
            },

            updateMemory: function(index, text) {
                this.memories[index].content = text;
                localStorage.setItem('ai_memories', JSON.stringify(this.memories));
            },

            deleteMemory: function(index) {
                if(confirm("确定删除这条记忆吗？")) {
                    this.memories.splice(index, 1);
                    localStorage.setItem('ai_memories', JSON.stringify(this.memories));
                    this.openBrain(); // 刷新
                }
            },

            batchSummary: function() {
                alert("正在调用 API 对大脑记忆进行压缩总结...");
                // 模拟 API 延迟
                setTimeout(() => {
                    const newSummary = "【批量总结】用户近期非常关心 AI 的开发进度。";
                    this.memories.unshift({ id: Date.now(), date: new Date().toLocaleString(), content: newSummary });
                    localStorage.setItem('ai_memories', JSON.stringify(this.memories));
                    this.openBrain(); // 刷新列表
                }, 1500);
            },

            // === 设置相关 ===
            openSettings: function() {
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('layer-settings').style.display = 'flex';
            },

            updateSettings: function(val) {
                this.contextLimit = parseInt(val);
                localStorage.setItem('chat_context_limit', val);
                document.getElementById('ctx-count-display').innerText = val;
                document.getElementById('ctx-count-debug').innerText = val;
            },

            toggleAutoReply: function() {
                const btn = document.getElementById('ar-toggle');
                if(btn.classList.contains('fa-toggle-off')) {
                    // 开启逻辑：请求通知权限
                    Notification.requestPermission().then(perm => {
                        if(perm === 'granted') {
                            btn.className = 'fa-solid fa-toggle-on';
                            btn.style.color = '#32d74b';
                            
                            alert("主动回复已开启！AI 将每 300秒 检测一次。如果需要测试，请保持页面打开等待。");
                            
                            this.autoReplyTimer = setInterval(() => {
                                // 300秒触发一次
                                // 逻辑：如果最后一条消息是自己的，或者是很久以前的，就主动说话
                                const lastMsg = this.chatHistory[this.chatHistory.length-1];
                                if(!lastMsg || lastMsg.role === 'assistant') {
                                    new Notification("AI 助手", { body: "想你了，在干嘛呢？" });
                                    this.addBubble('ai', "（主动消息）想你了，在干嘛呢？");
                                    // 这里可以改成调用 API 生成开场白
                                }
                            }, 300000); 

                        } else {
                            alert("开启失败：需要浏览器通知权限。");
                        }
                    });
                } else {
                    // 关闭
                    btn.className = 'fa-solid fa-toggle-off';
                    btn.style.color = 'inherit';
                    clearInterval(this.autoReplyTimer);
                    alert("主动回复已关闭。");
                }
            },

            // === 长按菜单 ===
            bindLongPress: function(el) {
                let timer;
                const start = (e) => {
                    // 只有 AI 的消息才允许长按菜单？或者都允许
                    timer = setTimeout(() => {
                        this.targetBubble = el;
                        const menu = document.getElementById('ctx-menu');
                        const touch = e.touches ? e.touches[0] : e;
                        
                        // 计算位置防止溢出
                        let x = touch.clientX;
                        let y = touch.clientY;
                        if(x + 160 > window.innerWidth) x = window.innerWidth - 170;
                        
                        menu.style.left = x + 'px';
                        menu.style.top = y + 'px';
                        menu.style.display = 'block';
                    }, 600);
                };
                const end = () => clearTimeout(timer);
                
                el.addEventListener('mousedown', start);
                el.addEventListener('touchstart', start);
                el.addEventListener('mouseup', end);
                el.addEventListener('touchend', end);
            },

            ctxAction: function(action) {
                document.getElementById('ctx-menu').style.display = 'none';
                if(!this.targetBubble) return;
                const row = this.targetBubble.closest('.msg-row');

                if(action === 'delete') {
                    row.remove();
                    // 这里没删 chatHistory 里的，因为很难对应 index，仅做 UI 删除
                } else if(action === 'edit') {
                    const newTxt = prompt("编辑内容", this.targetBubble.innerText);
                    if(newTxt) this.targetBubble.innerText = newTxt;
                } else if(action === 'regen') {
                    row.remove();
                    this.chatHistory.pop(); // 移除最后一条记忆
                    this.callLLM(); // 重新生成
                }
            },

            closeLayer: function(id) {
                document.getElementById(id).style.display = 'none';
            }
        };

        window.onload = function() {
            app.init();
        };

    </script>
</body>
</html>
