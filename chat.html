<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --header-bg: rgba(20, 20, 20, 0.95);
            --bubble-user: #0a84ff;
            --bubble-ai: #262628;
            --text-color: #ffffff;
            --gray-text: #8e8e93;
            --border-color: #38383a;
            --menu-bg: #1c1c1e;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh; /* 强制满屏 */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 禁止body滚动 */
        }

        /* --- 顶部导航 --- */
        .header {
            height: 50px;
            flex-shrink: 0; /* 防止被压缩 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            user-select: none;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--bubble-user);
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            text-align: center;
        }

        .chat-info {
            text-align: center;
            cursor: pointer;
            flex: 1;
        }
        .chat-info:active { opacity: 0.7; }

        .chat-name { font-weight: 600; font-size: 16px; }
        .chat-status { font-size: 10px; color: var(--gray-text); display: flex; align-items: center; justify-content: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; background-color: #30d158; border-radius: 50%; }

        /* --- 弹窗菜单 (通用样式) --- */
        .popup-menu {
            position: absolute;
            background: var(--menu-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 200px;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 200;
            overflow: hidden;
        }
        .popup-menu.show { display: flex; }
        
        /* 角色菜单位置 */
        #char-menu { top: 60px; left: 50%; transform: translateX(-50%); }
        /* 右上角功能菜单位置 */
        #function-menu { top: 60px; right: 10px; }

        .menu-item {
            padding: 14px 15px;
            border-bottom: 1px solid #2c2c2e;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #3a3a3c; }

        /* --- 聊天区域 --- */
        #chat-container {
            flex: 1; /* 占据剩余空间 */
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }
        
        .message img {
            max-width: 100%;
            border-radius: 10px;
            display: block;
        }

        .msg-user { align-self: flex-end; background-color: var(--bubble-user); color: white; border-bottom-right-radius: 4px; }
        .msg-ai { align-self: flex-start; background-color: var(--bubble-ai); color: white; border-bottom-left-radius: 4px; }

        .system-toast {
            align-self: center;
            background: rgba(255, 69, 58, 0.2);
            color: #ff453a;
            border: 1px solid rgba(255, 69, 58, 0.5);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px 0;
        }

        /* --- 底部区域 --- */
        .bottom-container {
            flex-shrink: 0; /* 禁止压缩 */
            background: rgba(20, 20, 20, 0.98);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .input-area {
            padding: 10px 10px 10px 10px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .icon-btn {
            color: var(--bubble-user);
            font-size: 22px;
            padding: 8px;
            cursor: pointer;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 麦克风特效 */
        #trigger-ai-btn { color: var(--gray-text); transition: color 0.3s; }
        #trigger-ai-btn.active { color: #30d158; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .input-box-wrapper {
            flex: 1;
            background: #1c1c1e;
            border-radius: 20px;
            padding: 8px 12px;
            border: 1px solid #333;
            min-height: 36px;
            display: flex;
            align-items: center;
        }

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            resize: none;
            max-height: 100px;
            outline: none;
            font-family: inherit;
            padding: 0;
            margin: 0;
            line-height: 20px;
        }

        /* --- 表情/贴纸面板 --- */
        #sticker-panel {
            height: 0;
            transition: height 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow-y: auto;
            background: #151517;
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4列 */
            gap: 10px;
            padding: 0 10px;
        }
        #sticker-panel.open { height: 200px; padding: 15px 10px; border-top: 1px solid #333; }

        .sticker-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }
        .sticker-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .add-sticker-btn {
            font-size: 30px;
            color: #555;
            border: 2px dashed #444;
            background: transparent;
        }

        /* 正在输入提示 */
        .typing-indicator {
            align-self: flex-start;
            background: var(--bubble-ai);
            padding: 10px 14px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            display: none;
            gap: 4px;
            margin-bottom: 10px;
        }
        .dot { width: 6px; height: 6px; background: #8e8e93; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* 隐藏的文件上传input */
        #file-input { display: none; }

    </style>
</head>
<body>

    <!-- 顶部 -->
    <div class="header">
        <button class="header-btn" onclick="window.location.href='index.html'">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        
        <!-- 长按这里切换角色 -->
        <div class="chat-info" id="header-area">
            <div class="chat-name" id="header-name">AI 助手</div>
            <div class="chat-status" id="header-status">
                <div class="status-dot"></div> 在线
            </div>
        </div>
        
        <button class="header-btn" onclick="toggleFunctionMenu()">
            <i class="fa-solid fa-bars"></i>
        </button>
    </div>

    <!-- 角色切换菜单 (数据来自 contacts) -->
    <div class="popup-menu" id="char-menu">
        <!-- 动态生成 -->
    </div>

    <!-- 右上角功能菜单 -->
    <div class="popup-menu" id="function-menu">
        <div class="menu-item" onclick="alert('功能开发中: 主动回覆')">主动回覆</div>
        <div class="menu-item" onclick="alert('功能开发中: 记忆笔记')">记忆笔记</div>
        <div class="menu-item" onclick="alert('功能开发中: 大脑回忆')">大脑回忆</div>
        <div class="menu-item" onclick="alert('功能开发中: 聊天设定')">聊天设定</div>
    </div>

    <!-- 聊天内容 -->
    <div id="chat-container"></div>

    <!-- 正在输入动画 -->
    <div class="typing-indicator" id="typing-indicator">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>

    <!-- 底部总容器 -->
    <div class="bottom-container">
        <!-- 输入行 -->
        <div class="input-area">
            <!-- 触发 AI 回复 -->
            <button class="icon-btn" id="trigger-ai-btn" onclick="triggerAIResponse()">
                <i class="fa-solid fa-microphone"></i>
            </button>

            <div class="input-box-wrapper">
                <textarea id="msg-input" rows="1" placeholder="发消息..." oninput="autoResize(this)"></textarea>
            </div>

            <!-- 表情开关 -->
            <button class="icon-btn" onclick="toggleStickerPanel()">
                <i class="fa-regular fa-face-smile"></i>
            </button>
            
            <!-- 发送按钮 -->
            <button class="icon-btn" id="send-btn" onclick="sendUserMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>

        <!-- 表情包面板 -->
        <div id="sticker-panel">
            <!-- 动态生成表情 -->
        </div>
    </div>

    <!-- 隐藏的文件上传控件 -->
    <input type="file" id="file-input" accept="image/*">

    <script>
        // === 全局变量 ===
        const chatBox = document.getElementById('chat-container');
        const inputField = document.getElementById('msg-input');
        const typingInd = document.getElementById('typing-indicator');
        const statusText = document.getElementById('header-status');
        const aiBtn = document.getElementById('trigger-ai-btn');
        const stickerPanel = document.getElementById('sticker-panel');
        
        let currentName = localStorage.getItem('chat_character') || 'AI 助手';
        let history = JSON.parse(localStorage.getItem('chat_history')) || [];
        // 读取保存的表情包，格式: ['data:image...', 'http://...']
        let savedStickers = JSON.parse(localStorage.getItem('my_stickers')) || [];

        // === 1. 初始化 ===
        window.onload = function() {
            document.getElementById('header-name').innerText = currentName;
            renderHistory();
            renderStickers();
            initLongPress();
        };

        // === 2. 渲染历史记录 ===
        function renderHistory() {
            chatBox.innerHTML = ''; 
            history.forEach(msg => {
                // 判断内容是否以 [IMG] 开头，作为图片标识
                if (msg.content.startsWith('[IMG]')) {
                    appendImage(msg.role, msg.content.replace('[IMG]', ''), false);
                } else {
                    appendBubble(msg.role, msg.content, false);
                }
            });
            scrollToBottom();
        }

        function appendBubble(role, text, save = true) {
            if(role === 'system_error') {
                const div = document.createElement('div');
                div.className = 'system-toast';
                div.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> ${text}`;
                div.onclick = function(){this.remove()};
                chatBox.insertBefore(div, typingInd);
                return;
            }

            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'msg-user' : 'msg-ai'}`;
            div.innerText = text;
            chatBox.insertBefore(div, typingInd);
            
            if (save) saveMsg(role, text);
            scrollToBottom();
        }

        function appendImage(role, src, save = true) {
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'msg-user' : 'msg-ai'}`;
            // 样式调整，图片不需要padding背景色
            div.style.background = 'transparent';
            div.style.padding = '0';
            
            const img = document.createElement('img');
            img.src = src;
            div.appendChild(img);
            
            chatBox.insertBefore(div, typingInd);
            
            if (save) saveMsg(role, '[IMG]' + src);
            setTimeout(scrollToBottom, 100); // 等图片加载一点再滚动
        }

        function saveMsg(role, content) {
            history.push({ role, content });
            localStorage.setItem('chat_history', JSON.stringify(history));
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // === 3. 发送消息逻辑 ===
        function sendUserMessage() {
            const text = inputField.value.trim();
            if (!text) return;
            appendBubble('user', text);
            inputField.value = '';
            inputField.style.height = 'auto'; // 重置高度
        }

        // === 4. 触发 AI 回复 (逻辑保持不变) ===
        async function triggerAIResponse() {
            aiBtn.classList.add('active');
            statusText.innerHTML = "对方正在输入...";
            typingInd.style.display = 'flex';
            scrollToBottom();

            const apiKey = localStorage.getItem('gcli_api_key');
            let apiUrl = localStorage.getItem('gcli_api_url');
            const model = localStorage.getItem('gcli_model_name') || 'gpt-3.5-turbo';
            const sysPrompt = localStorage.getItem('gcli_system_prompt') || "你是一个有用的助手。";

            if (!apiKey || !apiUrl) {
                endAIState();
                appendBubble('system_error', "请先在设置中配置 API Key", false);
                return;
            }
            if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
            if (!apiUrl.endsWith('/chat/completions')) {
                 if (apiUrl.endsWith('/v1')) apiUrl += '/chat/completions';
                 else apiUrl += '/v1/chat/completions';
            }

            try {
                // 过滤掉图片消息传给AI，防止报错（除非用的是gpt-4-vision，这里简化处理只发文本）
                const textHistory = history.filter(m => !m.content.startsWith('[IMG]'));
                
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "system", content: sysPrompt }, ...textHistory]
                    })
                });

                if (!res.ok) throw new Error("API请求失败");
                const data = await res.json();
                const reply = data.choices[0].message.content;
                appendBubble('assistant', reply);

            } catch (error) {
                appendBubble('system_error', error.message, false);
            } finally {
                endAIState();
            }
        }

        function endAIState() {
            aiBtn.classList.remove('active');
            statusText.innerHTML = '<div class="status-dot"></div> 在线';
            typingInd.style.display = 'none';
        }

        // === 5. 表情包系统 (核心修复) ===
        function toggleStickerPanel() {
            stickerPanel.classList.toggle('open');
        }

        function renderStickers() {
            stickerPanel.innerHTML = '';
            
            // 添加 "+" 按钮
            const addBtn = document.createElement('div');
            addBtn.className = 'sticker-item add-sticker-btn';
            addBtn.innerHTML = '+';
            addBtn.onclick = handleAddSticker;
            stickerPanel.appendChild(addBtn);

            // 渲染保存的表情
            savedStickers.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'sticker-item';
                
                const img = document.createElement('img');
                img.src = src;
                div.appendChild(img);

                // 点击发送
                div.onclick = () => {
                    appendImage('user', src);
                    toggleStickerPanel(); // 发送后关闭面板
                };

                // 长按删除
                let pressTimer;
                div.addEventListener('touchstart', () => {
                    pressTimer = setTimeout(() => {
                        if(confirm('删除这个表情包？')) {
                            savedStickers.splice(index, 1);
                            localStorage.setItem('my_stickers', JSON.stringify(savedStickers));
                            renderStickers();
                        }
                    }, 800);
                });
                div.addEventListener('touchend', () => clearTimeout(pressTimer));
                div.addEventListener('touchmove', () => clearTimeout(pressTimer));

                stickerPanel.appendChild(div);
            });
        }

        function handleAddSticker() {
            // 弹出选择：链接还是本地
            // 简单起见，这里做一个简单的逻辑：
            // 优先尝试本地上传，如果用户取消或不支持，则不弹URL框，避免交互太复杂。
            // 我们可以用一个 confirm 模拟选择 (虽然丑点，但无需额外HTML)
            // 或者直接触发 file input，失败了再说。
            
            // 这里我们做得更人性化：触发文件选择
            document.getElementById('file-input').click();
        }

        // 监听文件选择
        document.getElementById('file-input').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                const base64 = evt.target.result;
                // 限制大小，localStorage 只有5MB左右
                if (base64.length > 500000) { // 约500KB
                    alert('图片太大了，请选择小一点的图');
                    return;
                }
                savedStickers.push(base64);
                localStorage.setItem('my_stickers', JSON.stringify(savedStickers));
                renderStickers();
            };
            reader.readAsDataURL(file);
        };

        // 如果用户想输入URL（备选方案，暂时未绑定UI，如果需要可以改为confirm弹窗）

        // === 6. 长按切换角色 (连接 contacts) ===
        function initLongPress() {
            const header = document.getElementById('header-area');
            let timer;

            header.addEventListener('touchstart', () => {
                timer = setTimeout(showContactMenu, 800); // 800ms 长按
            });
            
            const clear = () => clearTimeout(timer);
            header.addEventListener('touchend', clear);
            header.addEventListener('touchmove', clear);
            
            // PC 端适配 (mousedown)
            header.addEventListener('mousedown', () => {
                timer = setTimeout(showContactMenu, 800);
            });
            header.addEventListener('mouseup', clear);
        }

        function showContactMenu() {
            const menu = document.getElementById('char-menu');
            menu.innerHTML = '';
            
            // 模拟读取 contacts (如果你有 contacts.html 页面，应该共享一个 localStorage key 比如 'contacts_list')
            // 这里假设 key 为 'contacts_list'，结构为 [{name: '名字', info: '...'}, ...]
            // 如果为空，提供默认
            let contacts = JSON.parse(localStorage.getItem('contacts_list')) || [];
            if (contacts.length === 0) {
                contacts = [{name: 'AI 助手'}, {name: '示例角色'}];
            }

            contacts.forEach(c => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerText = c.name;
                div.onclick = () => {
                    currentName = c.name;
                    document.getElementById('header-name').innerText = c.name;
                    localStorage.setItem('chat_character', c.name);
                    menu.classList.remove('show');
                };
                menu.appendChild(div);
            });

            menu.classList.add('show');
        }

        // === 7. 右上角菜单 ===
        function toggleFunctionMenu() {
            const menu = document.getElementById('function-menu');
            menu.classList.toggle('show');
        }

        // 点击空白关闭菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header') && !e.target.closest('.popup-menu')) {
                document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show'));
            }
        });

        // 文本框自适应
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

    </script>
</body>
</html>
