<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === 核心变量与夜间模式 === */
        :root {
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --bubble-me: #0084ff; /* Messenger Blue */
            --bubble-ai: #2c2c2c;
            --text-main: #e4e6eb;
            --text-sub: #b0b3b8;
            --accent: #00d2ff;
            --danger: #ff4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; width: 100%; height: 100dvh;
            background-color: var(--bg-dark);
            background-size: cover; background-position: center;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* === 顶部导航 === */
        .chat-header {
            height: 60px; padding: 0 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(18, 18, 18, 0.85); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: absolute; top: 0; width: 100%; z-index: 50;
        }
        .header-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .back-icon { font-size: 20px; padding: 10px; cursor: pointer; }
        .partner-info { display: flex; flex-direction: column; }
        .partner-name { font-weight: 600; font-size: 17px; }
        .status { font-size: 12px; color: var(--text-sub); display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #31a24c; border-radius: 50%; }

        /* === 聊天区域 === */
        .chat-viewport {
            flex: 1; overflow-y: auto; padding: 70px 15px 80px 15px;
            display: flex; flex-direction: column; gap: 8px;
            scroll-behavior: smooth;
        }

        .msg-row { display: flex; width: 100%; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-row.me { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; }

        .bubble {
            max-width: 75%; padding: 10px 15px;
            font-size: 16px; line-height: 1.4; word-wrap: break-word;
            position: relative;
        }
        
        /* 拟人化气泡圆角逻辑 */
        .me .bubble { 
            background: var(--bubble-me); color: white; 
            border-radius: 18px 18px 4px 18px; 
        }
        .ai .bubble { 
            background: var(--bubble-ai); color: var(--text-main); 
            border-radius: 18px 18px 18px 4px; 
            border: 1px solid rgba(255,255,255,0.05);
        }

        .sticker-img { max-width: 140px; border-radius: 12px; display: block; }

        /* === 正在输入指示器 === */
        .typing-bubble {
            background: var(--bubble-ai); padding: 12px 15px; border-radius: 18px;
            width: fit-content; margin-bottom: 10px; display: none; align-items: center; gap: 4px;
        }
        .dot { width: 6px; height: 6px; background: #b0b3b8; border-radius: 50%; animation: bounce 1.2s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === 底部输入区域 === */
        .input-wrapper {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 8px 10px; z-index: 50;
            display: flex; flex-direction: column;
        }
        .toolbar { display: flex; align-items: flex-end; gap: 10px; padding-bottom: 5px; }
        
        #msg-input {
            flex: 1; background: #2c2c2c; border: none; border-radius: 20px;
            padding: 10px 15px; color: white; font-size: 16px; max-height: 100px;
            resize: none; overflow-y: auto; line-height: 1.4;
        }

        .tool-btn {
            width: 40px; height: 40px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: var(--accent); cursor: pointer;
            border-radius: 50%; transition: 0.2s;
        }
        .tool-btn:active { background: rgba(255,255,255,0.1); }
        .send-btn { color: #31a24c; font-size: 22px; }

        /* === 表情/贴图面板 === */
        .emoji-drawer {
            height: 0; overflow: hidden; transition: height 0.3s ease;
            background: var(--bg-dark);
        }
        .emoji-drawer.open { height: 220px; border-top: 1px solid #333; }
        
        .sticker-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px;
            overflow-y: auto; height: 100%;
        }
        .add-sticker {
            aspect-ratio: 1; border: 2px dashed #444; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #666; cursor: pointer;
        }
        .sticker-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; }

        /* === 右上角下拉菜单 === */
        .menu-dropdown {
            position: absolute; top: 60px; right: 10px;
            background: rgba(40,40,40,0.95); backdrop-filter: blur(10px);
            border-radius: 12px; width: 220px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            display: none; flex-direction: column; overflow: hidden; z-index: 100;
        }
        .menu-option {
            padding: 15px; color: var(--text-main); font-size: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px;
            cursor: pointer;
        }
        .menu-option:active { background: rgba(255,255,255,0.1); }
        .menu-toggle { margin-left: auto; font-size: 22px; }

        /* === 全屏模态框 (大脑/设置等) === */
        .fs-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 200; display: none; flex-direction: column;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .fs-header {
            padding: 15px; background: var(--panel-bg); border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; font-size: 18px; font-weight: bold;
        }
        .fs-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* 记忆列表样式 */
        .memory-item {
            background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border-left: 3px solid var(--accent);
        }
        .mem-date { font-size: 12px; color: var(--text-sub); margin-bottom: 5px; display: flex; justify-content: space-between; }
        .mem-text { font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
        .mem-actions { margin-top: 10px; display: flex; gap: 15px; justify-content: flex-end; font-size: 12px; }
        .action-link { color: var(--accent); cursor: pointer; }

        /* === 通用上传/输入弹窗 === */
        .dialog-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 300; display: none;
            justify-content: center; align-items: center;
        }
        .dialog-box {
            background: #252525; width: 85%; padding: 20px; border-radius: 15px;
            text-align: center; border: 1px solid #444;
        }
        .dialog-input {
            width: 100%; padding: 10px; margin: 15px 0; background: #333;
            border: 1px solid #555; color: white; border-radius: 8px;
        }
        .dialog-btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .dialog-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; }
        .btn-confirm { background: var(--accent); color: #000; font-weight: bold; }
        .btn-cancel { background: #444; color: white; }

        /* === 长按菜单 === */
        .context-popup {
            position: fixed; background: #252525; border-radius: 8px; z-index: 400;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; border: 1px solid #444; min-width: 120px;
        }
        .ctx-item { padding: 12px 15px; color: white; border-bottom: 1px solid #333; font-size: 14px; }
        .ctx-item:last-child { border-bottom: none; }
        .ctx-item:active { background: #333; }

        /* === 隐藏的文件输入 === */
        .hidden-file { display: none; }

    </style>
</head>
<body>

    <!-- 顶部 -->
    <div class="chat-header">
        <div class="header-left">
            <i class="fa-solid fa-chevron-left back-icon" onclick="window.location.href='./index.html'"></i>
            <div class="partner-info">
                <span class="partner-name" id="partner-name">Loading...</span>
                <span class="status"><div class="status-dot"></div>在线</span>
            </div>
        </div>
        <div class="back-icon" onclick="toggleMenu()">
            <i class="fa-solid fa-ellipsis-vertical"></i>
        </div>
    </div>

    <!-- 菜单 -->
    <div class="menu-dropdown" id="main-menu">
        <div class="menu-option" onclick="openUploadDialog('bg')">
            <i class="fa-solid fa-image"></i> 聊天背景
        </div>
        <div class="menu-option" onclick="toggleAutoReply()">
            <i class="fa-solid fa-clock"></i> 主动回复
            <div class="menu-toggle">
                <i class="fa-solid fa-toggle-off" id="ar-icon" style="color:#666;"></i>
            </div>
        </div>
        <div class="menu-option" onclick="triggerMemoryNote()">
            <i class="fa-solid fa-pen-nib"></i> 记忆笔记
        </div>
        <div class="menu-option" onclick="openBrain()">
            <i class="fa-solid fa-brain"></i> 大脑与总结
        </div>
        <div class="menu-option" onclick="openSettings()">
            <i class="fa-solid fa-sliders"></i> 聊天设置
        </div>
    </div>

    <!-- 聊天视窗 -->
    <div class="chat-viewport" id="chat-box">
        <!-- 动态消息 -->
        <div class="typing-bubble" id="typing-bubble">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <!-- 输入区 -->
    <div class="input-wrapper">
        <div class="toolbar">
            <div class="tool-btn" onclick="toggleEmoji()"><i class="fa-regular fa-face-smile"></i></div>
            <textarea id="msg-input" rows="1" placeholder="发消息..."></textarea>
            <div class="tool-btn" onclick="triggerAI()"><i class="fa-solid fa-microphone"></i></div>
            <div class="tool-btn send-btn" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
        
        <div class="emoji-drawer" id="emoji-drawer">
            <div class="sticker-grid" id="sticker-grid">
                <!-- 由JS生成 -->
            </div>
        </div>
    </div>

    <!-- === 大脑界面 === -->
    <div class="fs-modal" id="modal-brain">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal('modal-brain')"></i>
            大脑记忆库
            <span style="font-size:14px; color:var(--accent);" onclick="openBatchSummary()">批量总结</span>
        </div>
        <div class="fs-content" id="brain-list"></div>
    </div>

    <!-- === 批量总结日期选择 === -->
    <div class="dialog-overlay" id="dialog-summary">
        <div class="dialog-box">
            <h3>选择总结日期</h3>
            <div style="text-align:left; margin:10px 0; color:#ccc; font-size:14px;">开始日期：</div>
            <input type="date" id="sum-start" class="dialog-input" style="margin:0;">
            <div style="text-align:left; margin:10px 0; color:#ccc; font-size:14px;">结束日期：</div>
            <input type="date" id="sum-end" class="dialog-input" style="margin:0;">
            <div class="dialog-btn-row">
                <button class="dialog-btn btn-cancel" onclick="closeDialog('dialog-summary')">取消</button>
                <button class="dialog-btn btn-confirm" onclick="executeSummary()">开始总结</button>
            </div>
        </div>
    </div>

    <!-- === 上传/输入弹窗 (背景/贴图) === -->
    <div class="dialog-overlay" id="dialog-upload">
        <div class="dialog-box">
            <h3 id="upload-title">添加项目</h3>
            <div class="dialog-btn-row" style="margin-bottom:15px;">
                <button class="dialog-btn btn-confirm" onclick="triggerLocalFile()">本地相册</button>
                <button class="dialog-btn btn-secondary" style="background:#333; color:white;" onclick="toggleUrlInput()">URL链接</button>
            </div>
            <input type="text" id="upload-url" class="dialog-input" placeholder="输入图片链接..." style="display:none;">
            <div class="dialog-btn-row">
                <button class="dialog-btn btn-cancel" onclick="closeDialog('dialog-upload')">关闭</button>
                <button class="dialog-btn btn-confirm" id="btn-save-url" style="display:none;" onclick="saveUrlUpload()">保存链接</button>
            </div>
        </div>
    </div>

    <!-- === 聊天设置 === -->
    <div class="fs-modal" id="modal-settings">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal('modal-settings')"></i>
            聊天设置
        </div>
        <div class="fs-content">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:10px;">上下文记忆条数 (<span id="ctx-val">20</span>)</label>
                <input type="range" min="20" max="500" value="20" style="width:100%;" oninput="saveSettings(this.value)">
                <div style="font-size:12px; color:#666; margin-top:5px;">当前仅模拟数值存储</div>
            </div>
        </div>
    </div>

    <!-- === 长按菜单 === -->
    <div class="context-popup" id="ctx-menu">
        <div class="ctx-item" onclick="handleCtx('edit')">编辑内容</div>
        <div class="ctx-item" onclick="handleCtx('refresh')">刷新回复</div>
        <div class="ctx-item" style="color:var(--danger);" onclick="handleCtx('delete')">删除这条</div>
    </div>

    <!-- 隐形文件输入 -->
    <input type="file" id="file-picker" class="hidden-file" accept="image/*">

    <script>
        // === 全局状态 ===
        let currentUploadType = ''; // 'bg' or 'sticker'
        let autoReplyTimer = null;
        let memories = JSON.parse(localStorage.getItem('ai_memories') || '[]');
        let stickers = JSON.parse(localStorage.getItem('custom_stickers') || '[]');
        let targetBubble = null; // 长按操作的目标

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            // 加载名字
            document.getElementById('partner-name').innerText = localStorage.getItem('current_chat_partner') || "AI 伴侣";
            // 加载背景
            const bg = localStorage.getItem('chat_bg');
            if(bg) document.body.style.backgroundImage = `url('${bg}')`;
            // 加载设置
            document.getElementById('ctx-val').innerText = localStorage.getItem('chat_limit') || 20;
            // 渲染贴图
            renderStickers();
            // 不发送任何默认消息
        });

        // === 1. 发送消息与多条回复逻辑 ===
        const input = document.getElementById('msg-input');
        const chatBox = document.getElementById('chat-box');
        const typing = document.getElementById('typing-bubble');

        function sendMsg() {
            const txt = input.value.trim();
            if(!txt) return;
            addBubble('me', txt);
            input.value = '';
            input.focus(); // 关键：保持键盘不收起
            scrollToBottom();
        }

        function triggerAI() {
            // 点击麦克风，模拟 AI 开始回复
            typing.style.display = 'flex';
            scrollToBottom();
            
            setTimeout(() => {
                // 模拟长文本
                const fullResponse = "好的，我听到你了！这真是有趣的话题。我觉得我们可以深入探讨一下...不过，你确定不先休息一下吗？";
                streamResponse(fullResponse);
            }, 1000);
        }

        function streamResponse(text) {
            typing.style.display = 'none';
            
            // 拆分句子，去掉句号，模拟短信风格
            // 正则拆分：逗号、句号、问号、叹号
            const parts = text.split(/[,，。？！?!]/).filter(t => t.trim() !== "");
            
            let delay = 0;
            parts.forEach((part) => {
                // 模拟打字间隔
                setTimeout(() => {
                    // 显示 "正在输入" 瞬间
                    typing.style.display = 'flex';
                    scrollToBottom();
                    
                    setTimeout(() => {
                        typing.style.display = 'none';
                        const bubble = addBubble('ai', part);
                        // 绑定长按
                        bindLongPress(bubble);
                    }, 400); // 这里的400是每句话的“打字时间”
                }, delay);
                
                delay += (part.length * 100) + 600; 
            });
        }

        function addBubble(role, html, isImg=false) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            
            const b = document.createElement('div');
            b.className = 'bubble';
            if(isImg) {
                b.style.background = 'transparent';
                b.style.padding = 0;
                b.innerHTML = `<img src="${html}" class="sticker-img">`;
            } else {
                b.innerText = html;
            }
            
            row.appendChild(b);
            chatBox.insertBefore(row, typing);
            scrollToBottom();
            return b; // 返回气泡DOM供绑定事件
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // === 2. 贴图系统 (带添加功能) ===
        function toggleEmoji() {
            document.getElementById('emoji-drawer').classList.toggle('open');
        }

        function renderStickers() {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            
            // 添加按钮 (第一个)
            const addBtn = document.createElement('div');
            addBtn.className = 'add-sticker';
            addBtn.innerHTML = '+';
            addBtn.onclick = () => openUploadDialog('sticker');
            grid.appendChild(addBtn);

            // 渲染已有
            stickers.forEach(url => {
                const img = document.createElement('img');
                img.className = 'sticker-item';
                img.src = url;
                img.onclick = () => addBubble('me', url, true);
                grid.appendChild(img);
            });
        }

        // === 3. 上传系统 (本地 + URL) ===
        function openUploadDialog(type) {
            currentUploadType = type;
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('upload-title').innerText = type === 'bg' ? "设置聊天背景" : "添加表情包";
            document.getElementById('dialog-upload').style.display = 'flex';
            // 重置状态
            document.getElementById('upload-url').style.display = 'none';
            document.getElementById('btn-save-url').style.display = 'none';
        }

        function toggleUrlInput() {
            const el = document.getElementById('upload-url');
            const btn = document.getElementById('btn-save-url');
            if(el.style.display === 'none') {
                el.style.display = 'block';
          
