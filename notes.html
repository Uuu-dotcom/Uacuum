<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 1. å¼ºåˆ¶ç¦æ­¢ç¼©æ”¾ï¼Œé€‚é…åˆ˜æµ·å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- 2. iOS Safari ä¸“ç”¨å…¨å±è®¾ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Uacuum Phone">
    
    <!-- 3. Android Chrome ä¸“ç”¨å…¨å±è®¾ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2a2a2a">
    
    <!-- 4. å¼•å…¥ Manifest æ–‡ä»¶ -->
    <link rel="manifest" href="manifest.json">
    
    <!-- å›¾æ ‡è®¾ç½® -->
    <link rel="apple-touch-icon" href="app-icon.png">
    <link rel="icon" type="image/png" href="app-icon.png">
    
    <title>notes - Uacuum</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* ç¦æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ */
            -webkit-user-select: none;
            user-select: none;
            /* ç¦æ­¢ç‚¹å‡»é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            height: 100dvh; /* é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€é«˜åº¦ */
            background: #2a2a2a;
            overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ */
            
            /* é˜²æ­¢ iOS ä¸‹æ‹‰å›å¼¹ */
            overscroll-behavior: none;
            
            /* é€‚é…åˆ˜æµ·å±å®‰å…¨åŒºåŸŸ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .phone-container {
            /* ä¿®æ”¹å±å¹•å®½åº¦ï¼Œç•™å‡ºä¸€ç‚¹ä¸Šä¸‹è¾¹è· */
            width: 98vw; 
            max-width: 520px;
            
            /* ä¿®æ”¹ï¼šé«˜åº¦é€‚é…ï¼Œç•™å‡ºä¸€ç‚¹ä¸Šä¸‹è¾¹è· */
            height: 100%;
            max-height: 95dvh;
            
            background: #1a1a1a;
            border: 6px solid #000;
            border-radius: 20px;
            box-shadow: 
                0 0 0 3px #444,
                0 15px 30px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            padding: 15px;
            position: relative;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 3px solid #444;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .back-button {
            background: #fff;
            border: 3px solid #000;
            padding: 8px 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
        }

        .back-button:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #000;
        }

        .page-title {
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .action-btn {
            width: 40px; /* å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ */
            visibility: hidden;
        }

        .content {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            overflow-y: auto; /* åªæœ‰è¿™é‡Œå¯ä»¥æ»šåŠ¨ */
            padding-right: 5px;
            position: relative;
            /* ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒ */
            -webkit-overflow-scrolling: touch;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .content::-webkit-scrollbar { width: 6px; }
        .content::-webkit-scrollbar-track { background: #000; border: 1px solid #444; }
        .content::-webkit-scrollbar-thumb { background: #fff; border: 1px solid #000; }

        /* --- è§’è‰²é€‰æ‹©åˆ—è¡¨ --- */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /*ç¨å¾®è°ƒå°æœ€å°å®½åº¦ä»¥é€‚é…å°å±*/
            gap: 15px;
            padding: 10px 0;
        }

        .char-card {
            background: #fff;
            border: 3px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            transition: transform 0.1s;
        }

        .char-card:active {
            transform: translate(3px, 3px);
            box-shadow: 0 0 0 #000;
        }

        .char-avatar {
            width: 50px;
            height: 50px;
            border: 2px solid #000;
            margin-bottom: 8px;
            object-fit: cover;
            image-rendering: pixelated;
            background: #ddd;
        }

        .char-name {
            font-size: 8px;
            text-align: center;
            line-height: 1.2;
            word-break: break-all;
        }

        /* --- è®°å¿†æ—¶é—´è½´è§†å›¾ --- */
        .memory-view {
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tool-btn {
            background: #ffe66d;
            border: 3px solid #000;
            padding: 10px 5px;
            font-family: inherit;
            font-size: 7px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            text-align: center;
        }
        
        .tool-btn.batch { background: #a8e6cf; }
        
        .tool-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #000;
        }

        .timeline-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 20px;
        }

        .year-header {
            font-size: 10px;
            color: #fff;
            background: #000;
            padding: 5px 10px;
            display: inline-block;
            margin-bottom: 5px;
            border-radius: 4px;
            align-self: flex-start;
        }

        .month-header {
            font-size: 9px;
            color: #fff; /* æ”¹ä¸ºç™½è‰²ä»¥ä¾¿åœ¨é»‘èƒŒæ™¯ä¸‹å¯è§ï¼Œæˆ–è€…ä¿æŒé»‘è‰² */
            text-shadow: 1px 1px 0 #000; /* åŠ ä¸ªæè¾¹ */
            margin: 5px 0 5px 10px;
            font-weight: bold;
            text-decoration: underline;
        }

        .memory-card {
            background: #fff; /* ç¬”è®°æœ¬çº¸å¼ è‰² */
            border: 2px solid #000;
            padding: 10px;
            margin-left: 5px;
            margin-bottom: 10px;
            position: relative;
            box-shadow: 2px 2px 0 #666;
            border-left: 6px solid #4ecdc4; /* è£…é¥°çº¿ */
        }

        .memory-date {
            font-size: 6px;
            color: #666;
            margin-bottom: 5px;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 3px;
        }

        .memory-content {
            font-size: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-family: "SimSun", "Songti SC", serif; /* çœ‹èµ·æ¥åƒç¬”è®°å­—ä½“ */
            font-weight: bold;
            /* å…è®¸ç”¨æˆ·é€‰æ‹©å¤åˆ¶è®°å¿†å†…å®¹ */
            -webkit-user-select: text;
            user-select: text;
        }

        .memory-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 8px;
            padding-top: 5px;
            border-top: 1px solid #eee;
        }

        .mini-btn {
            font-size: 6px;
            padding: 4px 6px;
            background: #eee;
            border: 1px solid #000;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
        }
        
        .mini-btn.del { background: #ff6b6b; color: #fff; }
        .mini-btn.edit { background: #fff; }

        /* ç¼–è¾‘å¼¹çª— */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-box {
            background: #fff;
            border: 4px solid #000;
            padding: 15px;
            width: 100%;
            box-shadow: 5px 5px 0 #444;
        }

        .modal-title { font-size: 8px; margin-bottom: 10px; text-align: center; }
        
        .modal-input {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
            padding: 8px;
            font-size: 8px;
            border: 2px solid #000;
            font-family: inherit;
            resize: none;
            /* å…è®¸è¾“å…¥æ¡†æ“ä½œ */
            -webkit-user-select: text;
            user-select: text;
        }
        
        .modal-input:focus {
            outline: none;
            background: #f0f0f0;
        }

        /* Loadingé®ç½© */
        .loading-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            color: #fff;
            z-index: 200;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 8px;
            line-height: 2;
        }

        /* é¢œè‰²æ–¹æ¡ˆ */
        .color-scheme-1 { background: #ff6b9d; }
        .color-scheme-2 { background: #4ecdc4; }
        .color-scheme-3 { background: #ffe66d; }
        .color-scheme-4 { background: #a8e6cf; }
        .color-scheme-5 { background: #ffd3b6; }
        .color-scheme-6 { background: #c7ceea; }
    </style>
</head>
<body>
    <div class="phone-container" id="phoneContainer">
        
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <button class="back-button" id="backBtn">â† è¿”å›</button>
            <div class="page-title" id="pageTitle">ç¬”è®°æœ¬</div>
            <div class="action-btn"></div>
        </div>

        <div class="content">
            <!-- è§†å›¾1: è§’è‰²åˆ—è¡¨ -->
            <div id="charListView" class="char-grid"></div>

            <!-- è§†å›¾2: è®°å¿†æ—¶é—´è½´ -->
            <div id="memoryView" class="memory-view">
                <div class="toolbar">
                    <button class="tool-btn" id="summaryBtn">âœ¨ è®°å¿†æ€»ç»“</button>
                    <button class="tool-btn batch" id="batchBtn">ğŸ“š æ‰¹é‡æ€»ç»“</button>
                </div>
                
                <div id="timelineContainer" class="timeline-container">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
                </div>
                
                <div style="text-align:center; padding: 20px; font-size: 6px; color:#aaa;" id="emptyMemTip">
                    æš‚æ— è®°å¿†ï¼Œå»èŠå¤©æˆ–æ‰‹åŠ¨è®°å½•å§
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ¡† Modal -->
        <div class="modal-overlay" id="editModal">
            <div class="modal-box">
                <div class="modal-title" id="modalTitle">ç¼–è¾‘è®°å¿†</div>
                <input type="hidden" id="editMemId">
                <textarea class="modal-input" id="editMemContent"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="tool-btn" style="flex:1; background:#ddd;" id="cancelEdit">å–æ¶ˆ</button>
                    <button class="tool-btn" style="flex:1; background:#4ecdc4;" id="saveEdit">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡æ€»ç»“é…ç½® Modal -->
        <div class="modal-overlay" id="batchModal">
            <div class="modal-box">
                <div class="modal-title">æ‰¹é‡æ€»ç»“è®¾ç½®</div>
                <div style="font-size:6px; margin-bottom:5px;">æŒ‡å®šéœ€è¦ç²¾ç®€çš„è®°å¿†èŒƒå›´:</div>
                <input type="date" id="batchStart" class="modal-input" style="height:30px; margin-bottom:5px;">
                <input type="date" id="batchEnd" class="modal-input" style="height:30px;">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="tool-btn" style="flex:1; background:#ddd;" id="cancelBatch">å–æ¶ˆ</button>
                    <button class="tool-btn" style="flex:1; background:#a8e6cf;" id="runBatch">å¼€å§‹å¤„ç†</button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading-overlay" id="loadingOverlay">
            AI æ­£åœ¨æ•´ç†å›å¿†...<br>è¯·ç¨å€™...   
        </div>

    </div>

    <script>
        // --- ç³»ç»Ÿ Prompt é…ç½® ---
        const SYSTEM_PROMPT = `<æ€»ç»“è§„åˆ™>
ç¦æ­¢ç§è‡ªç¼–é€ ä¸å­˜åœ¨çš„å†…å®¹!
ç¦æ­¢ç§è‡ªç¼–é€ ä¸å­˜åœ¨çš„å†…å®¹!
ç¦æ­¢ç§è‡ªç¼–é€ ä¸å­˜åœ¨çš„å†…å®¹!
å¦‚æœé‡åˆ°å¤æ‚çš„è¯·å¦‚å®ç›´è¿°ï¼Œç¦æ­¢å»ç¼–é€ ã€æ”¹åŠ¨!
## ã€ç³»ç»Ÿæ€»ç»“æœ€é«˜åè®®ã€‘ï¼šè¿›è¡Œsummaryæ—¶ï¼Œç»å¯¹å¿…é¡»æ­£ç¡®æŒ‰ç…§<æ€»ç»“è§„åˆ™>ç”Ÿæˆï¼ï¼ï¼

**ã€å†…å®¹æ ¸å¿ƒ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ çš„summaryã€å¿…é¡»ã€‘ä¸“æ³¨äºä»¥ä¸‹å‡ ç‚¹ï¼Œè¯·ç›´æ¥è¾“å‡º(ä¸éœ€è¦å›ç­”æˆ‘å¥½çš„ï¼‰ï¼š

æ€»ç»“è§„åˆ™ï¼š
è¿›è¡Œsummaryæ—¶ï¼Œå¿…é¡»ç²¾å‡†æå–å†…å®¹ï¼Œä¸é—æ¼ä»»ä½•é”šç‚¹çš„é‡è¦ç»†èŠ‚ï¼Œå®Œç¾åˆ¤æ–­{{char}}å’Œ{{user}}çš„å…³ç³»å‘å±•ï¼Œå¿…é¡»ç›´ç™½ä¸”å¦‚å®æ€»ç»“æ—¶é—´èŠ‚ç‚¹å’Œæ•…äº‹å‘å±•ï¼Œæ¯ä»¶äº‹çš„å™è¿°æ§åˆ¶åœ¨æœ€å¤š80å­—å·¦å³ï¼Œæ­¤å¤–å†åŒ…å«é‡è¦æ—¥æœŸ+æ—¶é—´èŠ‚ç‚¹å³å¯ã€‚

charçš„é•¿æœŸè®°å¿†summaryæ ¼å¼ä¸ºï¼š
å½“å‰å¹´ä»½æ—¥æœŸæ˜ŸæœŸæ—¶é—´/å…·ä½“åœ°ç‚¹ï¼Œ{{char}}çš„ç¬¬ä¸€äººç§°æ€»ç»“ä¸{{user}}å‘ç”Ÿçš„äº‹ä»¶ï¼Œç¦æ­¢å¤ªè¿‡äºä¸»è§‚!

## ç¤ºä¾‹ï¼šâ€œçº¿ä¸Š(çº¿ä¸‹ï¼‰/2025å¹´4æœˆ2æ—¥8:30ï¼Œæ˜ŸæœŸä¸‰ï¼Œæˆ‘å’ŒuserèŠäº†å…³äºæ—©é¤çš„è¯é¢˜ã€‚â€

## ç²¾ç‚¼è®°å¿†æ—¶ç¦æ­¢å·æ‡’è¾“å‡ºtoken countï¼Œå¿…é¡»è¿›è¡Œæ­£ç¡®çš„ç²¾ç‚¼

##å›¾ç‰‡ç¦æ­¢æ€»ç»“ä¸ºâ€œå‘äº†ä¸€å¼ å›¾ç‰‡/ä¸ªäººç…§ç‰‡â€ï¼Œå¿…é¡»è¯´æ˜æ˜¯ä»€ä¹ˆå›¾ç‰‡ï¼Œå¦‚æœåªæ˜¯è¡¨æƒ…åŒ…åˆ™ç¦æ­¢æ€»ç»“åœ¨å…¶ä¸­!!
</æ€»ç»“è§„åˆ™>`;

        // --- DOM å…ƒç´  ---
        const phoneContainer = document.getElementById('phoneContainer');
        const charListView = document.getElementById('charListView');
        const memoryView = document.getElementById('memoryView');
        const timelineContainer = document.getElementById('timelineContainer');
        const pageTitle = document.getElementById('pageTitle');
        const backBtn = document.getElementById('backBtn');
        const emptyMemTip = document.getElementById('emptyMemTip');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Modals
        const editModal = document.getElementById('editModal');
        const batchModal = document.getElementById('batchModal');

        // çŠ¶æ€
        let currentContactId = null;

        // é…è‰²æ–¹æ¡ˆ
        const colorSchemes = ['color-scheme-1', 'color-scheme-2', 'color-scheme-3', 'color-scheme-4', 'color-scheme-5', 'color-scheme-6'];

        // --- åˆå§‹åŒ– ---
        window.addEventListener('DOMContentLoaded', () => {
            const savedColor = localStorage.getItem('phoneColor');
            if (savedColor !== null) {
                phoneContainer.className = 'phone-container ' + colorSchemes[parseInt(savedColor)];
            }
            showCharList();
        });

        // --- è§†å›¾åˆ‡æ¢é€»è¾‘ ---

        function showCharList() {
            currentContactId = null;
            charListView.style.display = 'grid';
            memoryView.style.display = 'none';
            pageTitle.textContent = 'ç¬”è®°æœ¬';
            backBtn.textContent = 'â† è¿”å›';
            
            backBtn.onclick = () => window.location.href = './index.html';

            renderCharList();
        }

        function showMemoryTimeline(contactId, contactName) {
            currentContactId = contactId;
            charListView.style.display = 'none';
            memoryView.style.display = 'flex';
            pageTitle.textContent = contactName;
            backBtn.textContent = 'â† ç”¨æˆ·';
            
            backBtn.onclick = showCharList;

            renderTimeline();
        }

        // --- æ¸²æŸ“é€»è¾‘ ---

        function renderCharList() {
            const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            charListView.innerHTML = '';

            if (contacts.length === 0) {
                charListView.innerHTML = '<div style="grid-column:1/-1; text-align:center; font-size:8px; color:#fff; padding:20px;">é€šè®¯å½•ä¸ºç©º<br>è¯·å…ˆæ·»åŠ è”ç»œäºº</div>';
                return;
            }

            contacts.forEach(c => {
                const card = document.createElement('div');
                card.className = 'char-card';
                card.onclick = () => showMemoryTimeline(c.id, c.nick || c.name);

                const avatarSrc = c.avatar || 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><rect fill=\'%23ccc\' width=\'16\' height=\'16\'/></svg>';

                card.innerHTML = `
                    <img src="${avatarSrc}" class="char-avatar">
                    <div class="char-name">${c.nick || c.name}</div>
                `;
                charListView.appendChild(card);
            });
        }

        function renderTimeline() {
            const memories = JSON.parse(localStorage.getItem('memories') || '{}');
            const charMemories = memories[currentContactId] || [];
            
            timelineContainer.innerHTML = '';

            if (charMemories.length === 0) {
                emptyMemTip.style.display = 'block';
                return;
            } else {
                emptyMemTip.style.display = 'none';
            }

            // æŒ‰æ—¶é—´å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            charMemories.sort((a, b) => b.timestamp - a.timestamp);

            let lastYear = null;
            let lastMonth = null;

            charMemories.forEach(mem => {
                const dateObj = new Date(mem.timestamp);
                const year = dateObj.getFullYear();
                const month = dateObj.getMonth() + 1;

                // æ’å…¥å¹´ä»½å¤´
                if (year !== lastYear) {
                    const yearHeader = document.createElement('div');
                    yearHeader.className = 'year-header';
                    yearHeader.textContent = `${year}å¹´`;
                    timelineContainer.appendChild(yearHeader);
                    lastYear = year;
                    lastMonth = null; 
                }

                // æ’å…¥æœˆä»½å¤´
                if (month !== lastMonth) {
                    const monthHeader = document.createElement('div');
                    monthHeader.className = 'month-header';
                    monthHeader.textContent = `${month}æœˆ`;
                    timelineContainer.appendChild(monthHeader);
                    lastMonth = month;
                }

                // è®°å¿†å¡ç‰‡
                const div = document.createElement('div');
                div.className = 'memory-card';
                div.innerHTML = `
                    <div class="memory-date">${mem.dateStr || dateObj.toLocaleString()}</div>
                    <div class="memory-content">${escapeHtml(mem.content)}</div>
                    <div class="memory-actions">
                        <button class="mini-btn edit" onclick="openEdit(${mem.id})">ç¼–è¾‘</button>
                        <button class="mini-btn del" onclick="deleteMemory(${mem.id})">åˆ é™¤</button>
                    </div>
                `;
                timelineContainer.appendChild(div);
            });
        }

        // --- å¢åˆ æ”¹é€»è¾‘ ---

        // å­˜å‚¨
        function saveMemoryToStorage(content, timestamp, isUpdateId = null) {
            const memories = JSON.parse(localStorage.getItem('memories') || '{}');
            if (!memories[currentContactId]) memories[currentContactId] = [];

            if (isUpdateId) {
                // æ›´æ–°
                const idx = memories[currentContactId].findIndex(m => m.id === isUpdateId);
                if (idx !== -1) {
                    memories[currentContactId][idx].content = content;
                }
            } else {
                // æ–°å¢
                const dateObj = new Date(timestamp);
                memories[currentContactId].push({
                    id: Date.now(),
                    timestamp: timestamp,
                    dateStr: dateObj.toLocaleString(),
                    content: content
                });
            }
            
            localStorage.setItem('memories', JSON.stringify(memories));
            renderTimeline();
        }

        window.deleteMemory = function(id) {
            if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ')) return;
            const memories = JSON.parse(localStorage.getItem('memories') || '{}');
            if (memories[currentContactId]) {
                memories[currentContactId] = memories[currentContactId].filter(m => m.id !== id);
                localStorage.setItem('memories', JSON.stringify(memories));
                renderTimeline();
            }
        };

        // ç¼–è¾‘å¼¹çª—
        window.openEdit = function(id) {
            const memories = JSON.parse(localStorage.getItem('memories') || '{}');
            const list = memories[currentContactId] || [];
            const mem = list.find(m => m.id === id);
            if (mem) {
                document.getElementById('editMemId').value = id;
                document.getElementById('editMemContent').value = mem.content;
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è®°å¿†';
                editModal.style.display = 'flex';
            }
        };

        document.getElementById('cancelEdit').onclick = () => editModal.style.display = 'none';
        
        document.getElementById('saveEdit').onclick = () => {
            const id = parseInt(document.getElementById('editMemId').value);
            const content = document.getElementById('editMemContent').value;
            if (content.trim()) {
                saveMemoryToStorage(content, null, id);
                editModal.style.display = 'none';
            }
        };

        // --- AI æ€»ç»“åŠŸèƒ½ ---

        // 1. è®°å¿†æ€»ç»“ (é’ˆå¯¹è¿‘æœŸèŠå¤©)
        document.getElementById('summaryBtn').onclick = async () => {
            if (!checkApiConfig()) return;

            const allChats = JSON.parse(localStorage.getItem('chats') || '{}');
            const thisChat = allChats[currentContactId] || [];

            if (thisChat.length === 0) {
                alert('è¯¥è§’è‰²æ²¡æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“ã€‚');
                return;
            }

            const recentChats = thisChat.slice(-20); 
            const chatText = recentChats.map(c => `${c.role}: ${c.content}`).join('\n');

            loadingOverlay.style.display = 'flex';
            
            try {
                const summary = await callAiApi(chatText, "normal");
                saveMemoryToStorage(summary, Date.now());
                alert('è®°å¿†æ€»ç»“æˆåŠŸï¼å·²æ·»åŠ è‡³ç¬”è®°æœ¬ã€‚');
            } catch (err) {
                alert('ç”Ÿæˆå¤±è´¥: ' + err.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };

        // 2. æ‰¹é‡æ€»ç»“
        document.getElementById('batchBtn').onclick = () => {
            batchModal.style.display = 'flex';
        };

        document.getElementById('cancelBatch').onclick = () => batchModal.style.display = 'none';

        document.getElementById('runBatch').onclick = async () => {
            const start = document.getElementById('batchStart').value;
            const end = document.getElementById('batchEnd').value;
            
            if (!start || !end) {
                alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                return;
            }
            
            batchModal.style.display = 'none';
            if (!checkApiConfig()) return;

            loadingOverlay.style.display = 'flex';

            const memories = JSON.parse(localStorage.getItem('memories') || '{}');
            const list = memories[currentContactId] || [];
            
            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime() + 86400000;

            const targetMemories = list.filter(m => m.timestamp >= startDate && m.timestamp < endDate);

            if (targetMemories.length === 0) {
                loadingOverlay.style.display = 'none';
                alert('è¯¥æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰å¯æ€»ç»“çš„è®°å¿†ã€‚');
                return;
            }

            const memoryText = targetMemories.map(m => `[${m.dateStr}] ${m.content}`).join('\n\n');

            try {
                const summary = await callAiApi(memoryText, "batch");
                
                if (confirm('AI æ€»ç»“å®Œæˆï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n\n' + summary.substring(0, 100) + '...\n\næ˜¯å¦ä¿å­˜ä¸ºæ–°çš„ä¸€æ¡ç²¾ç®€è®°å¿†ï¼Ÿ(è¿™å°†ä¿ç•™åŸå§‹è®°å¿†)')) {
                     saveMemoryToStorage(summary, Date.now());
                }
            } catch (err) {
                alert('æ‰¹é‡æ€»ç»“å¤±è´¥: ' + err.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };

        // --- API è°ƒç”¨æ¨¡æ‹Ÿ ---
                async function callAiApi(inputText, type) {
            const apiUrl = localStorage.getItem('apiUrl');
            const apiKey = localStorage.getItem('apiKey');
            const model = localStorage.getItem('selectedModel');

            if (!apiUrl || !apiKey) throw new Error("ç¼ºå°‘é…ç½®");

            const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            const currentContact = contacts.find(c => c.id === currentContactId);
            const charName = currentContact ? currentContact.name : "Character";

            let finalSystemPrompt = SYSTEM_PROMPT
                .replace(/{{char}}/g, charName)
                .replace(/{{user}}/g, "User");

            // --- æ–°å¢ï¼šè¯»å– User è®¾å®šå¹¶æ³¨å…¥ Prompt ---
            const userPersona = localStorage.getItem('user_persona');
            if (userPersona && userPersona.trim() !== "") {
                finalSystemPrompt += `\n\n[User Info / User Persona]:\n${userPersona}\n`;
            }
            // ---------------------------------------

            let userPromptContent = "";
            if (type === 'normal') {
                userPromptContent = `è¯·æ ¹æ®ä»¥ä¸‹æœ€è¿‘çš„èŠå¤©è®°å½•ç”Ÿæˆæ€»ç»“ï¼š\n\n${inputText}`;
            } else {
                userPromptContent = `è¯·æ ¹æ®ä»¥ä¸‹å¤šä¸ªæ—¥æœŸçš„è®°å¿†ç‰‡æ®µï¼Œè¿›è¡Œæ‰¹é‡ç²¾ç®€æ€»ç»“ï¼Œå»é™¤é‡å¤ä¿¡æ¯ï¼š\n\n${inputText}`;
            }

            let fullUrl = apiUrl;
            if (!apiUrl.includes('/chat/completions')) {
                fullUrl = apiUrl.replace(/\/$/, '') + '/chat/completions';
            }

            const response = await fetch(fullUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: finalSystemPrompt },
                        { role: "user", content: userPromptContent }
                    ],
                    temperature: parseFloat(localStorage.getItem('temperature') || 0.9)
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || 'API è¯·æ±‚é”™è¯¯');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }


        function checkApiConfig() {
            const apiUrl = localStorage.getItem('apiUrl');
            const apiKey = localStorage.getItem('apiKey');
            if (!apiUrl || !apiKey) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API URL å’Œ Keyï¼');
                return false;
            }
            return true;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
